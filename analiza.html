<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A random trader</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1a2840 50%, #0d1b2a 100%);
            background-attachment: fixed;
            color: #f1f5f9;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            padding: 0 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(25, 118, 210, 0.05));
            border-radius: 20px;
            border: 1px solid rgba(33, 150, 243, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.8em;
            background: linear-gradient(135deg, #2196F3, #64B5F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #90CAF9;
            font-size: 1.1em;
            font-weight: 500;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: #fff;
            border: none;
            padding: 14px 35px;
            margin: 0;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            letter-spacing: 0.3px;
        }

        .nav-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px rgba(33, 150, 243, 0.6),
                        0 0 20px rgba(33, 150, 243, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #64B5F6, #2196F3);
            color: #fff;
            box-shadow: 0 4px 20px rgba(100, 181, 246, 0.5),
                        0 0 30px rgba(33, 150, 243, 0.3);
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #2196F3;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
        }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2196F3;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        select option {
            background: #1a1a1a;
            color: #fff;
        }

        textarea {
            resize: vertical;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .save-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: #fff;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        .table-container {
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 15px;
            padding: 20px;
            max-width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        thead {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.2));
        }

        th {
            padding: 12px 8px;
            text-align: left;
            color: #2196F3;
            font-weight: 600;
            border-bottom: 2px solid #2196F3;
            white-space: nowrap;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ddd;
            font-size: 0.9em;
        }

        tr:hover {
            background: rgba(33, 150, 243, 0.05);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 1.1em;
        }

        .edit-btn, .delete-btn {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            border: none;
            color: #fff;
            margin-right: 5px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #4488ff, #0066cc);
        }

        .delete-btn {
            background: linear-gradient(135deg, #ff4444, #cc0000);
        }

        .edit-btn:hover, .delete-btn:hover {
            transform: scale(1.05);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 5px solid rgba(33, 150, 243, 0.2);
            border-top: 5px solid #2196F3;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-section {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .filter-section {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.08), rgba(25, 118, 210, 0.03));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.25);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .pair-filter-btn {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1));
            border: 2px solid rgba(33, 150, 243, 0.4);
            color: #2196F3;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .pair-filter-btn:hover {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(25, 118, 210, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .pair-filter-btn.active {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-color: #2196F3;
            color: #fff;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
        }

        #pairButtonsContainer::-webkit-scrollbar {
            height: 8px;
        }

        #pairButtonsContainer::-webkit-scrollbar-track {
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
        }

        #pairButtonsContainer::-webkit-scrollbar-thumb {
            background: #2196F3;
            border-radius: 10px;
        }

        #pairButtonsContainer::-webkit-scrollbar-thumb:hover {
            background: #1976D2;
        }

        #pairButtonsContainer.grabbing {
            cursor: grabbing;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 100px;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: rgba(33, 150, 243, 0.1);
            border-color: #2196F3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .calendar-day.has-analysis {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1));
            border-color: #2196F3;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-color: #2196F3;
            color: #fff;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            pointer-events: none;
        }

        .calendar-day-number {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(33, 150, 243, 0.3);
        }

        .calendar-day.selected .calendar-day-number {
            border-bottom-color: rgba(255, 255, 255, 0.5);
        }

        .calendar-day-pairs {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 0.75em;
            margin-top: 5px;
            overflow-y: auto;
            max-height: 60px;
        }

        .calendar-day-pairs::-webkit-scrollbar {
            width: 3px;
        }

        .calendar-day-pairs::-webkit-scrollbar-thumb {
            background: #2196F3;
            border-radius: 3px;
        }

        .calendar-pair-bullet {
            color: #2196F3;
            padding: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-day.selected .calendar-pair-bullet {
            color: #fff;
        }

        .calendar-header {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #2196F3;
            font-size: 0.9em;
        }

        .view-mode-btn.active {
            background: linear-gradient(135deg, #2196F3, #1976D2) !important;
            color: #fff !important;
            border-color: #2196F3 !important;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div style="font-size: 4em; line-height: 1;">üìä</div>
                <div style="text-align: center;">
                    <h1>A random trader</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.1em; color: #90CAF9; font-weight: 500; font-style: italic;">Market analysis made easy</p>
                </div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" id="btnList">Analysis History</button>
            <button class="nav-btn" id="btnForm" style="display: none;">Add Analysis</button>
            <button class="nav-btn" id="btnLogin" style="background: linear-gradient(135deg, #00cc88, #00aa72);">üîê Login</button>
            <button class="nav-btn" id="btnLogout" style="display: none; background: linear-gradient(135deg, #ff6b6b, #ee5a6f);">üö™ Logout</button>
        </div>

        <!-- Form Page -->
        <div id="formPage" class="page">
            <div class="form-container">
                <h2 style="margin-bottom: 25px; color: #2196F3;">üìä Add Market Analysis</h2>
                
                <!-- Basic Info -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="month">Month *</label>
                        <select id="month" required>
                            <option value="">Select</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="day">Day *</label>
                        <select id="day" required>
                            <option value="">Select</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date">Date *</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="year">Year *</label>
                        <select id="year" required>
                            <option value="">Select</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="pair">Pair *</label>
                        <select id="pair" onchange="handlePairChange()" required>
                            <option value="">Select</option>
                            <option value="EUR/USD">EUR/USD</option>
                            <option value="GBP/USD">GBP/USD</option>
                            <option value="XAU/USD">XAU/USD</option>
                            <option value="USD/JPY">USD/JPY</option>
                            <option value="US100">US100</option>
                            <option value="GER40">GER40</option>
                            <option value="Other">Other...</option>
                        </select>
                    </div>
                    <div class="form-group" id="customPairGroup" style="display: none;">
                        <label for="customPair">Enter Pair</label>
                        <input type="text" id="customPair" placeholder="ex: AUD/USD, BTC/USD">
                    </div>
                </div>

                <!-- Weekly Analysis -->
                <div class="analysis-section">
                    <h3>üìÖ Weekly Analysis</h3>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="weeklyAnalysis">Analysis</label>
                            <textarea id="weeklyAnalysis" rows="4" placeholder="Weekly market overview, key levels, bias..."></textarea>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="weeklyPhoto">Photo Link (Imgur, TradingView, etc.)</label>
                            <input type="url" id="weeklyPhoto" placeholder="https://i.imgur.com/...">
                        </div>
                    </div>
                </div>

                <!-- Daily Analysis -->
                <div class="analysis-section">
                    <h3>üìä Daily Analysis</h3>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="dailyAnalysis">Analysis</label>
                            <textarea id="dailyAnalysis" rows="4" placeholder="Daily zones, supply/demand, daily bias..."></textarea>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="dailyPhoto">Photo Link</label>
                            <input type="url" id="dailyPhoto" placeholder="https://i.imgur.com/...">
                        </div>
                    </div>
                </div>

                <!-- 4H Analysis -->
                <div class="analysis-section">
                    <h3>‚è±Ô∏è 4H Analysis</h3>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="fourHAnalysis">Analysis</label>
                            <textarea id="fourHAnalysis" rows="4" placeholder="4H structure, fractals, entry zones..."></textarea>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="fourHPhoto">Photo Link</label>
                            <input type="url" id="fourHPhoto" placeholder="https://i.imgur.com/...">
                        </div>
                    </div>
                </div>

                <!-- 1H Analysis -->
                <div class="analysis-section">
                    <h3>‚ö° 1H Analysis</h3>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="oneHAnalysis">Analysis</label>
                            <textarea id="oneHAnalysis" rows="4" placeholder="1H entries, liquidity sweeps, timing..."></textarea>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="oneHPhoto">Photo Link</label>
                            <input type="url" id="oneHPhoto" placeholder="https://i.imgur.com/...">
                        </div>
                    </div>
                </div>

                <button class="save-btn" id="saveBtn">üíæ Save Analysis</button>
            </div>
        </div>

        <!-- List Page -->
        <div id="listPage" class="page active">
            <!-- Filters -->
            <div class="filter-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #2196F3; margin: 0; font-size: 1.5em;">üîç Filters</h2>
                    <button onclick="resetFilters()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; border: none; padding: 12px 28px; border-radius: 25px; cursor: pointer; font-weight: 600;">üîÑ Reset</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="filterMonth">üìÖ Month</label>
                        <select id="filterMonth" onchange="applyFilters()">
                            <option value="">All months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterDay">üìÜ Day</label>
                        <select id="filterDay" onchange="applyFilters()">
                            <option value="">All days</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterDateFrom">üìÖ Date From</label>
                        <input type="date" id="filterDateFrom" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filterDateTo">üìÖ Date To</label>
                        <input type="date" id="filterDateTo" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filterYear">üìÖ Year</label>
                        <select id="filterYear" onchange="applyFilters()">
                            <option value="">All years</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterPair">üí± Pair</label>
                        <select id="filterPair" onchange="applyFilters()">
                            <option value="">All pairs</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Quick Pair Filters -->
            <div style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.08), rgba(25, 118, 210, 0.03)); backdrop-filter: blur(10px); border: 1px solid rgba(33, 150, 243, 0.25); border-radius: 20px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
                <h3 style="color: #2196F3; margin: 0 0 15px 0; font-size: 1.2em; display: flex; align-items: center; gap: 10px;">
                    <span>‚ö°</span> Quick Pair Filter
                </h3>
                <div id="pairButtonsContainer" style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; cursor: grab; user-select: none; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #2196F3 rgba(33, 150, 243, 0.1);">
                    <!-- Buttons will be inserted here -->
                </div>
            </div>

            <!-- View Mode Toggle -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px;">
                <button id="btnJournalView" class="view-mode-btn active" onclick="switchView('journal')" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);">
                    üìã Journal View
                </button>
                <button id="btnCalendarView" class="view-mode-btn" onclick="switchView('calendar')" style="background: rgba(33, 150, 243, 0.2); color: #2196F3; border: 2px solid rgba(33, 150, 243, 0.4); padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease;">
                    üìÖ Calendar View
                </button>
            </div>

            <!-- Journal View -->
            <!-- Journal View -->
            <div id="journalView" style="display: block;">
                <div class="table-container">
                    <h2 style="margin-bottom: 20px; color: #2196F3;">Analysis History</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Month</th>
                                <th>Day</th>
                                <th>Date</th>
                                <th>Pair</th>
                                <th>Analysis</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="analysisBody">
                            <tr>
                                <td colspan="7" class="no-data">Loading analyses...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" style="display: none;">
                <div style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(33, 150, 243, 0.2); border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative;">
                    
                    <!-- Calendar Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; flex-wrap: wrap; position: relative; z-index: 100;">
                        <button onclick="changeMonth(-1)" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateX(-3px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.5)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)';">
                            <span style="font-size: 1.2em;">‚óÑ</span> Previous
                        </button>
                        
                        <div style="display: flex; gap: 15px; align-items: center; background: rgba(33, 150, 243, 0.1); padding: 15px 25px; border-radius: 20px; border: 1px solid rgba(33, 150, 243, 0.3); backdrop-filter: blur(10px); flex-wrap: wrap; justify-content: center; position: relative; z-index: 150;">
                            <!-- Month Selector -->
                            <div style="position: relative;">
                                <button id="monthSelectorBtn" onclick="toggleMonthPicker()" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1)); border: 2px solid rgba(33, 150, 243, 0.4); color: #64B5F6; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; min-width: 140px;" onmouseover="this.style.borderColor='#2196F3'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(25, 118, 210, 0.2))';" onmouseout="this.style.borderColor='rgba(33, 150, 243, 0.4)'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1))';">
                                    <span id="selectedMonth">February</span> üìÖ
                                </button>
                                
                                <!-- Month Picker Popup -->
                                <div id="monthPicker" style="display: none; position: absolute; top: 60px; left: 0; background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); border: 2px solid rgba(33, 150, 243, 0.5); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 9999; backdrop-filter: blur(20px); min-width: 300px;">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                        <!-- Months will be inserted here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Year Selector -->
                            <div style="position: relative;">
                                <button id="yearSelectorBtn" onclick="toggleYearPicker()" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1)); border: 2px solid rgba(33, 150, 243, 0.4); color: #64B5F6; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; min-width: 120px;" onmouseover="this.style.borderColor='#2196F3'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(25, 118, 210, 0.2))';" onmouseout="this.style.borderColor='rgba(33, 150, 243, 0.4)'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1))';">
                                    <span id="selectedYear">2026</span> üìÜ
                                </button>
                                
                                <!-- Year Picker Popup -->
                                <div id="yearPicker" style="display: none; position: absolute; top: 60px; left: 0; background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); border: 2px solid rgba(33, 150, 243, 0.5); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 2000; backdrop-filter: blur(20px); min-width: 280px;">
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                        <!-- Years will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="changeMonth(1)" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateX(3px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.5)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)';">
                            Next <span style="font-size: 1.2em;">‚ñ∫</span>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; position: relative; z-index: 1;">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Analyses Modal -->
    <div class="loading-overlay" id="loginModal">
        <div style="background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 20px; max-width: 400px; width: 90%;">
            <h2 style="color: #2196F3; margin-bottom: 25px; text-align: center;">üîê Login</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; margin-bottom: 8px; font-weight: 600;">Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username" style="width: 100%; padding: 12px; border: 2px solid #2196F3; border-radius: 8px; color: #333;">
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display: block; color: #333; margin-bottom: 8px; font-weight: 600;">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid #2196F3; border-radius: 8px; color: #333;" onkeypress="if(event.key==='Enter') attemptLogin()">
            </div>
            <div id="loginError" style="color: #ff4444; margin-bottom: 15px; text-align: center; display: none;"></div>
            <div style="display: flex; gap: 10px;">
                <button onclick="attemptLogin()" style="flex: 1; background: linear-gradient(135deg, #00cc88, #00aa72); color: #fff; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">Login</button>
                <button onclick="closeLoginModal()" style="flex: 1; background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- View Analysis Modal -->
    <div class="loading-overlay" id="viewModal" style="display: none;">
        <div style="background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); padding: 50px; border-radius: 25px; max-width: 95vw; width: 95%; max-height: 95vh; overflow-y: auto; border: 2px solid rgba(33, 150, 243, 0.5); position: relative; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <!-- Back button (top-left) -->
            <button id="backToDayBtn" onclick="backToDayModal()" style="display: none; position: absolute; top: 20px; left: 20px; background: rgba(33, 150, 243, 0.2); color: #2196F3; border: 2px solid #2196F3; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.3em; font-weight: bold; transition: all 0.3s ease; z-index: 10;">‚óÑ</button>
            
            <!-- Close button (top-right) -->
            <button onclick="closeViewModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 2px solid #ff6b6b; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5em; font-weight: bold; transition: all 0.3s ease; z-index: 10;">√ó</button>
            
            <div style="margin-bottom: 30px; padding-right: 50px; padding-left: 50px;">
                <h2 id="viewModalTitle" style="color: #2196F3; margin: 0 0 20px 0; font-size: 2em; text-align: center;">Analysis</h2>
                
                <!-- Analysis Timeline Navigation -->
                <div id="analysisTimeline" style="display: none; margin-top: 20px; padding: 15px; background: rgba(33, 150, 243, 0.05); border-radius: 15px; border: 1px solid rgba(33, 150, 243, 0.2);">
                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <!-- Timeline buttons will be inserted here -->
                    </div>
                </div>
            </div>
            
            <div id="viewModalContent" style="color: #ddd; line-height: 1.8; font-size: 1.05em;">
                <!-- Content will be inserted here -->
            </div>

            <div style="margin-top: 30px; text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="printAnalysisFromModal()" style="background: linear-gradient(135deg, #00BCD4, #0097A7); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);">
                    üñ®Ô∏è Print to Word
                </button>
                <button onclick="copyForTradingViewFromModal()" style="background: linear-gradient(135deg, #2962FF, #1E53E5); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(41, 98, 255, 0.4);">
                    üìà Copy for TradingView
                </button>
                <button onclick="shareFromModal()" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);">
                    üìã Copy for Discord
                </button>
                <button onclick="sendToDiscordFromModal()" style="background: linear-gradient(135deg, #5865F2, #4752C4); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);">
                    üöÄ Send to Discord
                </button>
            </div>
        </div>
    </div>

    <!-- Day Analyses Modal -->
    <div class="loading-overlay" id="dayModal" style="display: none;">
        <div style="background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); padding: 50px; border-radius: 25px; max-width: 95vw; width: 95%; max-height: 95vh; overflow-y: auto; border: 2px solid rgba(33, 150, 243, 0.5); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 id="dayModalTitle" style="color: #2196F3; margin: 0; font-size: 2em;">üìÖ Day Analyses</h2>
                <button onclick="closeDayModal()" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 2px solid #ff6b6b; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5em; font-weight: bold; transition: all 0.3s ease;">√ó</button>
            </div>
            
            <div id="dayModalContent" style="display: grid; gap: 20px;">
                <!-- Analyses cards will be inserted here -->
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button onclick="closeDayModal()" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay active" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div style="color: #2196F3; font-size: 1.3em; font-weight: bold;">Loading...</div>
        </div>
    </div>

    <script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby545E0z1U_T4y7Obgp7jbkhjEM-nTQ14zccKu3_WhAWI93028iGy3JHPHk9XJvU1_5/exec';

// Discord Webhooks per Trading Pair
// Add webhooks for each pair you want to post to Discord
const DISCORD_WEBHOOKS = {
    'EUR/USD': 'https://discord.com/api/webhooks/1471496358472056842/3IOH_SQw6fNtSV3if_-soi2GrPiycjTUq7-Uk8oT91CSXv_uuRgfHlKwvep_iGwPF9Ej',
    'GBP/USD': '', // Add your GBP/USD webhook here
    'XAU/USD': '', // Add your XAU/USD webhook here
    'USD/JPY': '', // Add your USD/JPY webhook here
    'US100': '',   // Add your US100 webhook here
    'GER40': '',   // Add your GER40 webhook here
    // Add more pairs as needed
};

// Default webhook for pairs without dedicated channel
const DEFAULT_DISCORD_WEBHOOK = ''; // Optional: fallback webhook for unconfigured pairs

// Custom Avatar URL - Replace with your image URL
// Upload your image to: https://imgur.com/ or https://imgbb.com/ and paste the DIRECT image link here
const CUSTOM_AVATAR_URL = 'https://i.imgur.com/YOUR_IMAGE_ID.png'; // Replace with your uploaded image URL

const CREDENTIALS = {
    username: 'calexi07',
    password: '101994acs!'
};

let analyses = [];
let filteredAnalyses = [];
let editingIndex = -1;
let isLoggedIn = false;

// DOM
const formPage = document.getElementById('formPage');
const listPage = document.getElementById('listPage');
const btnForm = document.getElementById('btnForm');
const btnList = document.getElementById('btnList');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const saveBtn = document.getElementById('saveBtn');
const analysisBody = document.getElementById('analysisBody');
const loadingOverlay = document.getElementById('loadingOverlay');

// Show/Hide Loading
function showLoading() {
    loadingOverlay.classList.add('active');
}

function hideLoading() {
    loadingOverlay.classList.remove('active');
}

// Navigation
btnLogin.onclick = () => showLoginModal();
btnLogout.onclick = () => logout();
btnForm.onclick = () => showPage('form');
btnList.onclick = () => {
    showPage('list');
    loadAnalyses();
};

function handlePairChange() {
    const pairSelect = document.getElementById('pair');
    const customPairGroup = document.getElementById('customPairGroup');
    
    if (pairSelect.value === 'Other') {
        customPairGroup.style.display = 'block';
        document.getElementById('customPair').required = true;
    } else {
        customPairGroup.style.display = 'none';
        document.getElementById('customPair').required = false;
        document.getElementById('customPair').value = '';
    }
}

function showPage(page) {
    formPage.classList.toggle('active', page === 'form');
    listPage.classList.toggle('active', page === 'list');
    btnForm.classList.toggle('active', page === 'form');
    btnList.classList.toggle('active', page === 'list');
}

// Login System
function showLoginModal() {
    document.getElementById('loginModal').style.display = 'flex';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').style.display = 'none';
}

function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
}

function attemptLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    if (username === CREDENTIALS.username && password === CREDENTIALS.password) {
        isLoggedIn = true;
        localStorage.setItem('analysisAuth', 'true');
        closeLoginModal();
        updateUIForLogin();
        alert('Login successful!');
    } else {
        document.getElementById('loginError').textContent = 'Invalid credentials';
        document.getElementById('loginError').style.display = 'block';
    }
}

function logout() {
    if (confirm('Logout?')) {
        isLoggedIn = false;
        localStorage.removeItem('analysisAuth');
        updateUIForLogin();
        showPage('list');
    }
}

function updateUIForLogin() {
    btnForm.style.display = isLoggedIn ? 'inline-block' : 'none';
    btnLogin.style.display = isLoggedIn ? 'none' : 'inline-block';
    btnLogout.style.display = isLoggedIn ? 'inline-block' : 'none';
    updateTable();
}

function checkAuth() {
    if (localStorage.getItem('analysisAuth') === 'true') {
        isLoggedIn = true;
        updateUIForLogin();
    }
}

// Load Analyses
function loadAnalyses() {
    showLoading();
    fetch(GOOGLE_SCRIPT_URL + '?action=get&sheet=Sheet1')
        .then(r => r.json())
        .then(res => {
            hideLoading();
            if (res.result === 'success') {
                analyses = res.data || [];
                filteredAnalyses = [...analyses];
                populateFilterDropdowns();
                updateTable();
                
                // Render calendar if in calendar view
                if (document.getElementById('calendarView').style.display !== 'none') {
                    renderCalendar();
                }
            } else {
                throw new Error(res.message);
            }
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            analysisBody.innerHTML = '<tr><td colspan="14" class="no-data">Loading error</td></tr>';
        });
}

// Filters
function populateFilterDropdowns() {
    const months = [...new Set(analyses.map(a => a.month))].filter(Boolean).sort();
    const monthSelect = document.getElementById('filterMonth');
    monthSelect.innerHTML = '<option value="">All months</option>';
    months.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        monthSelect.appendChild(opt);
    });
    
    const pairs = [...new Set(analyses.map(a => a.pair))].filter(Boolean).sort();
    const pairSelect = document.getElementById('filterPair');
    pairSelect.innerHTML = '<option value="">All pairs</option>';
    pairs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        pairSelect.appendChild(opt);
    });
    
    // Populate pair filter buttons
    populatePairButtons(pairs);
}

let activePairFilter = '';

function populatePairButtons(pairs) {
    const container = document.getElementById('pairButtonsContainer');
    container.innerHTML = '';
    
    // Add "All" button
    const allBtn = document.createElement('button');
    allBtn.className = 'pair-filter-btn active';
    allBtn.textContent = 'üåê All Pairs';
    allBtn.onclick = () => filterByPair('');
    container.appendChild(allBtn);
    
    // Add button for each pair
    pairs.forEach(pair => {
        const btn = document.createElement('button');
        btn.className = 'pair-filter-btn';
        btn.textContent = pair;
        btn.onclick = () => filterByPair(pair);
        container.appendChild(btn);
    });
    
    // Add drag scroll functionality
    setupDragScroll(container);
}

function filterByPair(pair) {
    activePairFilter = pair;
    
    // Update button states
    const buttons = document.querySelectorAll('.pair-filter-btn');
    buttons.forEach(btn => {
        if ((pair === '' && btn.textContent === 'üåê All Pairs') || btn.textContent === pair) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // Update dropdown to match
    document.getElementById('filterPair').value = pair;
    
    // Apply filters
    applyFilters();
}

function setupDragScroll(container) {
    let isDown = false;
    let startX;
    let scrollLeft;
    
    container.addEventListener('mousedown', (e) => {
        isDown = true;
        container.classList.add('grabbing');
        startX = e.pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
    });
    
    container.addEventListener('mouseleave', () => {
        isDown = false;
        container.classList.remove('grabbing');
    });
    
    container.addEventListener('mouseup', () => {
        isDown = false;
        container.classList.remove('grabbing');
    });
    
    container.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - container.offsetLeft;
        const walk = (x - startX) * 2;
        container.scrollLeft = scrollLeft - walk;
    });
    
    // Touch support for mobile
    container.addEventListener('touchstart', (e) => {
        startX = e.touches[0].pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
    });
    
    container.addEventListener('touchmove', (e) => {
        const x = e.touches[0].pageX - container.offsetLeft;
        const walk = (x - startX) * 2;
        container.scrollLeft = scrollLeft - walk;
    });
}

function applyFilters() {
    const month = document.getElementById('filterMonth').value;
    const day = document.getElementById('filterDay').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const year = document.getElementById('filterYear').value;
    const pair = document.getElementById('filterPair').value;
    
    filteredAnalyses = analyses.filter(a => {
        if (month && a.month !== month) return false;
        if (day && a.day !== day) return false;
        if (year && a.year !== year) return false;
        if (pair && a.pair !== pair) return false;
        
        // Date range filter
        if (dateFrom && a.date) {
            const analysisDate = new Date(a.date);
            const fromDate = new Date(dateFrom);
            if (analysisDate < fromDate) return false;
        }
        if (dateTo && a.date) {
            const analysisDate = new Date(a.date);
            const toDate = new Date(dateTo);
            if (analysisDate > toDate) return false;
        }
        
        return true;
    });
    
    updateTable();
}

function resetFilters() {
    document.getElementById('filterMonth').value = '';
    document.getElementById('filterDay').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterYear').value = '';
    document.getElementById('filterPair').value = '';
    filteredAnalyses = [...analyses];
    updateTable();
}

// Table
function updateTable() {
    if (!filteredAnalyses.length) {
        analysisBody.innerHTML = '<tr><td colspan="7" class="no-data">No analyses yet</td></tr>';
        return;
    }
    
    analysisBody.innerHTML = '';
    
    filteredAnalyses.forEach((a, i) => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
            <td>${a.year}</td>
            <td>${a.month}</td>
            <td>${a.day}</td>
            <td>${a.date ? new Date(a.date).toLocaleDateString('ro-RO') : '-'}</td>
            <td style="font-weight: 600; color: #64B5F6;">${a.pair}</td>
            <td>
                <button onclick="viewAnalysis(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(33, 150, 243, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(33, 150, 243, 0.3)';">
                    üëÅÔ∏è View Analysis
                </button>
            </td>
            <td>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button onclick="printAnalysis(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #00BCD4, #0097A7); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üñ®Ô∏è Print
                    </button>
                    <button onclick="shareToTradingView(${analyses.indexOf(a)}, event)" style="background: linear-gradient(135deg, #2962FF, #1E53E5); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üìà TV
                    </button>
                    <button onclick="shareToDiscord(${analyses.indexOf(a)}, event)" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üìã Copy
                    </button>
                    <button onclick="sendToDiscordChannel(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #5865F2, #4752C4); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üöÄ Send to Discord
                    </button>
                    ${isLoggedIn ? `
                        <button class="edit-btn" onclick="editAnalysis(${analyses.indexOf(a)})" style="padding: 6px 12px; border-radius: 8px; font-size: 0.85em;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">‚úèÔ∏è Edit</button>
                        <button class="delete-btn" onclick="deleteAnalysis(${analyses.indexOf(a)})" style="padding: 6px 12px; border-radius: 8px; font-size: 0.85em;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üóëÔ∏è Delete</button>
                    ` : ''}
                </div>
            </td>
        `;
        
        analysisBody.appendChild(tr);
    });
}

// View Analysis Modal
let currentViewIndex = -1;
let returnToDayModal = false;
let lastDayModalData = null;

function viewAnalysis(index) {
    currentViewIndex = index;
    const a = analyses[index];
    
    // Format date
    const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
    
    // Set title
    document.getElementById('viewModalTitle').textContent = `üìä ${dateStr} - ${a.pair}`;
    
    // Build timeline navigation for same pair
    buildAnalysisTimeline(index);
    
    
    // Build content
    let content = '';
    
    // Weekly
    if (a.weeklyAnalysis || a.weeklyPhoto) {
        content += `
            <div style="background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #2196F3; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>üìÖ</span> Weekly Timeframe
                </h3>
                ${a.weeklyAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.weeklyAnalysis}</p>` : ''}
                ${a.weeklyPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.weeklyPhoto}" alt="Weekly Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #2196F3; cursor: pointer;" onclick="window.open('${a.weeklyPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // Daily
    if (a.dailyAnalysis || a.dailyPhoto) {
        content += `
            <div style="background: rgba(77, 159, 255, 0.1); border-left: 4px solid #4d9fff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #4d9fff; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>üìä</span> Daily Timeframe
                </h3>
                ${a.dailyAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.dailyAnalysis}</p>` : ''}
                ${a.dailyPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.dailyPhoto}" alt="Daily Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #4d9fff; cursor: pointer;" onclick="window.open('${a.dailyPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // 4H
    if (a.fourHAnalysis || a.fourHPhoto) {
        content += `
            <div style="background: rgba(156, 39, 176, 0.1); border-left: 4px solid #9c27b0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #9c27b0; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>‚è±Ô∏è</span> 4H Timeframe
                </h3>
                ${a.fourHAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.fourHAnalysis}</p>` : ''}
                ${a.fourHPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.fourHPhoto}" alt="4H Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #9c27b0; cursor: pointer;" onclick="window.open('${a.fourHPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // 1H
    if (a.oneHAnalysis || a.oneHPhoto) {
        content += `
            <div style="background: rgba(0, 204, 136, 0.1); border-left: 4px solid #00cc88; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #00cc88; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>‚ö°</span> 1H Timeframe
                </h3>
                ${a.oneHAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.oneHAnalysis}</p>` : ''}
                ${a.oneHPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.oneHPhoto}" alt="1H Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #00cc88; cursor: pointer;" onclick="window.open('${a.oneHPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    if (!content) {
        content = '<p style="text-align: center; color: #888;">No analysis data available</p>';
    }
    
    document.getElementById('viewModalContent').innerHTML = content;
    document.getElementById('viewModal').style.display = 'flex';
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
    currentViewIndex = -1;
}

// Print to Word Document
function printAnalysis(index) {
    const a = analyses[index];
    generateWordDocument(a);
}

function printAnalysisFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        generateWordDocument(a);
    }
}

async function generateWordDocument(analysis) {
    const dateStr = analysis.date ? new Date(analysis.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${analysis.day}, ${analysis.month} ${analysis.year}`;
    
    showLoading();
    
    try {
        // Helper function to convert image URL to base64
        const getImageAsBase64 = async (url) => {
            if (!url) return null;
            try {
                // Use a CORS proxy for external images
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (err) {
                console.error('Error loading image:', err);
                return null;
            }
        };
        
        // Generate QR codes as data URLs (inline base64)
        const generateQRCodeBase64 = async (url) => {
            if (!url) return null;
            try {
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
                const response = await fetch(qrUrl);
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (err) {
                console.error('Error generating QR code:', err);
                return null;
            }
        };
        
        // Fetch all QR codes
        const weeklyQR = analysis.weeklyPhoto ? await generateQRCodeBase64(analysis.weeklyPhoto) : null;
        const dailyQR = analysis.dailyPhoto ? await generateQRCodeBase64(analysis.dailyPhoto) : null;
        const fourHQR = analysis.fourHPhoto ? await generateQRCodeBase64(analysis.fourHPhoto) : null;
        const oneHQR = analysis.oneHPhoto ? await generateQRCodeBase64(analysis.oneHPhoto) : null;
        
        // Create HTML content for Word with embedded base64 images
        let htmlContent = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Market Analysis Report</title>
    <style>
        body {
            font-family: Calibri, Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.6;
            margin: 40px;
        }
        h1 {
            color: #2196F3;
            text-align: center;
            font-size: 24pt;
            border-bottom: 3px solid #2196F3;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #1976D2;
            font-size: 16pt;
            margin-top: 25px;
            margin-bottom: 15px;
            border-left: 4px solid #2196F3;
            padding-left: 10px;
        }
        .metadata {
            background-color: #E3F2FD;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 25px;
        }
        .metadata p {
            margin: 5px 0;
        }
        .metadata strong {
            color: #1976D2;
        }
        .section {
            margin-bottom: 30px;
        }
        .chart-section {
            background-color: #F5F5F5;
            padding: 20px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
        }
        .qr-container {
            margin: 15px auto;
            text-align: center;
        }
        .qr-container img {
            width: 200px;
            height: 200px;
            border: 2px solid #2196F3;
            padding: 5px;
            background: white;
        }
        .qr-label {
            font-size: 10pt;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #E0E0E0;
            text-align: center;
            font-size: 9pt;
            color: #666;
        }
        p {
            text-align: justify;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>üìä MARKET ANALYSIS REPORT</h1>
    
    <div class="metadata">
        <p><strong>üìÖ Date:</strong> ${dateStr}</p>
        <p><strong>üí± Pair:</strong> ${analysis.pair}</p>
        <p><strong>üìÜ Day:</strong> ${analysis.day}, ${analysis.month} ${analysis.year}</p>
    </div>
    
    <div class="section">
        <h2>üìÖ WEEKLY TIMEFRAME ANALYSIS</h2>
        <p>${analysis.weeklyAnalysis || 'No analysis provided'}</p>
        ${weeklyQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${weeklyQR}" alt="Weekly Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view Weekly chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <h2>üìä DAILY TIMEFRAME ANALYSIS</h2>
        <p>${analysis.dailyAnalysis || 'No analysis provided'}</p>
        ${dailyQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${dailyQR}" alt="Daily Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view Daily chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <h2>‚è±Ô∏è 4H TIMEFRAME ANALYSIS</h2>
        <p>${analysis.fourHAnalysis || 'No analysis provided'}</p>
        ${fourHQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${fourHQR}" alt="4H Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view 4H chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <h2>‚ö° 1H TIMEFRAME ANALYSIS</h2>
        <p>${analysis.oneHAnalysis || 'No analysis provided'}</p>
        ${oneHQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${oneHQR}" alt="1H Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view 1H chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="footer">
        <p><strong>Generated:</strong> ${new Date().toLocaleString('ro-RO')}</p>
        <p>Market Analysis Journal - Professional Trading Analysis</p>
    </div>
</body>
</html>
`;
        
        // Create blob with Word-specific settings
        const blob = new Blob([htmlContent], {
            type: 'application/msword;charset=utf-8'
        });
        
        // Create download link with proper filename
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const filename = `Analysis_${analysis.pair.replace('/', '-')}_${dateStr.replace(/\//g, '-')}.doc`;
        
        // Set download attribute to force .doc extension
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        hideLoading();
        alert('‚úÖ Analysis exported as Word document!\n\nüì± QR codes included - scan with your phone to view charts!');
        
    } catch (error) {
        console.error('Error generating Word document:', error);
        hideLoading();
        alert('‚ùå Error generating Word document. Please try again.');
    }
}

// Send to Discord Channel
async function sendToDiscordChannel(index) {
    const a = analyses[index];
    await postToDiscord(a);
}

async function sendToDiscordFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        await postToDiscord(a);
    }
}

}

function shareFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
        let template = `**üìä ${dateStr} - ${a.pair} Analysis**\n\n`;
        
        if (a.weeklyAnalysis || a.weeklyPhoto) {
            template += `**üìÖ WEEKLY TIMEFRAME**\n`;
            if (a.weeklyAnalysis) template += `${a.weeklyAnalysis}\n`;
            if (a.weeklyPhoto) template += `üì∏ Chart: ${a.weeklyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.dailyAnalysis || a.dailyPhoto) {
            template += `**üìä DAILY TIMEFRAME**\n`;
            if (a.dailyAnalysis) template += `${a.dailyAnalysis}\n`;
            if (a.dailyPhoto) template += `üì∏ Chart: ${a.dailyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.fourHAnalysis || a.fourHPhoto) {
            template += `**‚è±Ô∏è 4H TIMEFRAME**\n`;
            if (a.fourHAnalysis) template += `${a.fourHAnalysis}\n`;
            if (a.fourHPhoto) template += `üì∏ Chart: ${a.fourHPhoto}\n`;
            template += `\n`;
        }
        
        if (a.oneHAnalysis || a.oneHPhoto) {
            template += `**‚ö° 1H TIMEFRAME**\n`;
            if (a.oneHAnalysis) template += `${a.oneHAnalysis}\n`;
            if (a.oneHPhoto) template += `üì∏ Chart: ${a.oneHPhoto}\n`;
        }
        
        navigator.clipboard.writeText(template).then(() => {
            alert('‚úÖ Copied to clipboard! Paste in Discord.');
        }).catch(err => {
            alert('Copy failed! Please try again.');
        });
    }
}

function copyForTradingViewFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
        
        let template = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        template += `üìä ${a.pair} ANALYSIS - ${dateStr}\n`;
        template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        
        if (a.weeklyAnalysis || a.weeklyPhoto) {
            template += `üìÖ WEEKLY TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.weeklyAnalysis) template += `${a.weeklyAnalysis}\n`;
            if (a.weeklyPhoto) template += `\nüì∏ Chart: ${a.weeklyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.dailyAnalysis || a.dailyPhoto) {
            template += `üìä DAILY TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.dailyAnalysis) template += `${a.dailyAnalysis}\n`;
            if (a.dailyPhoto) template += `\nüì∏ Chart: ${a.dailyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.fourHAnalysis || a.fourHPhoto) {
            template += `‚è±Ô∏è 4H TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.fourHAnalysis) template += `${a.fourHAnalysis}\n`;
            if (a.fourHPhoto) template += `\nüì∏ Chart: ${a.fourHPhoto}\n`;
            template += `\n`;
        }
        
        if (a.oneHAnalysis || a.oneHPhoto) {
            template += `‚ö° 1H TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.oneHAnalysis) template += `${a.oneHAnalysis}\n`;
            if (a.oneHPhoto) template += `\nüì∏ Chart: ${a.oneHPhoto}\n`;
            template += `\n`;
        }
        
        template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        template += `üí° Analysis by @YourUsername | ${dateStr}\n`;
        template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
        
        navigator.clipboard.writeText(template).then(() => {
            alert('‚úÖ Copied to clipboard! Paste in TradingView comments.');
        }).catch(err => {
            alert('Copy failed! Please try again.');
        });
    }
}

// Share to Discord
function shareToDiscord(index, event) {
    const a = analyses[index];
    
    // Format date
    const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
    
    // Build Discord-formatted template
    let template = `**üìä ${dateStr} - ${a.pair} Analysis**\n\n`;
    
    // Weekly
    if (a.weeklyAnalysis || a.weeklyPhoto) {
        template += `**üìÖ WEEKLY TIMEFRAME**\n`;
        if (a.weeklyAnalysis) {
            template += `${a.weeklyAnalysis}\n`;
        }
        if (a.weeklyPhoto) {
            template += `üì∏ Chart: ${a.weeklyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // Daily
    if (a.dailyAnalysis || a.dailyPhoto) {
        template += `**üìä DAILY TIMEFRAME**\n`;
        if (a.dailyAnalysis) {
            template += `${a.dailyAnalysis}\n`;
        }
        if (a.dailyPhoto) {
            template += `üì∏ Chart: ${a.dailyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 4H
    if (a.fourHAnalysis || a.fourHPhoto) {
        template += `**‚è±Ô∏è 4H TIMEFRAME**\n`;
        if (a.fourHAnalysis) {
            template += `${a.fourHAnalysis}\n`;
        }
        if (a.fourHPhoto) {
            template += `üì∏ Chart: ${a.fourHPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 1H
    if (a.oneHAnalysis || a.oneHPhoto) {
        template += `**‚ö° 1H TIMEFRAME**\n`;
        if (a.oneHAnalysis) {
            template += `${a.oneHAnalysis}\n`;
        }
        if (a.oneHPhoto) {
            template += `üì∏ Chart: ${a.oneHPhoto}\n`;
        }
    }
    
    // Copy to clipboard
    navigator.clipboard.writeText(template).then(() => {
        // Show success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        btn.style.background = 'linear-gradient(135deg, #00cc88, #00aa72)';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'linear-gradient(135deg, #9c27b0, #7b1fa2)';
        }, 2000);
    }).catch(err => {
        alert('Copy failed! Please try again.');
        console.error(err);
    });
}

// Share to TradingView
function shareToTradingView(index, event) {
    const a = analyses[index];
    
    // Format date
    const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
    
    // Build TradingView-formatted template
    let template = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    template += `üìä ${a.pair} ANALYSIS - ${dateStr}\n`;
    template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    // Weekly
    if (a.weeklyAnalysis || a.weeklyPhoto) {
        template += `üìÖ WEEKLY TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.weeklyAnalysis) {
            template += `${a.weeklyAnalysis}\n`;
        }
        if (a.weeklyPhoto) {
            template += `\nüì∏ Chart: ${a.weeklyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // Daily
    if (a.dailyAnalysis || a.dailyPhoto) {
        template += `üìä DAILY TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.dailyAnalysis) {
            template += `${a.dailyAnalysis}\n`;
        }
        if (a.dailyPhoto) {
            template += `\nüì∏ Chart: ${a.dailyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 4H
    if (a.fourHAnalysis || a.fourHPhoto) {
        template += `‚è±Ô∏è 4H TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.fourHAnalysis) {
            template += `${a.fourHAnalysis}\n`;
        }
        if (a.fourHPhoto) {
            template += `\nüì∏ Chart: ${a.fourHPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 1H
    if (a.oneHAnalysis || a.oneHPhoto) {
        template += `‚ö° 1H TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.oneHAnalysis) {
            template += `${a.oneHAnalysis}\n`;
        }
        if (a.oneHPhoto) {
            template += `\nüì∏ Chart: ${a.oneHPhoto}\n`;
        }
        template += `\n`;
    }
    
    template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    template += `üí° Analysis by @YourUsername | ${dateStr}\n`;
    template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(template).then(() => {
        // Show success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        btn.style.background = 'linear-gradient(135deg, #00cc88, #00aa72)';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'linear-gradient(135deg, #2962FF, #1E53E5)';
        }, 2000);
    }).catch(err => {
        alert('Copy failed! Please try again.');
        console.error(err);
    });
}

// Save
saveBtn.onclick = () => {
    const analysis = getFormData();
    if (!analysis) return;
    
    if (editingIndex >= 0 && analyses[editingIndex]?.id) {
        analysis.id = analyses[editingIndex].id;
        updateAnalysis(analysis);
    } else {
        addAnalysis(analysis);
    }
};

function getFormData() {
    const required = ['month', 'day', 'date', 'year', 'pair'];
    for (const id of required) {
        if (!document.getElementById(id).value) {
            alert('Please fill Month, Day, Date, Year, and Pair');
            return null;
        }
    }
    
    // Get pair value (handle "Other" option)
    let pairValue = document.getElementById('pair').value;
    if (pairValue === 'Other') {
        pairValue = document.getElementById('customPair').value;
        if (!pairValue || pairValue.trim() === '') {
            alert('Please enter a custom pair');
            return null;
        }
    }
    
    // Get date value WITHOUT timezone conversion
    const dateInput = document.getElementById('date').value; // Already in YYYY-MM-DD format
    
    return {
        month: document.getElementById('month').value,
        day: document.getElementById('day').value,
        date: dateInput, // Save as YYYY-MM-DD without time
        year: document.getElementById('year').value,
        pair: pairValue,
        weeklyAnalysis: document.getElementById('weeklyAnalysis').value,
        weeklyPhoto: document.getElementById('weeklyPhoto').value,
        dailyAnalysis: document.getElementById('dailyAnalysis').value,
        dailyPhoto: document.getElementById('dailyPhoto').value,
        fourHAnalysis: document.getElementById('fourHAnalysis').value,
        fourHPhoto: document.getElementById('fourHPhoto').value,
        oneHAnalysis: document.getElementById('oneHAnalysis').value,
        oneHPhoto: document.getElementById('oneHPhoto').value
    };
}

function addAnalysis(analysis) {
    showLoading();
    const qs = new URLSearchParams({ action: 'add', ...analysis });
    fetch(GOOGLE_SCRIPT_URL + '?' + qs)
        .then(() => {
            hideLoading();
            clearForm();
            showPage('list');
            loadAnalyses();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Save error');
        });
}

function updateAnalysis(analysis) {
    showLoading();
    const qs = new URLSearchParams({ action: 'update', ...analysis });
    fetch(GOOGLE_SCRIPT_URL + '?' + qs)
        .then(() => {
            hideLoading();
            editingIndex = -1;
            clearForm();
            showPage('list');
            loadAnalyses();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Update error');
        });
}

function editAnalysis(i) {
    editingIndex = i;
    const a = analyses[i];
    
    // Handle pair selection (check if it's a predefined pair or custom)
    const predefinedPairs = ['EUR/USD', 'GBP/USD', 'XAU/USD', 'USD/JPY', 'US100', 'GER40'];
    if (predefinedPairs.includes(a.pair)) {
        document.getElementById('pair').value = a.pair;
        document.getElementById('customPairGroup').style.display = 'none';
    } else {
        document.getElementById('pair').value = 'Other';
        document.getElementById('customPair').value = a.pair;
        document.getElementById('customPairGroup').style.display = 'block';
    }
    
    document.getElementById('month').value = a.month || '';
    document.getElementById('day').value = a.day || '';
    document.getElementById('date').value = a.date || '';
    document.getElementById('year').value = a.year || '';
    document.getElementById('weeklyAnalysis').value = a.weeklyAnalysis || '';
    document.getElementById('weeklyPhoto').value = a.weeklyPhoto || '';
    document.getElementById('dailyAnalysis').value = a.dailyAnalysis || '';
    document.getElementById('dailyPhoto').value = a.dailyPhoto || '';
    document.getElementById('fourHAnalysis').value = a.fourHAnalysis || '';
    document.getElementById('fourHPhoto').value = a.fourHPhoto || '';
    document.getElementById('oneHAnalysis').value = a.oneHAnalysis || '';
    document.getElementById('oneHPhoto').value = a.oneHPhoto || '';
    
    showPage('form');
}

function deleteAnalysis(i) {
    if (!confirm('Delete this analysis?')) return;
    showLoading();
    fetch(`${GOOGLE_SCRIPT_URL}?action=delete&id=${analyses[i].id}`)
        .then(() => {
            hideLoading();
            loadAnalyses();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Delete error');
        });
}

function clearForm() {
    ['month', 'day', 'date', 'year', 'pair', 'weeklyAnalysis', 'weeklyPhoto',
     'dailyAnalysis', 'dailyPhoto', 'fourHAnalysis', 'fourHPhoto',
     'oneHAnalysis', 'oneHPhoto'].forEach(id => {
        document.getElementById(id).value = '';
    });
    editingIndex = -1;
}

// View Mode Switch
function switchView(mode) {
    const journalView = document.getElementById('journalView');
    const calendarView = document.getElementById('calendarView');
    const btnJournal = document.getElementById('btnJournalView');
    const btnCalendar = document.getElementById('btnCalendarView');
    
    // Get filter sections
    const filterSections = document.querySelectorAll('.filter-section, #pairButtonsContainer').length > 0 
        ? Array.from(document.querySelectorAll('.filter-section')).concat([document.getElementById('pairButtonsContainer').parentElement])
        : [];
    
    if (mode === 'journal') {
        journalView.style.display = 'block';
        calendarView.style.display = 'none';
        btnJournal.classList.add('active');
        btnCalendar.classList.remove('active');
        
        // Show filters
        filterSections.forEach(section => {
            if (section) section.style.display = 'block';
        });
    } else {
        journalView.style.display = 'none';
        calendarView.style.display = 'block';
        btnJournal.classList.remove('active');
        btnCalendar.classList.add('active');
        
        // Hide filters
        filterSections.forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        renderCalendar();
    }
}

// Calendar Functions
let currentSelectedDate = null;
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

// Initialize month and year pickers
function initializeMonthYearPickers() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Build month picker
    const monthPicker = document.getElementById('monthPicker').querySelector('div');
    monthPicker.innerHTML = '';
    monthNames.forEach((month, index) => {
        const btn = document.createElement('button');
        btn.textContent = month.substring(0, 3);
        btn.onclick = () => selectMonth(index);
        btn.style.cssText = `
            background: ${index === currentCalendarMonth ? 'linear-gradient(135deg, #2196F3, #1976D2)' : 'rgba(33, 150, 243, 0.1)'};
            color: ${index === currentCalendarMonth ? '#fff' : '#64B5F6'};
            border: 1px solid ${index === currentCalendarMonth ? '#2196F3' : 'rgba(33, 150, 243, 0.3)'};
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        `;
        btn.onmouseover = () => {
            if (index !== currentCalendarMonth) {
                btn.style.background = 'rgba(33, 150, 243, 0.3)';
                btn.style.transform = 'scale(1.05)';
            }
        };
        btn.onmouseout = () => {
            if (index !== currentCalendarMonth) {
                btn.style.background = 'rgba(33, 150, 243, 0.1)';
                btn.style.transform = 'scale(1)';
            }
        };
        monthPicker.appendChild(btn);
    });
    
    // Build year picker (current year ¬± 5 years)
    const yearPicker = document.getElementById('yearPicker').querySelector('div');
    yearPicker.innerHTML = '';
    const startYear = currentCalendarYear - 5;
    for (let i = 0; i < 12; i++) {
        const year = startYear + i;
        const btn = document.createElement('button');
        btn.textContent = year;
        btn.onclick = () => selectYear(year);
        btn.style.cssText = `
            background: ${year === currentCalendarYear ? 'linear-gradient(135deg, #2196F3, #1976D2)' : 'rgba(33, 150, 243, 0.1)'};
            color: ${year === currentCalendarYear ? '#fff' : '#64B5F6'};
            border: 1px solid ${year === currentCalendarYear ? '#2196F3' : 'rgba(33, 150, 243, 0.3)'};
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        `;
        btn.onmouseover = () => {
            if (year !== currentCalendarYear) {
                btn.style.background = 'rgba(33, 150, 243, 0.3)';
                btn.style.transform = 'scale(1.05)';
            }
        };
        btn.onmouseout = () => {
            if (year !== currentCalendarYear) {
                btn.style.background = 'rgba(33, 150, 243, 0.1)';
                btn.style.transform = 'scale(1)';
            }
        };
        yearPicker.appendChild(btn);
    }
}

function toggleMonthPicker() {
    const picker = document.getElementById('monthPicker');
    const yearPicker = document.getElementById('yearPicker');
    yearPicker.style.display = 'none';
    
    if (picker.style.display === 'none') {
        initializeMonthYearPickers();
        picker.style.display = 'block';
    } else {
        picker.style.display = 'none';
    }
}

function toggleYearPicker() {
    const picker = document.getElementById('yearPicker');
    const monthPicker = document.getElementById('monthPicker');
    monthPicker.style.display = 'none';
    
    if (picker.style.display === 'none') {
        initializeMonthYearPickers();
        picker.style.display = 'block';
    } else {
        picker.style.display = 'none';
    }
}

function selectMonth(month) {
    currentCalendarMonth = month;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('selectedMonth').textContent = monthNames[month];
    document.getElementById('monthPicker').style.display = 'none';
    renderCalendar();
}

function selectYear(year) {
    currentCalendarYear = year;
    document.getElementById('selectedYear').textContent = year;
    document.getElementById('yearPicker').style.display = 'none';
    renderCalendar();
}

// Close pickers when clicking outside
document.addEventListener('click', function(event) {
    const monthBtn = document.getElementById('monthSelectorBtn');
    const yearBtn = document.getElementById('yearSelectorBtn');
    const monthPicker = document.getElementById('monthPicker');
    const yearPicker = document.getElementById('yearPicker');
    
    if (monthPicker && !monthBtn?.contains(event.target) && !monthPicker.contains(event.target)) {
        monthPicker.style.display = 'none';
    }
    if (yearPicker && !yearBtn?.contains(event.target) && !yearPicker.contains(event.target)) {
        yearPicker.style.display = 'none';
    }
});

function changeMonth(delta) {
    currentCalendarMonth += delta;
    
    if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    } else if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    }
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('selectedMonth').textContent = monthNames[currentCalendarMonth];
    document.getElementById('selectedYear').textContent = currentCalendarYear;
    
    renderCalendar();
}

function renderCalendar() {
    const month = currentCalendarMonth;
    const year = currentCalendarYear;
    const grid = document.getElementById('calendarGrid');
    
    console.log('Rendering calendar for:', month, year);
    console.log('Total analyses:', analyses.length);
    console.log('Sample analysis:', analyses[0]);
    
    grid.innerHTML = '';
    
    // Add day headers
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    days.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Get first day of month
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    // Adjust first day (make Monday = 0)
    const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
    
    // Add previous month's days
    for (let i = adjustedFirstDay - 1; i >= 0; i--) {
        const dayDiv = createDayCell(daysInPrevMonth - i, month - 1, year, true);
        grid.appendChild(dayDiv);
    }
    
    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = createDayCell(day, month, year, false);
        grid.appendChild(dayDiv);
    }
    
    // Add next month's days to fill grid
    const totalCells = grid.children.length - 7;
    const remainingCells = 42 - totalCells - 7;
    for (let day = 1; day <= remainingCells; day++) {
        const dayDiv = createDayCell(day, month + 1, year, true);
        grid.appendChild(dayDiv);
    }
}

function createDayCell(day, month, year, isOtherMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    
    if (isOtherMonth) {
        dayDiv.classList.add('other-month');
    }
    
    // Adjust month for proper date creation
    let actualMonth = month;
    let actualYear = year;
    if (month < 0) {
        actualMonth = 11;
        actualYear = year - 1;
    } else if (month > 11) {
        actualMonth = 0;
        actualYear = year + 1;
    }
    
    const dateStr = `${actualYear}-${String(actualMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    // Count analyses for this day - parse date in local timezone
    const analysesForDay = analyses.filter(a => {
        if (!a.date) return false;
        
        // Parse the ISO date string and format it in local timezone (not UTC)
        const date = new Date(a.date);
        const localDateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        return localDateStr === dateStr;
    });
    
    if (day === 11 && !isOtherMonth) {
        console.log('Day 11 - dateStr:', dateStr, 'analyses:', analysesForDay.length);
        if (analyses.length > 0 && analyses[0].date) {
            const testDate = new Date(analyses[0].date);
            console.log('Test analysis date:', analyses[0].date, '-> local:', testDate.getDate(), testDate.getMonth() + 1, testDate.getFullYear());
        }
    }
    
    if (analysesForDay.length > 0 && !isOtherMonth) {
        dayDiv.classList.add('has-analysis');
    }
    
    // Check if selected
    if (currentSelectedDate === dateStr && !isOtherMonth) {
        dayDiv.classList.add('selected');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'calendar-day-number';
    dayNumber.textContent = day;
    dayDiv.appendChild(dayNumber);
    
    // Add pairs list
    if (analysesForDay.length > 0 && !isOtherMonth) {
        const pairsContainer = document.createElement('div');
        pairsContainer.className = 'calendar-day-pairs';
        
        analysesForDay.forEach(a => {
            const pairBullet = document.createElement('div');
            pairBullet.className = 'calendar-pair-bullet';
            pairBullet.textContent = `‚Ä¢ ${a.pair}`;
            pairsContainer.appendChild(pairBullet);
        });
        
        dayDiv.appendChild(pairsContainer);
    }
    
    if (!isOtherMonth) {
        dayDiv.onclick = (e) => {
            console.log('Clicked day:', day, 'dateStr:', dateStr, 'analyses:', analysesForDay.length);
            showAnalysesForDay(dateStr, day, actualMonth, actualYear);
        };
    }
    
    return dayDiv;
}

function showAnalysesForDay(dateStr, day, month, year) {
    currentSelectedDate = dateStr;
    renderCalendar();
    
    // Filter analyses by date - parse in local timezone
    const analysesForDay = analyses.filter(a => {
        if (!a.date) return false;
        const date = new Date(a.date);
        const localDateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        return localDateStr === dateStr;
    });
    
    console.log('showAnalysesForDay - dateStr:', dateStr, 'found:', analysesForDay.length);
    
    if (analysesForDay.length === 0) {
        return;
    }
    
    // Store modal data for back button
    lastDayModalData = { dateStr, day, month, year };
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Set modal title
    document.getElementById('dayModalTitle').textContent = `üìÖ ${day} ${monthNames[month]} ${year} - ${analysesForDay.length} ${analysesForDay.length === 1 ? 'Analysis' : 'Analyses'}`;
    
    // Build content
    const content = document.getElementById('dayModalContent');
    content.innerHTML = '';
    
    analysesForDay.forEach((a, index) => {
        const card = document.createElement('div');
        card.style.cssText = 'background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(25, 118, 210, 0.05)); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 15px; padding: 25px; transition: all 0.3s ease; cursor: pointer;';
        
        card.onmouseover = () => {
            card.style.borderColor = '#2196F3';
            card.style.boxShadow = '0 4px 20px rgba(33, 150, 243, 0.3)';
        };
        card.onmouseout = () => {
            card.style.borderColor = 'rgba(33, 150, 243, 0.3)';
            card.style.boxShadow = 'none';
        };
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #2196F3; margin: 0 0 8px 0; font-size: 1.8em;">${a.pair}</h3>
                    <p style="color: #aaa; margin: 0; font-size: 0.9em;">${a.day}, ${a.month} ${a.year}</p>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="event.stopPropagation(); viewAnalysisFromDay(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #4d9fff, #3d7fff); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üëÅÔ∏è View Full
                    </button>
                    <button onclick="event.stopPropagation(); printAnalysis(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #00BCD4, #0097A7); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üñ®Ô∏è Print
                    </button>
                    <button onclick="event.stopPropagation(); shareToTradingView(${analyses.indexOf(a)}, event)" style="background: linear-gradient(135deg, #2962FF, #1E53E5); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üìà TV
                    </button>
                    <button onclick="event.stopPropagation(); shareToDiscord(${analyses.indexOf(a)}, event)" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üìã Copy
                    </button>
                    <button onclick="event.stopPropagation(); sendToDiscordChannel(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #5865F2, #4752C4); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üöÄ Send to Discord
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                ${a.weeklyAnalysis ? `
                    <div style="background: rgba(33, 150, 243, 0.05); border-left: 3px solid #2196F3; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #2196F3; margin: 0 0 10px 0; font-size: 1em;">üìÖ WEEKLY</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.weeklyAnalysis.substring(0, 150)}${a.weeklyAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.weeklyPhoto ? `<a href="${a.weeklyPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
                ${a.dailyAnalysis ? `
                    <div style="background: rgba(77, 159, 255, 0.05); border-left: 3px solid #4d9fff; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #4d9fff; margin: 0 0 10px 0; font-size: 1em;">üìä DAILY</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.dailyAnalysis.substring(0, 150)}${a.dailyAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.dailyPhoto ? `<a href="${a.dailyPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
                ${a.fourHAnalysis ? `
                    <div style="background: rgba(156, 39, 176, 0.05); border-left: 3px solid #9c27b0; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #9c27b0; margin: 0 0 10px 0; font-size: 1em;">‚è±Ô∏è 4H</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.fourHAnalysis.substring(0, 150)}${a.fourHAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.fourHPhoto ? `<a href="${a.fourHPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
                ${a.oneHAnalysis ? `
                    <div style="background: rgba(0, 204, 136, 0.05); border-left: 3px solid #00cc88; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #00cc88; margin: 0 0 10px 0; font-size: 1em;">‚ö° 1H</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.oneHAnalysis.substring(0, 150)}${a.oneHAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.oneHPhoto ? `<a href="${a.oneHPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
        
        // Make card clickable to view full analysis
        card.onclick = () => {
            viewAnalysisFromDay(analyses.indexOf(a));
        };
        
        content.appendChild(card);
    });
    
    // Show modal
    document.getElementById('dayModal').style.display = 'flex';
}

function buildAnalysisTimeline(currentIndex) {
    const currentAnalysis = analyses[currentIndex];
    const timeline = document.getElementById('analysisTimeline');
    
    // Find all analyses for the same pair, sorted by date
    const samePairAnalyses = analyses
        .map((a, idx) => ({ ...a, originalIndex: idx }))
        .filter(a => a.pair === currentAnalysis.pair && a.date)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    if (samePairAnalyses.length <= 1) {
        timeline.style.display = 'none';
        return;
    }
    
    // Find current position in sorted list
    const currentPos = samePairAnalyses.findIndex(a => a.originalIndex === currentIndex);
    
    // Build timeline HTML
    let timelineHTML = '<div style="color: #90CAF9; font-size: 0.9em; margin-bottom: 10px; text-align: center; font-weight: 600;">üìä ' + currentAnalysis.pair + ' Analysis Timeline</div>';
    timelineHTML += '<div style="display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">';
    
    samePairAnalyses.forEach((a, idx) => {
        const date = new Date(a.date);
        const dateLabel = date.toLocaleDateString('ro-RO', { day: 'numeric', month: 'short' });
        const isCurrent = idx === currentPos;
        const isPast = idx < currentPos;
        const isFuture = idx > currentPos;
        
        let buttonStyle = '';
        let icon = '';
        
        if (isCurrent) {
            buttonStyle = 'background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: 2px solid #64B5F6; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);';
            icon = 'üìç';
        } else if (isPast) {
            buttonStyle = 'background: rgba(100, 181, 246, 0.15); color: #64B5F6; border: 1px solid rgba(100, 181, 246, 0.3);';
            icon = '‚óÑ';
        } else {
            buttonStyle = 'background: rgba(0, 188, 212, 0.15); color: #00BCD4; border: 1px solid rgba(0, 188, 212, 0.3);';
            icon = '‚ñ∫';
        }
        
        timelineHTML += `
            <button 
                onclick="viewAnalysis(${a.originalIndex})" 
                style="${buttonStyle} padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease; white-space: nowrap;"
                onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.4)';"
                onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='${isCurrent ? '0 4px 15px rgba(33, 150, 243, 0.5)' : 'none'}';"
            >
                ${icon} ${dateLabel}
            </button>
        `;
        
        // Add arrow between buttons (except after last)
        if (idx < samePairAnalyses.length - 1) {
            timelineHTML += '<span style="color: rgba(33, 150, 243, 0.3); font-size: 1.2em;">‚Üí</span>';
        }
    });
    
    timelineHTML += '</div>';
    
    timeline.innerHTML = timelineHTML;
    timeline.style.display = 'block';
}

function viewAnalysisFromDay(index) {
    returnToDayModal = true;
    closeDayModal();
    viewAnalysis(index);
    // Show back button
    document.getElementById('backToDayBtn').style.display = 'inline-block';
}

function backToDayModal() {
    closeViewModal();
    if (lastDayModalData) {
        showAnalysesForDay(lastDayModalData.dateStr, lastDayModalData.day, lastDayModalData.month, lastDayModalData.year);
    }
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
    document.getElementById('backToDayBtn').style.display = 'none';
    returnToDayModal = false;
    currentViewIndex = -1;
}

function closeDayModal() {
    document.getElementById('dayModal').style.display = 'none';
    if (!returnToDayModal) {
        lastDayModalData = null;
    }
}

// Init
window.onload = () => {
    checkAuth();
    loadAnalyses();
    
    // Set calendar to current month/year
    const now = new Date();
    currentCalendarMonth = now.getMonth();
    currentCalendarYear = now.getFullYear();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('selectedMonth').textContent = monthNames[currentCalendarMonth];
    document.getElementById('selectedYear').textContent = currentCalendarYear;
    
    // Set Calendar View as default
    switchView('calendar');
};
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Version: V8-SEPARATE-CHAINS-CORRECT-WRONG -->
    <title>A random trader</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1a2840 50%, #0d1b2a 100%);
            background-attachment: fixed;
            color: #f1f5f9;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            padding: 0 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(25, 118, 210, 0.05));
            border-radius: 20px;
            border: 1px solid rgba(33, 150, 243, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.8em;
            background: linear-gradient(135deg, #2196F3, #64B5F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #90CAF9;
            font-size: 1.1em;
            font-weight: 500;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: #fff;
            border: none;
            padding: 14px 35px;
            margin: 0;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            letter-spacing: 0.3px;
        }

        .nav-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px rgba(33, 150, 243, 0.6),
                        0 0 20px rgba(33, 150, 243, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #64B5F6, #2196F3);
            color: #fff;
            box-shadow: 0 4px 20px rgba(100, 181, 246, 0.5),
                        0 0 30px rgba(33, 150, 243, 0.3);
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #2196F3;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
        }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2196F3;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        select option {
            background: #1a1a1a;
            color: #fff;
        }

        textarea {
            resize: vertical;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .save-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: #fff;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        .table-container {
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 15px;
            padding: 20px;
            max-width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        thead {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.2));
        }

        th {
            padding: 12px 8px;
            text-align: left;
            color: #2196F3;
            font-weight: 600;
            border-bottom: 2px solid #2196F3;
            white-space: nowrap;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ddd;
            font-size: 0.9em;
        }

        tr:hover {
            background: rgba(33, 150, 243, 0.05);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 1.1em;
        }

        .edit-btn, .delete-btn {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            border: none;
            color: #fff;
            margin-right: 5px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #4488ff, #0066cc);
        }

        .delete-btn {
            background: linear-gradient(135deg, #ff4444, #cc0000);
        }

        .edit-btn:hover, .delete-btn:hover {
            transform: scale(1.05);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 5px solid rgba(33, 150, 243, 0.2);
            border-top: 5px solid #2196F3;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-section {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .filter-section {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.08), rgba(25, 118, 210, 0.03));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.25);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .pair-filter-btn {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1));
            border: 2px solid rgba(33, 150, 243, 0.4);
            color: #2196F3;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .pair-filter-btn:hover {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(25, 118, 210, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .pair-filter-btn.active {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-color: #2196F3;
            color: #fff;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
        }

        #pairButtonsContainer::-webkit-scrollbar {
            height: 8px;
        }

        #pairButtonsContainer::-webkit-scrollbar-track {
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
        }

        #pairButtonsContainer::-webkit-scrollbar-thumb {
            background: #2196F3;
            border-radius: 10px;
        }

        #pairButtonsContainer::-webkit-scrollbar-thumb:hover {
            background: #1976D2;
        }

        #pairButtonsContainer.grabbing {
            cursor: grabbing;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 100px;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: rgba(33, 150, 243, 0.1);
            border-color: #2196F3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .calendar-day.has-analysis {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1));
            border-color: #2196F3;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-color: #2196F3;
            color: #fff;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            pointer-events: none;
        }

        .calendar-day-number {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(33, 150, 243, 0.3);
        }

        .calendar-day.selected .calendar-day-number {
            border-bottom-color: rgba(255, 255, 255, 0.5);
        }

        .calendar-day-pairs {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 0.75em;
            margin-top: 5px;
            overflow-y: auto;
            max-height: 60px;
        }

        .calendar-day-pairs::-webkit-scrollbar {
            width: 3px;
        }

        .calendar-day-pairs::-webkit-scrollbar-thumb {
            background: #2196F3;
            border-radius: 3px;
        }

        .calendar-pair-bullet {
            color: #2196F3;
            padding: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-day.selected .calendar-pair-bullet {
            color: #fff;
        }

        .calendar-header {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #2196F3;
            font-size: 0.9em;
        }

        .view-mode-btn.active {
            background: linear-gradient(135deg, #2196F3, #1976D2) !important;
            color: #fff !important;
            border-color: #2196F3 !important;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div style="font-size: 4em; line-height: 1;">üìä</div>
                <div style="text-align: center;">
                    <h1>Cristian - A stranger trader</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.1em; color: #90CAF9; font-weight: 500; font-style: italic;">Market analysis made easy</p>
                </div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" id="btnList">üìä Journal View</button>
            <!-- Active Analyses button removed - dashboard now shown in calendar view -->
            <button class="nav-btn" id="btnForm">‚ûï Add Analysis</button>
        </div>

        <!-- Form Page -->
<!-- ============================================ -->
<!-- COMPLETE MULTI-STEP WIZARD - REPLACE formPage -->
<!-- Find <div id="formPage" class="page"> and replace entire section -->
<!-- ============================================ -->

<div id="formPage" class="page">
    <!-- Step Indicator -->
    <div style="max-width: 900px; margin: 0 auto 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; position: relative;">
            <!-- Progress Line -->
            <div style="position: absolute; top: 20px; left: 0; right: 0; height: 4px; background: rgba(33, 150, 243, 0.2); z-index: 0;">
                <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #2196F3, #00BCD4); width: 0%; transition: width 0.3s ease;"></div>
            </div>
            
            <!-- Steps -->
            <div class="wizard-step active" id="stepIndicator1" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #2196F3, #1976D2); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; border: 3px solid #0a1929;">1</div>
                <p style="margin: 0; color: #2196F3; font-size: 0.9em; font-weight: 600;">Pair</p>
            </div>
            <div class="wizard-step" id="stepIndicator2" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(33, 150, 243, 0.2); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: #90CAF9; font-weight: 600; border: 3px solid #0a1929;">2</div>
                <p style="margin: 0; color: #90CAF9; font-size: 0.9em;">Date</p>
            </div>
            <div class="wizard-step" id="stepIndicator3" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(33, 150, 243, 0.2); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: #90CAF9; font-weight: 600; border: 3px solid #0a1929;">3</div>
                <p style="margin: 0; color: #90CAF9; font-size: 0.9em;">Analysis</p>
            </div>
            <div class="wizard-step" id="stepIndicator4" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(33, 150, 243, 0.2); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: #90CAF9; font-weight: 600; border: 3px solid #0a1929;">4</div>
                <p style="margin: 0; color: #90CAF9; font-size: 0.9em;">Confirm</p>
            </div>
        </div>
    </div>

    <!-- STEP 1: Select Pair -->
    <div id="wizardStep1" class="wizard-step-content active">
        <div style="max-width: 700px; margin: 0 auto; text-align: center;">
            <h2 style="color: #2196F3; font-size: 2.2em; margin-bottom: 15px;">üìä Select Trading Pair</h2>
            <p style="color: #90CAF9; margin-bottom: 40px; font-size: 1.1em;">Choose the pair you want to analyze</p>
            
            <div id="pairSelection" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 30px; max-height: 400px; overflow-y: auto; padding: 10px;">
                <!-- Major Pairs -->
                <button onclick="selectPair('EUR/USD')" class="pair-select-btn">EUR/USD</button>
                <button onclick="selectPair('GBP/USD')" class="pair-select-btn">GBP/USD</button>
                <button onclick="selectPair('USD/JPY')" class="pair-select-btn">USD/JPY</button>
                <button onclick="selectPair('USD/CHF')" class="pair-select-btn">USD/CHF</button>
                <button onclick="selectPair('AUD/USD')" class="pair-select-btn">AUD/USD</button>
                <button onclick="selectPair('USD/CAD')" class="pair-select-btn">USD/CAD</button>
                <button onclick="selectPair('NZD/USD')" class="pair-select-btn">NZD/USD</button>
                
                <!-- JPY Crosses -->
                <button onclick="selectPair('GBP/JPY')" class="pair-select-btn">GBP/JPY</button>
                <button onclick="selectPair('EUR/JPY')" class="pair-select-btn">EUR/JPY</button>
                <button onclick="selectPair('AUD/JPY')" class="pair-select-btn">AUD/JPY</button>
                <button onclick="selectPair('CHF/JPY')" class="pair-select-btn">CHF/JPY</button>
                <button onclick="selectPair('CAD/JPY')" class="pair-select-btn">CAD/JPY</button>
                <button onclick="selectPair('NZD/JPY')" class="pair-select-btn">NZD/JPY</button>
                
                <!-- EUR Crosses -->
                <button onclick="selectPair('EUR/AUD')" class="pair-select-btn">EUR/AUD</button>
                <button onclick="selectPair('EUR/CHF')" class="pair-select-btn">EUR/CHF</button>
                <button onclick="selectPair('EUR/CAD')" class="pair-select-btn">EUR/CAD</button>
                <button onclick="selectPair('EUR/NZD')" class="pair-select-btn">EUR/NZD</button>
                <button onclick="selectPair('EUR/GBP')" class="pair-select-btn">EUR/GBP</button>
                
                <!-- GBP Crosses -->
                <button onclick="selectPair('GBP/AUD')" class="pair-select-btn">GBP/AUD</button>
                <button onclick="selectPair('GBP/CHF')" class="pair-select-btn">GBP/CHF</button>
                <button onclick="selectPair('GBP/CAD')" class="pair-select-btn">GBP/CAD</button>
                <button onclick="selectPair('GBP/NZD')" class="pair-select-btn">GBP/NZD</button>
                
                <!-- Other Crosses -->
                <button onclick="selectPair('AUD/CHF')" class="pair-select-btn">AUD/CHF</button>
                <button onclick="selectPair('AUD/CAD')" class="pair-select-btn">AUD/CAD</button>
                <button onclick="selectPair('AUD/NZD')" class="pair-select-btn">AUD/NZD</button>
                <button onclick="selectPair('CAD/CHF')" class="pair-select-btn">CAD/CHF</button>
                <button onclick="selectPair('NZD/CHF')" class="pair-select-btn">NZD/CHF</button>
                
                <!-- Metals -->
                <button onclick="selectPair('XAU/USD')" class="pair-select-btn">XAU/USD</button>
                <button onclick="selectPair('XAG/USD')" class="pair-select-btn">XAG/USD</button>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: rgba(33, 150, 243, 0.05); border-radius: 15px; border: 1px dashed rgba(33, 150, 243, 0.3);">
                <p style="color: #90CAF9; margin-bottom: 15px; font-weight: 600;">Custom Pair</p>
                <input type="text" id="customPairInput" placeholder="e.g., AUD/USD, BTC/USD" style="width: 100%; max-width: 300px; padding: 12px; background: rgba(33, 150, 243, 0.1); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 10px; color: #fff; font-size: 1em; text-align: center;">
                <button onclick="selectCustomPair()" style="margin-left: 10px; padding: 12px 30px; background: linear-gradient(135deg, #00BCD4, #0097A7); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    ‚úì Use
                </button>
            </div>
        </div>
    </div>

    <!-- STEP 2: Select Date -->
    <div id="wizardStep2" class="wizard-step-content" style="display: none;">
        <div style="max-width: 600px; margin: 0 auto; text-align: center;">
            <h2 style="color: #2196F3; font-size: 2.2em; margin-bottom: 15px;">üìÖ Select Analysis Date</h2>
            <p style="color: #90CAF9; margin-bottom: 40px; font-size: 1.1em;">
                Analyzing <span id="selectedPairDisplay" style="color: #00E676; font-weight: 700;"></span>
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div>
                    <label style="display: block; color: #90CAF9; margin-bottom: 10px; font-weight: 600;">Month</label>
                    <select id="wizardMonth" class="wizard-input">
                        <option value="January">January</option>
                        <option value="February" selected>February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; color: #90CAF9; margin-bottom: 10px; font-weight: 600;">Year</label>
                    <select id="wizardYear" class="wizard-input">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; color: #90CAF9; margin-bottom: 10px; font-weight: 600;">Day of Week</label>
                <select id="wizardDay" class="wizard-input">
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday" selected>Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>

            <div style="margin-bottom: 40px;">
                <label style="display: block; color: #90CAF9; margin-bottom: 10px; font-weight: 600;">Exact Date</label>
                <input type="date" id="wizardDate" class="wizard-input">
            </div>

            <div style="display: flex; gap: 15px;">
                <button onclick="wizardPrevStep()" class="wizard-btn-secondary">‚Üê Back</button>
                <button onclick="wizardNextStep()" class="wizard-btn-primary">Continue ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- STEP 3: Analysis Content -->
    <div id="wizardStep3" class="wizard-step-content" style="display: none;">
        <div style="max-width: 900px; margin: 0 auto;">
            <h2 style="color: #2196F3; font-size: 2.2em; margin-bottom: 15px; text-align: center;">üìà Market Analysis</h2>
            <p style="color: #90CAF9; margin-bottom: 40px; font-size: 1.1em; text-align: center;">
                <span id="pairDateSummary"></span>
            </p>

            <!-- Weekly -->
            <div class="analysis-card" style="background: rgba(255, 149, 0, 0.1); border-left: 4px solid #FF9500; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                <h3 style="color: #FF9500; margin-bottom: 15px; font-size: 1.4em;">üìÖ Weekly Timeframe</h3>
                <textarea id="wizardWeeklyAnalysis" placeholder="Enter your weekly analysis..." class="wizard-textarea"></textarea>
                <input type="url" id="wizardWeeklyPhoto" placeholder="Chart link (optional)" class="wizard-input" style="margin-top: 15px;">
            </div>

            <!-- Daily -->
            <div class="analysis-card" style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                <h3 style="color: #4CAF50; margin-bottom: 15px; font-size: 1.4em;">üìä Daily Timeframe</h3>
                <textarea id="wizardDailyAnalysis" placeholder="Enter your daily analysis..." class="wizard-textarea"></textarea>
                <input type="url" id="wizardDailyPhoto" placeholder="Chart link (optional)" class="wizard-input" style="margin-top: 15px;">
            </div>

            <!-- 4H -->
            <div class="analysis-card" style="background: rgba(156, 39, 176, 0.1); border-left: 4px solid #9C27B0; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                <h3 style="color: #9C27B0; margin-bottom: 15px; font-size: 1.4em;">‚è±Ô∏è 4H Timeframe</h3>
                <textarea id="wizardFourHAnalysis" placeholder="Enter your 4H analysis..." class="wizard-textarea"></textarea>
                <input type="url" id="wizardFourHPhoto" placeholder="Chart link (optional)" class="wizard-input" style="margin-top: 15px;">
            </div>

            <!-- 1H -->
            <div class="analysis-card" style="background: rgba(0, 188, 212, 0.1); border-left: 4px solid #00BCD4; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                <h3 style="color: #00BCD4; margin-bottom: 15px; font-size: 1.4em;">‚ö° 1H Timeframe</h3>
                <textarea id="wizardOneHAnalysis" placeholder="Enter your 1H analysis..." class="wizard-textarea"></textarea>
                <input type="url" id="wizardOneHPhoto" placeholder="Chart link (optional)" class="wizard-input" style="margin-top: 15px;">
            </div>

            <div style="display: flex; gap: 15px; margin-top: 40px;">
                <button onclick="wizardPrevStep()" class="wizard-btn-secondary">‚Üê Back</button>
                <button onclick="wizardNextStep()" class="wizard-btn-primary">Continue to Validation ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- STEP 4: Validation & Confirmation -->
    <div id="wizardStep4" class="wizard-step-content" style="display: none;">
        <div style="max-width: 600px; margin: 0 auto; text-align: center;">
            <h2 style="color: #2196F3; font-size: 2.2em; margin-bottom: 15px;">‚úÖ Final Validation</h2>
            <p style="color: #90CAF9; margin-bottom: 40px; font-size: 1.1em;">Confirm your analysis details</p>

            <div style="background: rgba(33, 150, 243, 0.1); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 20px; padding: 30px; margin-bottom: 40px; text-align: left;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(33, 150, 243, 0.3);">
                    <span style="color: #90CAF9;">Trading Pair:</span>
                    <span id="confirmPair" style="color: #00E676; font-weight: 700; font-size: 1.2em;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(33, 150, 243, 0.3);">
                    <span style="color: #90CAF9;">Date:</span>
                    <span id="confirmDate" style="color: #fff; font-weight: 600;"></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #90CAF9;">Timeframes Analyzed:</span>
                    <span id="confirmTimeframes" style="color: #fff; font-weight: 600;"></span>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; color: #90CAF9; margin-bottom: 15px; font-weight: 600; font-size: 1.1em;">Is this an analysis or a trade?</label>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="selectTradeStatus('Analysis Only')" id="btnAnalysisOnly" class="validation-btn" style="flex: 1; max-width: 250px; padding: 20px; background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(33, 150, 243, 0.2)); border: 3px solid #2196F3; border-radius: 15px; color: #fff; font-weight: 700; font-size: 1.1em; cursor: pointer;">
                        üìä Analysis Only
                    </button>
                    <button onclick="selectTradeStatus('Trade Taken')" id="btnTradeTaken" class="validation-btn" style="flex: 1; max-width: 250px; padding: 20px; background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.1)); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 15px; color: #fff; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                        üí∞ Trade Taken
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 40px;">
                <label style="display: block; color: #90CAF9; margin-bottom: 15px; font-weight: 600; font-size: 1.1em;">What's your market bias?</label>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="selectBias('Bullish')" id="btnBullish" class="validation-btn" style="flex: 1; max-width: 160px; padding: 20px; background: linear-gradient(135deg, rgba(0, 230, 118, 0.2), rgba(0, 230, 118, 0.1)); border: 2px solid rgba(0, 230, 118, 0.3); border-radius: 15px; color: #fff; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                        üü¢ Bullish
                    </button>
                    <button onclick="selectBias('Neutral')" id="btnNeutral" class="validation-btn" style="flex: 1; max-width: 160px; padding: 20px; background: linear-gradient(135deg, rgba(144, 202, 249, 0.2), rgba(144, 202, 249, 0.1)); border: 2px solid rgba(144, 202, 249, 0.3); border-radius: 15px; color: #fff; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                        ‚ö™ Neutral
                    </button>
                    <button onclick="selectBias('Bearish')" id="btnBearish" class="validation-btn" style="flex: 1; max-width: 160px; padding: 20px; background: linear-gradient(135deg, rgba(255, 82, 82, 0.2), rgba(255, 82, 82, 0.1)); border: 2px solid rgba(255, 82, 82, 0.3); border-radius: 15px; color: #fff; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                        üî¥ Bearish
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 15px;">
                <button onclick="wizardPrevStep()" class="wizard-btn-secondary">‚Üê Back</button>
                <button onclick="wizardSave()" id="wizardSaveBtn" class="wizard-btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">
                    üíæ Save Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.wizard-step-content {
    padding: 40px 20px;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.pair-select-btn {
    padding: 20px;
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.1));
    border: 2px solid rgba(33, 150, 243, 0.3);
    border-radius: 12px;
    color: #fff;
    font-size: 1.2em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pair-select-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
    border-color: #2196F3;
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(33, 150, 243, 0.2));
}

.wizard-input {
    width: 100%;
    padding: 12px 15px;
    background: rgba(33, 150, 243, 0.1);
    border: 2px solid rgba(33, 150, 243, 0.3);
    border-radius: 10px;
    color: #fff;
    font-size: 1em;
}

.wizard-input:focus {
    outline: none;
    border-color: #2196F3;
    background: rgba(33, 150, 243, 0.15);
}

.wizard-textarea {
    width: 100%;
    min-height: 120px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #fff;
    font-size: 1em;
    font-family: inherit;
    resize: vertical;
}

.wizard-textarea:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.3);
}

.wizard-btn-primary {
    flex: 2;
    padding: 15px 30px;
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1em;
    transition: all 0.3s ease;
}

.wizard-btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(33, 150, 243, 0.5);
}

.wizard-btn-secondary {
    flex: 1;
    padding: 15px 30px;
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1em;
    transition: all 0.3s ease;
}

.wizard-btn-secondary:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
}

.wizard-step.active .step-circle {
    background: linear-gradient(135deg, #2196F3, #1976D2) !important;
    color: #fff !important;
}

.wizard-step.active p {
    color: #2196F3 !important;
    font-weight: 600 !important;
}

.validation-btn.selected {
    border-width: 3px !important;
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
}

.validation-btn:hover {
    transform: translateY(-2px);
}
</style>
        <!-- Edit Page -->
        <div id="editPage" class="page" style="display: none;">
            <div style="max-width: 900px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 id="editPageTitle" style="color: #2196F3; font-size: 2em; margin: 0;">‚úèÔ∏è Edit Analysis</h2>
                    <button onclick="cancelEdit()" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; color: #fff; cursor: pointer; font-weight: 600;">
                        ‚úï Cancel
                    </button>
                </div>

                <!-- Edit Form -->
                <div style="background: rgba(33, 150, 243, 0.05); border: 2px solid rgba(33, 150, 243, 0.2); border-radius: 20px; padding: 30px;">
                    
                    <!-- Pair & Date Info (Read-only display) -->
                    <div style="background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div>
                                <label style="color: #90CAF9; font-size: 0.9em; display: block; margin-bottom: 5px;">Pair</label>
                                <p id="editPairDisplay" style="color: #00E676; font-size: 1.3em; font-weight: 700; margin: 0;"></p>
                            </div>
                            <div>
                                <label style="color: #90CAF9; font-size: 0.9em; display: block; margin-bottom: 5px;">Date</label>
                                <p id="editDateDisplay" style="color: #fff; font-size: 1.1em; font-weight: 600; margin: 0;"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields to preserve original data -->
                    <input type="hidden" id="editMonth">
                    <input type="hidden" id="editDay">
                    <input type="hidden" id="editDate">
                    <input type="hidden" id="editYear">
                    <input type="hidden" id="editPair">

                    <!-- Status Fields -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div>
                            <label style="color: #90CAF9; display: block; margin-bottom: 10px; font-weight: 600;">Trade Status</label>
                            <select id="editTradeStatus" class="wizard-input">
                                <option value="Analysis Only">üìä Analysis Only</option>
                                <option value="Trade Taken">üí∞ Trade Taken</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #90CAF9; display: block; margin-bottom: 10px; font-weight: 600;">Market Bias</label>
                            <select id="editMarketBias" class="wizard-input">
                                <option value="Bullish">üü¢ Bullish</option>
                                <option value="Bearish">üî¥ Bearish</option>
                                <option value="Neutral">‚ö™ Neutral</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #90CAF9; display: block; margin-bottom: 10px; font-weight: 600;">Status</label>
                            <select id="editAnalysisStatus" class="wizard-input">
                                <option value="Active">üü¢ Active</option>
                                <option value="Closed">üî¥ Closed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Analysis Content -->
                    <!-- Weekly -->
                    <div style="background: rgba(255, 149, 0, 0.1); border-left: 4px solid #FF9500; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #FF9500; margin-bottom: 15px;">üìÖ Weekly Timeframe</h3>
                        <textarea id="editWeeklyAnalysis" class="wizard-textarea" placeholder="Weekly analysis..."></textarea>
                        <input type="url" id="editWeeklyPhoto" class="wizard-input" placeholder="Chart link" style="margin-top: 10px;">
                    </div>

                    <!-- Daily -->
                    <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #4CAF50; margin-bottom: 15px;">üìä Daily Timeframe</h3>
                        <textarea id="editDailyAnalysis" class="wizard-textarea" placeholder="Daily analysis..."></textarea>
                        <input type="url" id="editDailyPhoto" class="wizard-input" placeholder="Chart link" style="margin-top: 10px;">
                    </div>

                    <!-- 4H -->
                    <div style="background: rgba(156, 39, 176, 0.1); border-left: 4px solid #9C27B0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #9C27B0; margin-bottom: 15px;">‚è±Ô∏è 4H Timeframe</h3>
                        <textarea id="editFourHAnalysis" class="wizard-textarea" placeholder="4H analysis..."></textarea>
                        <input type="url" id="editFourHPhoto" class="wizard-input" placeholder="Chart link" style="margin-top: 10px;">
                    </div>

                    <!-- 1H -->
                    <div style="background: rgba(0, 188, 212, 0.1); border-left: 4px solid #00BCD4; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="color: #00BCD4; margin-bottom: 15px;">‚ö° 1H Timeframe</h3>
                        <textarea id="editOneHAnalysis" class="wizard-textarea" placeholder="1H analysis..."></textarea>
                        <input type="url" id="editOneHPhoto" class="wizard-input" placeholder="Chart link" style="margin-top: 10px;">
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px;">
                        <button onclick="cancelEdit()" style="flex: 1; padding: 15px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: #fff; cursor: pointer; font-weight: 600; font-size: 1.1em;">
                            ‚Üê Cancel
                        </button>
                        <button id="editSaveBtn" onclick="saveEditOrUpdate()" style="flex: 2; padding: 15px; background: linear-gradient(135deg, #2196F3, #1976D2); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 600; font-size: 1.1em;">
                            üíæ Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- List Page -->
        <div id="listPage" class="page active">
            <!-- Filters -->
            <div class="filter-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #2196F3; margin: 0; font-size: 1.5em;">üîç Filters</h2>
                    <button onclick="resetFilters()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; border: none; padding: 12px 28px; border-radius: 25px; cursor: pointer; font-weight: 600;">üîÑ Reset</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="filterMonth">üìÖ Month</label>
                        <select id="filterMonth" onchange="applyFilters()">
                            <option value="">All months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterDay">üìÜ Day</label>
                        <select id="filterDay" onchange="applyFilters()">
                            <option value="">All days</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterDateFrom">üìÖ Date From</label>
                        <input type="date" id="filterDateFrom" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filterDateTo">üìÖ Date To</label>
                        <input type="date" id="filterDateTo" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filterYear">üìÖ Year</label>
                        <select id="filterYear" onchange="applyFilters()">
                            <option value="">All years</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterPair">üí± Pair</label>
                        <select id="filterPair" onchange="applyFilters()">
                            <option value="">All pairs</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Quick Pair Filters -->
            <div style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.08), rgba(25, 118, 210, 0.03)); backdrop-filter: blur(10px); border: 1px solid rgba(33, 150, 243, 0.25); border-radius: 20px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
                <h3 style="color: #2196F3; margin: 0 0 15px 0; font-size: 1.2em; display: flex; align-items: center; gap: 10px;">
                    <span>‚ö°</span> Quick Pair Filter
                </h3>
                <div id="pairButtonsContainer" style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; cursor: grab; user-select: none; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #2196F3 rgba(33, 150, 243, 0.1);">
                    <!-- Buttons will be inserted here -->
                </div>
            </div>

            <!-- View Mode Toggle -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px;">
                <button id="btnJournalView" class="view-mode-btn active" onclick="switchView('journal')" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);">
                    üìã Journal View
                </button>
                <button id="btnCalendarView" class="view-mode-btn" onclick="switchView('calendar')" style="background: rgba(33, 150, 243, 0.2); color: #2196F3; border: 2px solid rgba(33, 150, 243, 0.4); padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease;">
                    üìÖ Calendar View
                </button>
            </div>

            <!-- Journal View -->
            <!-- Journal View -->
            <div id="journalView" style="display: block;">
                <div class="table-container">
                    <h2 style="margin-bottom: 20px; color: #2196F3;">Analysis History</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Month</th>
                                <th>Day</th>
                                <th>Date</th>
                                <th>Pair</th>
                                <th>Trade</th>
                                <th>Bias</th>
                                <th>Analysis</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="analysisBody">
                            <tr>
                                <td colspan="9" class="no-data">Loading analyses...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Active Analyses Dashboard (above calendar) -->
            <div id="activeDashboard" style="display: none; margin-bottom: 30px;">
                <div style="background: rgba(33, 150, 243, 0.05); border: 2px solid rgba(33, 150, 243, 0.2); border-radius: 20px; padding: 25px;">
                    <h3 style="color: #2196F3; margin: 0 0 20px 0; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                        <span>üìä</span>
                        <span>All Analyses - Latest Updates</span>
                    </h3>
                    <div id="activeDashboardGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                        <!-- Dashboard cards will be generated here -->
                    </div>
                    <div id="activeDashboardEmpty" style="display: none; text-align: center; padding: 40px; color: #90CAF9;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìä</div>
                        <p style="margin: 0; font-size: 1.1em;">No active analyses yet</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.7;">Create your first analysis to see it here</p>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" style="display: none;">
                <div style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(33, 150, 243, 0.2); border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative;">
                    
                    <!-- Calendar Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; flex-wrap: wrap; position: relative; z-index: 100;">
                        <button onclick="changeMonth(-1)" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateX(-3px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.5)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)';">
                            <span style="font-size: 1.2em;">‚óÑ</span> Previous
                        </button>
                        
                        <div style="display: flex; gap: 15px; align-items: center; background: rgba(33, 150, 243, 0.1); padding: 15px 25px; border-radius: 20px; border: 1px solid rgba(33, 150, 243, 0.3); backdrop-filter: blur(10px); flex-wrap: wrap; justify-content: center; position: relative; z-index: 150;">
                            <!-- Month Selector -->
                            <div style="position: relative;">
                                <button id="monthSelectorBtn" onclick="toggleMonthPicker()" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1)); border: 2px solid rgba(33, 150, 243, 0.4); color: #64B5F6; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; min-width: 140px;" onmouseover="this.style.borderColor='#2196F3'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(25, 118, 210, 0.2))';" onmouseout="this.style.borderColor='rgba(33, 150, 243, 0.4)'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1))';">
                                    <span id="selectedMonth">February</span> üìÖ
                                </button>
                                
                                <!-- Month Picker Popup -->
                                <div id="monthPicker" style="display: none; position: absolute; top: 60px; left: 0; background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); border: 2px solid rgba(33, 150, 243, 0.5); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 9999; backdrop-filter: blur(20px); min-width: 300px;">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                        <!-- Months will be inserted here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Year Selector -->
                            <div style="position: relative;">
                                <button id="yearSelectorBtn" onclick="toggleYearPicker()" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1)); border: 2px solid rgba(33, 150, 243, 0.4); color: #64B5F6; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; min-width: 120px;" onmouseover="this.style.borderColor='#2196F3'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(25, 118, 210, 0.2))';" onmouseout="this.style.borderColor='rgba(33, 150, 243, 0.4)'; this.style.background='linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.1))';">
                                    <span id="selectedYear">2026</span> üìÜ
                                </button>
                                
                                <!-- Year Picker Popup -->
                                <div id="yearPicker" style="display: none; position: absolute; top: 60px; left: 0; background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); border: 2px solid rgba(33, 150, 243, 0.5); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 2000; backdrop-filter: blur(20px); min-width: 280px;">
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                        <!-- Years will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="changeMonth(1)" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 12px 24px; border-radius: 15px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateX(3px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.5)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)';">
                            Next <span style="font-size: 1.2em;">‚ñ∫</span>
                        </button>
                    </div>

                <div style="margin-bottom: 20px;">
                    <label style="color: #90CAF9; display: block; margin-bottom: 8px; font-weight: 600;">Filter by Pair:</label>
                    <select id="calendarPairFilter" onchange="filterCalendarByPair()" style="width: 100%; max-width: 300px; background: rgba(255, 255, 255, 0.1); color: #fff; border: 2px solid rgba(33, 150, 243, 0.4); padding: 12px; border-radius: 8px; font-size: 1em; cursor: pointer;">
                        <option value="ALL">üìä All Pairs</option>
                        <option value="EUR/USD">EUR/USD</option>
                        <option value="GBP/USD">GBP/USD</option>
                        <option value="USD/JPY">USD/JPY</option>
                        <option value="USD/CHF">USD/CHF</option>
                        <option value="AUD/USD">AUD/USD</option>
                        <option value="USD/CAD">USD/CAD</option>
                        <option value="NZD/USD">NZD/USD</option>
                        <option value="GBP/JPY">GBP/JPY</option>
                        <option value="EUR/JPY">EUR/JPY</option>
                        <option value="AUD/JPY">AUD/JPY</option>
                        <option value="CHF/JPY">CHF/JPY</option>
                        <option value="CAD/JPY">CAD/JPY</option>
                        <option value="NZD/JPY">NZD/JPY</option>
                        <option value="EUR/AUD">EUR/AUD</option>
                        <option value="EUR/CHF">EUR/CHF</option>
                        <option value="EUR/CAD">EUR/CAD</option>
                        <option value="EUR/NZD">EUR/NZD</option>
                        <option value="EUR/GBP">EUR/GBP</option>
                        <option value="GBP/AUD">GBP/AUD</option>
                        <option value="GBP/CHF">GBP/CHF</option>
                        <option value="GBP/CAD">GBP/CAD</option>
                        <option value="GBP/NZD">GBP/NZD</option>
                        <option value="AUD/CHF">AUD/CHF</option>
                        <option value="AUD/CAD">AUD/CAD</option>
                        <option value="AUD/NZD">AUD/NZD</option>
                        <option value="CAD/CHF">CAD/CHF</option>
                        <option value="NZD/CHF">NZD/CHF</option>
                        <option value="XAU/USD">XAU/USD (Gold)</option>
                        <option value="XAG/USD">XAG/USD (Silver)</option>
                    </select>
                </div>
                    <!-- Calendar Grid -->
                    <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; position: relative; z-index: 1;">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Analyses Modal -->
    <div class="loading-overlay" id="loginModal">
        <div style="background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 20px; max-width: 400px; width: 90%;">
            <h2 style="color: #2196F3; margin-bottom: 25px; text-align: center;">üîê Login</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; margin-bottom: 8px; font-weight: 600;">Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username" style="width: 100%; padding: 12px; border: 2px solid #2196F3; border-radius: 8px; color: #333;">
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display: block; color: #333; margin-bottom: 8px; font-weight: 600;">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid #2196F3; border-radius: 8px; color: #333;" onkeypress="if(event.key==='Enter') attemptLogin()">
            </div>
            <div id="loginError" style="color: #ff4444; margin-bottom: 15px; text-align: center; display: none;"></div>
            <div style="display: flex; gap: 10px;">
                <button onclick="attemptLogin()" style="flex: 1; background: linear-gradient(135deg, #00cc88, #00aa72); color: #fff; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">Login</button>
                <button onclick="closeLoginModal()" style="flex: 1; background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- View Analysis Modal -->
    <div class="loading-overlay" id="viewModal" style="display: none;">
        <div style="background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); padding: 50px; border-radius: 25px; max-width: 95vw; width: 95%; max-height: 95vh; overflow-y: auto; border: 2px solid rgba(33, 150, 243, 0.5); position: relative; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <!-- Back button (top-left) -->
            <button id="backToDayBtn" onclick="backToDayModal()" style="display: none; position: absolute; top: 20px; left: 20px; background: rgba(33, 150, 243, 0.2); color: #2196F3; border: 2px solid #2196F3; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.3em; font-weight: bold; transition: all 0.3s ease; z-index: 10;">‚óÑ</button>
            
            <!-- Close button (top-right) -->
            <button onclick="closeViewModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 2px solid #ff6b6b; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5em; font-weight: bold; transition: all 0.3s ease; z-index: 10;">√ó</button>
            
            <div style="margin-bottom: 30px; padding-right: 50px; padding-left: 50px;">
                <h2 id="viewModalTitle" style="color: #2196F3; margin: 0 0 20px 0; font-size: 2em; text-align: center;">Analysis</h2>
                
                <!-- Analysis Timeline Navigation -->
                <div id="analysisTimeline" style="display: none; margin-top: 20px; padding: 15px; background: rgba(33, 150, 243, 0.05); border-radius: 15px; border: 1px solid rgba(33, 150, 243, 0.2);">
                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <!-- Timeline buttons will be inserted here -->
                    </div>
                </div>
            </div>
            
            <div id="viewModalContent" style="color: #ddd; line-height: 1.8; font-size: 1.05em;">
                <!-- Content will be inserted here -->
            </div>

            <div style="margin-top: 30px; text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="editAnalysisFromModal()" style="background: linear-gradient(135deg, #FF9500, #FF7B00); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);">
                    ‚úèÔ∏è Edit Analysis
                </button>
                <button onclick="updateAnalysisFromModal()" style="background: linear-gradient(135deg, #00E676, #00C853); color: #000; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 700; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4);">
                    üîÑ Update Analysis
                </button>
                <button onclick="printAnalysisFromModal()" style="background: linear-gradient(135deg, #00BCD4, #0097A7); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);">
                    üñ®Ô∏è Print to Word
                </button>
                <button onclick="copyForTradingViewFromModal()" style="background: linear-gradient(135deg, #2962FF, #1E53E5); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(41, 98, 255, 0.4);">
                    üìà Copy for TradingView
                </button>
                <button onclick="shareFromModal()" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);">
                    üìã Copy for Discord
                </button>
                <button onclick="sendToDiscordFromModal()" style="background: linear-gradient(135deg, #5865F2, #4752C4); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);">
                    üöÄ Send to Discord
                </button>
            </div>
        </div>
    </div>

    <!-- Day Analyses Modal -->
    <div class="loading-overlay" id="dayModal" style="display: none;">
        <div style="background: linear-gradient(135deg, rgba(26, 26, 42, 0.98), rgba(15, 30, 58, 0.98)); padding: 50px; border-radius: 25px; max-width: 95vw; width: 95%; max-height: 95vh; overflow-y: auto; border: 2px solid rgba(33, 150, 243, 0.5); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 id="dayModalTitle" style="color: #2196F3; margin: 0; font-size: 2em;">üìÖ Day Analyses</h2>
                <button onclick="closeDayModal()" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 2px solid #ff6b6b; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5em; font-weight: bold; transition: all 0.3s ease;">√ó</button>
            </div>
            
            <div id="dayModalContent" style="display: grid; gap: 20px;">
                <!-- Analyses cards will be inserted here -->
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button onclick="closeDayModal()" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 14px 40px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay active" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div style="color: #2196F3; font-size: 1.3em; font-weight: bold;">Loading...</div>
        </div>
    </div>

    <script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby545E0z1U_T4y7Obgp7jbkhjEM-nTQ14zccKu3_WhAWI93028iGy3JHPHk9XJvU1_5/exec';

// Discord Webhooks per Trading Pair
// Add webhooks for each pair you want to post to Discord
const DISCORD_WEBHOOKS = {
    'EUR/USD': 'https://discord.com/api/webhooks/1471496358472056842/3IOH_SQw6fNtSV3if_-soi2GrPiycjTUq7-Uk8oT91CSXv_uuRgfHlKwvep_iGwPF9Ej',
    'GBP/USD': '', // Add your GBP/USD webhook here
    'XAU/USD': '', // Add your XAU/USD webhook here
    'USD/JPY': '', // Add your USD/JPY webhook here
    'US100': '',   // Add your US100 webhook here
    'GER40': '',   // Add your GER40 webhook here
    // Add more pairs as needed
};

// Default webhook for pairs without dedicated channel
const DEFAULT_DISCORD_WEBHOOK = ''; // Optional: fallback webhook for unconfigured pairs

// Custom Avatar URL - Replace with your image URL
// Upload your image to: https://imgur.com/ or https://imgbb.com/ and paste the DIRECT image link here
const CUSTOM_AVATAR_URL = 'https://i.imgur.com/YOUR_IMAGE_ID.png'; // Replace with your uploaded image URL

const CREDENTIALS = {
    username: 'calexi07',
    password: '101994acs!'
};

let analyses = [];
let filteredAnalyses = [];
let editingIndex = -1;
let isLoggedIn = true; // Always logged in (login system removed)

// Helper function to format date in local timezone (prevents timezone shift bugs)
function formatDateLocal(date) {
    if (!date) return '';
    const d = typeof date === 'string' ? new Date(date) : date;
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// DOM
const formPage = document.getElementById('formPage');
const listPage = document.getElementById('listPage');
const btnForm = document.getElementById('btnForm');
const btnList = document.getElementById('btnList');
// OLD SAVE BUTTON - Now handled by wizard
// const saveBtn = document.getElementById('saveBtn');
const analysisBody = document.getElementById('analysisBody');
const loadingOverlay = document.getElementById('loadingOverlay');

// Show/Hide Loading
function showLoading() {
    loadingOverlay.classList.add('active');
}

function hideLoading() {
    loadingOverlay.classList.remove('active');
}

// Navigation
btnForm.onclick = () => showPage('form');
btnList.onclick = () => {
    showPage('list');
    loadAnalyses();
};

function handlePairChange() {
    const pairSelect = document.getElementById('pair');
    const customPairGroup = document.getElementById('customPairGroup');
    
    if (pairSelect.value === 'Other') {
        customPairGroup.style.display = 'block';
        document.getElementById('customPair').required = true;
    } else {
        customPairGroup.style.display = 'none';
        document.getElementById('customPair').required = false;
        document.getElementById('customPair').value = '';
    }
}

function showPage(page) {
    formPage.classList.toggle('active', page === 'form');
    listPage.classList.toggle('active', page === 'list');
    btnForm.classList.toggle('active', page === 'form');
    btnList.classList.toggle('active', page === 'list');
}

// Login System
function showLoginModal() {
    document.getElementById('loginModal').style.display = 'flex';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').style.display = 'none';
}

function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
}

function attemptLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    if (username === CREDENTIALS.username && password === CREDENTIALS.password) {
        isLoggedIn = true;
        localStorage.setItem('analysisAuth', 'true');
        closeLoginModal();
        updateUIForLogin();
        customAlert('Login successful!', 'Notice', '‚ÑπÔ∏è');
    } else {
        document.getElementById('loginError').textContent = 'Invalid credentials';
        document.getElementById('loginError').style.display = 'block';
    }
}

async function logout() {
    const confirmed = await customConfirm('Are you sure you want to logout?', 'Logout');
    if (confirmed) {
        isLoggedIn = false;
        localStorage.removeItem('analysisAuth');
        updateUIForLogin();
        showPage('list');
    }
}

function updateUIForLogin() {
    // No longer needed - always logged in
    updateTable();
}

function checkAuth() {
    // No longer needed - always logged in
    isLoggedIn = true;
}

// Load Analyses
function loadAnalyses() {
    showLoading();
    fetch(GOOGLE_SCRIPT_URL + '?action=get&sheet=Sheet1')
        .then(r => r.json())
        .then(res => {
            hideLoading();
            // Handle direct array response from Google Apps Script
            let rawData = [];
            if (Array.isArray(res)) {
                rawData = res;
            } else if (res.result === 'success') {
                rawData = res.data || [];
            } else {
                throw new Error(res.message || 'Failed to load data');
            }
            
            // Store ALL versions in allAnalyses (for history)
            window.allAnalyses = rawData;
            
            // Get only LATEST version for each pair (for UI display)
            // Group by pair, then get the one with latest date
            const latestByPair = {};
            rawData.forEach(analysis => {
                const key = analysis.pair;
                if (!latestByPair[key]) {
                    latestByPair[key] = analysis;
                } else {
                    // Compare dates - keep the most recent
                    const existingDate = new Date(latestByPair[key].date || 0);
                    const newDate = new Date(analysis.date || 0);
                    if (newDate >= existingDate) {
                        latestByPair[key] = analysis;
                    }
                }
            });
            
            // Convert to array
            analyses = Object.values(latestByPair);
            
            filteredAnalyses = [...analyses];
            populateFilterDropdowns();
            updateTable();
            
            // Render calendar and dashboard if in calendar view
            if (document.getElementById('calendarView').style.display !== 'none') {
                renderActiveDashboard();
                renderCalendar();
            }
        })
        .catch(err => {
            console.error('Load error:', err);
            hideLoading();
            analysisBody.innerHTML = '<tr><td colspan="9" class="no-data">Loading error. Please check Google Script deployment.</td></tr>';
        });
}

// Filters
function populateFilterDropdowns() {
    const months = [...new Set(analyses.map(a => a.month))].filter(Boolean).sort();
    const monthSelect = document.getElementById('filterMonth');
    monthSelect.innerHTML = '<option value="">All months</option>';
    months.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        monthSelect.appendChild(opt);
    });
    
    const pairs = [...new Set(analyses.map(a => a.pair))].filter(Boolean).sort();
    const pairSelect = document.getElementById('filterPair');
    pairSelect.innerHTML = '<option value="">All pairs</option>';
    pairs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        pairSelect.appendChild(opt);
    });
    
    // Populate pair filter buttons
    populatePairButtons(pairs);
}

let activePairFilter = '';

function populatePairButtons(pairs) {
    const container = document.getElementById('pairButtonsContainer');
    container.innerHTML = '';
    
    // Add "All" button
    const allBtn = document.createElement('button');
    allBtn.className = 'pair-filter-btn active';
    allBtn.textContent = 'üåê All Pairs';
    allBtn.onclick = () => filterByPair('');
    container.appendChild(allBtn);
    
    // Add button for each pair
    pairs.forEach(pair => {
        const btn = document.createElement('button');
        btn.className = 'pair-filter-btn';
        btn.textContent = pair;
        btn.onclick = () => filterByPair(pair);
        container.appendChild(btn);
    });
    
    // Add drag scroll functionality
    setupDragScroll(container);
}

function filterByPair(pair) {
    activePairFilter = pair;
    
    // Update button states
    const buttons = document.querySelectorAll('.pair-filter-btn');
    buttons.forEach(btn => {
        if ((pair === '' && btn.textContent === 'üåê All Pairs') || btn.textContent === pair) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // Update dropdown to match
    document.getElementById('filterPair').value = pair;
    
    // Apply filters
    applyFilters();
}

function setupDragScroll(container) {
    let isDown = false;
    let startX;
    let scrollLeft;
    
    container.addEventListener('mousedown', (e) => {
        isDown = true;
        container.classList.add('grabbing');
        startX = e.pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
    });
    
    container.addEventListener('mouseleave', () => {
        isDown = false;
        container.classList.remove('grabbing');
    });
    
    container.addEventListener('mouseup', () => {
        isDown = false;
        container.classList.remove('grabbing');
    });
    
    container.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - container.offsetLeft;
        const walk = (x - startX) * 2;
        container.scrollLeft = scrollLeft - walk;
    });
    
    // Touch support for mobile
    container.addEventListener('touchstart', (e) => {
        startX = e.touches[0].pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
    });
    
    container.addEventListener('touchmove', (e) => {
        const x = e.touches[0].pageX - container.offsetLeft;
        const walk = (x - startX) * 2;
        container.scrollLeft = scrollLeft - walk;
    });
}

function applyFilters() {
    const month = document.getElementById('filterMonth').value;
    const day = document.getElementById('filterDay').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const year = document.getElementById('filterYear').value;
    const pair = document.getElementById('filterPair').value;
    
    filteredAnalyses = analyses.filter(a => {
        if (month && a.month !== month) return false;
        if (day && a.day !== day) return false;
        if (year && a.year !== year) return false;
        if (pair && a.pair !== pair) return false;
        
        // Date range filter
        if (dateFrom && a.date) {
            const analysisDate = new Date(a.date);
            const fromDate = new Date(dateFrom);
            if (analysisDate < fromDate) return false;
        }
        if (dateTo && a.date) {
            const analysisDate = new Date(a.date);
            const toDate = new Date(dateTo);
            if (analysisDate > toDate) return false;
        }
        
        return true;
    });
    
    updateTable();
}

function resetFilters() {
    document.getElementById('filterMonth').value = '';
    document.getElementById('filterDay').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterYear').value = '';
    document.getElementById('filterPair').value = '';
    filteredAnalyses = [...analyses];
    updateTable();
}

// Table
function updateTable() {
    // Use allAnalyses to show ALL versions (not just latest)
    const tableData = window.allAnalyses || analyses;
    const filtered = tableData; // TODO: apply filters if needed
    
    if (!filtered.length) {
        analysisBody.innerHTML = '<tr><td colspan="9" class="no-data">No analyses yet</td></tr>';
        return;
    }
    
    analysisBody.innerHTML = '';
    
    filtered.forEach((a, i) => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
            <td>${a.year}</td>
            <td>${a.month}</td>
            <td>${a.day}</td>
            <td>${a.date ? new Date(a.date).toLocaleDateString('ro-RO') : '-'}</td>
            <td style="font-weight: 600; color: #64B5F6;">${a.pair}</td>
            <td style="font-weight: 600;">
                ${a.tradeStatus === 'Trade Taken' ? 
                    '<span style="color: #00E676;">üí∞ Trade</span>' : 
                    '<span style="color: #90CAF9;">üìä Analysis</span>'}
            </td>
            <td style="font-weight: 600; font-size: 1.1em;">
                ${a.marketBias === 'Bullish' ? 'üü¢' : a.marketBias === 'Bearish' ? 'üî¥' : '‚ö™'}
                <span style="color: ${a.marketBias === 'Bullish' ? '#00E676' : a.marketBias === 'Bearish' ? '#FF5252' : '#90CAF9'};">
                    ${a.marketBias || 'Neutral'}
                </span>
            </td>
            <td>
                <button onclick="viewAnalysis(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(33, 150, 243, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(33, 150, 243, 0.3)';">
                    üëÅÔ∏è View Analysis
                </button>
            </td>
            <td>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button onclick="printAnalysis(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #00BCD4, #0097A7); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üñ®Ô∏è Print
                    </button>
                    <button onclick="viewTableAnalysis(${i})" style="background: linear-gradient(135deg, #2962FF, #1E53E5); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üìà TV
                    </button>
                    <button onclick="shareToDiscordTable(${i}, event)" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üìã Copy
                    </button>
                    <button onclick="sendToDiscordTable(${i})" style="background: linear-gradient(135deg, #5865F2, #4752C4); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üöÄ Send to Discord
                    </button>
                    ${isLoggedIn ? `
                        <button class="edit-btn" onclick="editTableAnalysis(${i})" style="padding: 6px 12px; border-radius: 8px; font-size: 0.85em;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">‚úèÔ∏è Edit</button>
                        <button onclick="updateTableAnalysis(${i})" style="background: linear-gradient(135deg, #00E676, #00C853); color: #000; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 700; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üîÑ Update</button>
                        <button class="delete-btn" onclick="deleteTableAnalysis(${i})" style="padding: 6px 12px; border-radius: 8px; font-size: 0.85em;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üóëÔ∏è Delete</button>
                    ` : ''}
                </div>
            </td>
        `;
        
        analysisBody.appendChild(tr);
    });
}

// View Analysis Modal
let currentViewIndex = -1;
let returnToDayModal = false;
let lastDayModalData = null;

function viewAnalysis(index) {
    currentViewIndex = index;
    const a = analyses[index];
    
    // Format date
    const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
    
    // Set title with trade status and bias
    const tradeStatusBadge = a.tradeStatus === 'Trade Taken' ? 
        '<span style="background: linear-gradient(135deg, #00E676, #00C853); color: #000; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; margin-left: 10px;">üí∞ Trade</span>' : 
        '<span style="background: linear-gradient(135deg, #64B5F6, #42A5F5); color: #000; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; margin-left: 10px;">üìä Analysis</span>';
    
    const biasBadge = a.marketBias === 'Bullish' ? 
        '<span style="background: linear-gradient(135deg, #00E676, #00C853); color: #000; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; margin-left: 10px;">üü¢ Bullish</span>' : 
        a.marketBias === 'Bearish' ? 
        '<span style="background: linear-gradient(135deg, #FF5252, #E53935); color: #fff; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; margin-left: 10px;">üî¥ Bearish</span>' : 
        '<span style="background: linear-gradient(135deg, #90CAF9, #64B5F6); color: #000; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; margin-left: 10px;">‚ö™ Neutral</span>';
    
    document.getElementById('viewModalTitle').innerHTML = `üìä ${dateStr} - ${a.pair} ${tradeStatusBadge} ${biasBadge}`;
    
    // Build timeline navigation for same pair
    buildAnalysisTimeline(index);
    
    
    // Build content
    let content = '';
    
    // Weekly
    if (a.weeklyAnalysis || a.weeklyPhoto) {
        content += `
            <div style="background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #2196F3; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>üìÖ</span> Weekly Timeframe
                </h3>
                ${a.weeklyAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.weeklyAnalysis}</p>` : ''}
                ${a.weeklyPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.weeklyPhoto}" alt="Weekly Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #2196F3; cursor: pointer;" onclick="window.open('${a.weeklyPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // Daily
    if (a.dailyAnalysis || a.dailyPhoto) {
        content += `
            <div style="background: rgba(77, 159, 255, 0.1); border-left: 4px solid #4d9fff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #4d9fff; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>üìä</span> Daily Timeframe
                </h3>
                ${a.dailyAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.dailyAnalysis}</p>` : ''}
                ${a.dailyPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.dailyPhoto}" alt="Daily Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #4d9fff; cursor: pointer;" onclick="window.open('${a.dailyPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // 4H
    if (a.fourHAnalysis || a.fourHPhoto) {
        content += `
            <div style="background: rgba(156, 39, 176, 0.1); border-left: 4px solid #9c27b0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #9c27b0; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>‚è±Ô∏è</span> 4H Timeframe
                </h3>
                ${a.fourHAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.fourHAnalysis}</p>` : ''}
                ${a.fourHPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.fourHPhoto}" alt="4H Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #9c27b0; cursor: pointer;" onclick="window.open('${a.fourHPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // 1H
    if (a.oneHAnalysis || a.oneHPhoto) {
        content += `
            <div style="background: rgba(0, 204, 136, 0.1); border-left: 4px solid #00cc88; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #00cc88; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                    <span>‚ö°</span> 1H Timeframe
                </h3>
                ${a.oneHAnalysis ? `<p style="margin-bottom: 15px; white-space: pre-wrap;">${a.oneHAnalysis}</p>` : ''}
                ${a.oneHPhoto ? `
                    <div style="margin-top: 15px;">
                        <img src="${a.oneHPhoto}" alt="1H Chart" style="width: 100%; max-width: 100%; border-radius: 10px; border: 2px solid #00cc88; cursor: pointer;" onclick="window.open('${a.oneHPhoto}', '_blank')" title="Click to open in new tab">
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // Close Information (if analysis is closed)
    if (a.analysisStatus === 'Closed' && (a.closeReason || a.closeObservations)) {
        const reasonBadge = a.closeReason === 'Correct' ? 
            '<span style="background: linear-gradient(135deg, #00E676, #00C853); color: #000; padding: 6px 16px; border-radius: 12px; font-size: 1em; font-weight: 700;">‚úÖ Correct</span>' :
            '<span style="background: linear-gradient(135deg, #FF5252, #E53935); color: #fff; padding: 6px 16px; border-radius: 12px; font-size: 1em; font-weight: 700;">‚ùå Incorrect</span>';
        
        content += `
            <div style="background: rgba(255, 82, 82, 0.15); border: 2px solid #FF5252; padding: 25px; border-radius: 15px; margin-top: 20px;">
                <h3 style="color: #FF5252; margin-bottom: 15px; font-size: 1.5em; display: flex; align-items: center; gap: 10px;">
                    <span>üîí</span> Analysis Closed
                </h3>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #90CAF9;">Result:</strong> ${reasonBadge}
                </div>
                ${a.closeObservations ? `
                    <div>
                        <strong style="color: #90CAF9; display: block; margin-bottom: 8px;">Observations:</strong>
                        <p style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">${a.closeObservations}</p>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    if (!content) {
        content = '<p style="text-align: center; color: #888;">No analysis data available</p>';
    }
    
    document.getElementById('viewModalContent').innerHTML = content;
    document.getElementById('viewModal').style.display = 'flex';
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
    currentViewIndex = -1;
}

// Print to Word Document
function printAnalysis(index) {
    const a = analyses[index];
    generateWordDocument(a);
}

function printAnalysisFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        generateWordDocument(a);
    }
}

async function generateWordDocument(analysis) {
    const dateStr = analysis.date ? new Date(analysis.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${analysis.day}, ${analysis.month} ${analysis.year}`;
    
    showLoading();
    
    try {
        // Helper function to convert image URL to base64
        const getImageAsBase64 = async (url) => {
            if (!url) return null;
            try {
                // Use a CORS proxy for external images
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (err) {
                console.error('Error loading image:', err);
                return null;
            }
        };
        
        // Generate QR codes as data URLs (inline base64)
        const generateQRCodeBase64 = async (url) => {
            if (!url) return null;
            try {
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
                const response = await fetch(qrUrl);
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (err) {
                console.error('Error generating QR code:', err);
                return null;
            }
        };
        
        // Fetch all QR codes
        const weeklyQR = analysis.weeklyPhoto ? await generateQRCodeBase64(analysis.weeklyPhoto) : null;
        const dailyQR = analysis.dailyPhoto ? await generateQRCodeBase64(analysis.dailyPhoto) : null;
        const fourHQR = analysis.fourHPhoto ? await generateQRCodeBase64(analysis.fourHPhoto) : null;
        const oneHQR = analysis.oneHPhoto ? await generateQRCodeBase64(analysis.oneHPhoto) : null;
        
        // Create HTML content for Word with embedded base64 images
        let htmlContent = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Market Analysis Report</title>
    <style>
        body {
            font-family: Calibri, Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.6;
            margin: 40px;
        }
        h1 {
            color: #2196F3;
            text-align: center;
            font-size: 24pt;
            border-bottom: 3px solid #2196F3;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #1976D2;
            font-size: 16pt;
            margin-top: 25px;
            margin-bottom: 15px;
            border-left: 4px solid #2196F3;
            padding-left: 10px;
        }
        .metadata {
            background-color: #E3F2FD;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 25px;
        }
        .metadata p {
            margin: 5px 0;
        }
        .metadata strong {
            color: #1976D2;
        }
        .section {
            margin-bottom: 30px;
        }
        .chart-section {
            background-color: #F5F5F5;
            padding: 20px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
        }
        .qr-container {
            margin: 15px auto;
            text-align: center;
        }
        .qr-container img {
            width: 200px;
            height: 200px;
            border: 2px solid #2196F3;
            padding: 5px;
            background: white;
        }
        .qr-label {
            font-size: 10pt;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #E0E0E0;
            text-align: center;
            font-size: 9pt;
            color: #666;
        }
        p {
            text-align: justify;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>üìä MARKET ANALYSIS REPORT</h1>
    
    <div class="metadata">
        <p><strong>üìÖ Date:</strong> ${dateStr}</p>
        <p><strong>üí± Pair:</strong> ${analysis.pair}</p>
        <p><strong>üìÜ Day:</strong> ${analysis.day}, ${analysis.month} ${analysis.year}</p>
    </div>
    
    <div class="section">
        <h2>üìÖ WEEKLY TIMEFRAME ANALYSIS</h2>
        <p>${analysis.weeklyAnalysis || 'No analysis provided'}</p>
        ${weeklyQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${weeklyQR}" alt="Weekly Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view Weekly chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <h2>üìä DAILY TIMEFRAME ANALYSIS</h2>
        <p>${analysis.dailyAnalysis || 'No analysis provided'}</p>
        ${dailyQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${dailyQR}" alt="Daily Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view Daily chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <h2>‚è±Ô∏è 4H TIMEFRAME ANALYSIS</h2>
        <p>${analysis.fourHAnalysis || 'No analysis provided'}</p>
        ${fourHQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${fourHQR}" alt="4H Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view 4H chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <h2>‚ö° 1H TIMEFRAME ANALYSIS</h2>
        <p>${analysis.oneHAnalysis || 'No analysis provided'}</p>
        ${oneHQR ? `
        <div class="chart-section">
            <div class="qr-container">
                <img src="${oneHQR}" alt="1H Chart QR Code" />
                <p class="qr-label">üì± Scan QR code to view 1H chart</p>
            </div>
        </div>
        ` : ''}
    </div>
    
    <div class="footer">
        <p><strong>Generated:</strong> ${new Date().toLocaleString('ro-RO')}</p>
        <p>Market Analysis Journal - Professional Trading Analysis</p>
    </div>
<!-- History Modal -->
<div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; overflow-y: auto; padding: 40px 20px;">
    <div style="max-width: 1000px; margin: 0 auto; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #2196F3, #1976D2); padding: 25px 30px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h2 id="historyModalTitle" style="color: #fff; margin: 0; font-size: 1.8em;">üìä Analysis History</h2>
            <button onclick="closeHistoryModal()" style="background: rgba(255, 255, 255, 0.2); border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5em; display: flex; align-items: center; justify-content: center;">√ó</button>
        </div>
        
        <!-- Content -->
        <div id="historyModalContent" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
            <!-- History items will be inserted here -->
        </div>
    </div>
</div>
</body>
</html>
`;
        
        // Create blob with Word-specific settings
        const blob = new Blob([htmlContent], {
            type: 'application/msword;charset=utf-8'
        });
        
        // Create download link with proper filename
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const filename = `Analysis_${analysis.pair.replace('/', '-')}_${dateStr.replace(/\//g, '-')}.doc`;
        
        // Set download attribute to force .doc extension
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        hideLoading();
        customAlert(' Analysis exported as Word document!\n\nüì± QR codes included - scan with your phone to view charts!', 'Notice', '‚ÑπÔ∏è');
        
    } catch (error) {
        console.error('Error generating Word document:', error);
        hideLoading();
        customAlert(' Error generating Word document. Please try again.', 'Notice', '‚ÑπÔ∏è');
    }
}

// Send to Discord Channel
async function sendToDiscordChannel(index) {
    const a = analyses[index];
    await postToDiscord(a);
}

async function sendToDiscordFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        await postToDiscord(a);
    }
}

function shareFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
        let template = `**üìä ${dateStr} - ${a.pair} Analysis**\n\n`;
        
        if (a.weeklyAnalysis || a.weeklyPhoto) {
            template += `**üìÖ WEEKLY TIMEFRAME**\n`;
            if (a.weeklyAnalysis) template += `${a.weeklyAnalysis}\n`;
            if (a.weeklyPhoto) template += `üì∏ Chart: ${a.weeklyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.dailyAnalysis || a.dailyPhoto) {
            template += `**üìä DAILY TIMEFRAME**\n`;
            if (a.dailyAnalysis) template += `${a.dailyAnalysis}\n`;
            if (a.dailyPhoto) template += `üì∏ Chart: ${a.dailyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.fourHAnalysis || a.fourHPhoto) {
            template += `**‚è±Ô∏è 4H TIMEFRAME**\n`;
            if (a.fourHAnalysis) template += `${a.fourHAnalysis}\n`;
            if (a.fourHPhoto) template += `üì∏ Chart: ${a.fourHPhoto}\n`;
            template += `\n`;
        }
        
        if (a.oneHAnalysis || a.oneHPhoto) {
            template += `**‚ö° 1H TIMEFRAME**\n`;
            if (a.oneHAnalysis) template += `${a.oneHAnalysis}\n`;
            if (a.oneHPhoto) template += `üì∏ Chart: ${a.oneHPhoto}\n`;
        }
        
        navigator.clipboard.writeText(template).then(() => {
            customAlert(' Copied to clipboard! Paste in Discord.', 'Notice', '‚ÑπÔ∏è');
        }).catch(err => {
            customAlert('Copy failed! Please try again.', 'Notice', '‚ÑπÔ∏è');
        });
    }
}

function copyForTradingViewFromModal() {
    if (currentViewIndex >= 0) {
        const a = analyses[currentViewIndex];
        const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
        
        let template = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        template += `üìä ${a.pair} ANALYSIS - ${dateStr}\n`;
        template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        
        if (a.weeklyAnalysis || a.weeklyPhoto) {
            template += `üìÖ WEEKLY TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.weeklyAnalysis) template += `${a.weeklyAnalysis}\n`;
            if (a.weeklyPhoto) template += `\nüì∏ Chart: ${a.weeklyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.dailyAnalysis || a.dailyPhoto) {
            template += `üìä DAILY TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.dailyAnalysis) template += `${a.dailyAnalysis}\n`;
            if (a.dailyPhoto) template += `\nüì∏ Chart: ${a.dailyPhoto}\n`;
            template += `\n`;
        }
        
        if (a.fourHAnalysis || a.fourHPhoto) {
            template += `‚è±Ô∏è 4H TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.fourHAnalysis) template += `${a.fourHAnalysis}\n`;
            if (a.fourHPhoto) template += `\nüì∏ Chart: ${a.fourHPhoto}\n`;
            template += `\n`;
        }
        
        if (a.oneHAnalysis || a.oneHPhoto) {
            template += `‚ö° 1H TIMEFRAME\n`;
            template += `${'‚îÄ'.repeat(50)}\n`;
            if (a.oneHAnalysis) template += `${a.oneHAnalysis}\n`;
            if (a.oneHPhoto) template += `\nüì∏ Chart: ${a.oneHPhoto}\n`;
            template += `\n`;
        }
        
        template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        template += `üí° Analysis by @YourUsername | ${dateStr}\n`;
        template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
        
        navigator.clipboard.writeText(template).then(() => {
            customAlert(' Copied to clipboard! Paste in TradingView comments.', 'Notice', '‚ÑπÔ∏è');
        }).catch(err => {
            customAlert('Copy failed! Please try again.', 'Notice', '‚ÑπÔ∏è');
        });
    }
}

// Share to Discord
function shareToDiscord(index, event) {
    const a = analyses[index];
    
    // Format date
    const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
    
    // Build Discord-formatted template
    let template = `**üìä ${dateStr} - ${a.pair} Analysis**\n\n`;
    
    // Weekly
    if (a.weeklyAnalysis || a.weeklyPhoto) {
        template += `**üìÖ WEEKLY TIMEFRAME**\n`;
        if (a.weeklyAnalysis) {
            template += `${a.weeklyAnalysis}\n`;
        }
        if (a.weeklyPhoto) {
            template += `üì∏ Chart: ${a.weeklyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // Daily
    if (a.dailyAnalysis || a.dailyPhoto) {
        template += `**üìä DAILY TIMEFRAME**\n`;
        if (a.dailyAnalysis) {
            template += `${a.dailyAnalysis}\n`;
        }
        if (a.dailyPhoto) {
            template += `üì∏ Chart: ${a.dailyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 4H
    if (a.fourHAnalysis || a.fourHPhoto) {
        template += `**‚è±Ô∏è 4H TIMEFRAME**\n`;
        if (a.fourHAnalysis) {
            template += `${a.fourHAnalysis}\n`;
        }
        if (a.fourHPhoto) {
            template += `üì∏ Chart: ${a.fourHPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 1H
    if (a.oneHAnalysis || a.oneHPhoto) {
        template += `**‚ö° 1H TIMEFRAME**\n`;
        if (a.oneHAnalysis) {
            template += `${a.oneHAnalysis}\n`;
        }
        if (a.oneHPhoto) {
            template += `üì∏ Chart: ${a.oneHPhoto}\n`;
        }
    }
    
    // Copy to clipboard
    navigator.clipboard.writeText(template).then(() => {
        // Show success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        btn.style.background = 'linear-gradient(135deg, #00cc88, #00aa72)';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'linear-gradient(135deg, #9c27b0, #7b1fa2)';
        }, 2000);
    }).catch(err => {
        customAlert('Copy failed! Please try again.', 'Notice', '‚ÑπÔ∏è');
        console.error(err);
    });
}

// Share to TradingView
function shareToTradingView(index, event) {
    const a = analyses[index];
    
    // Format date
    const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
    
    // Build TradingView-formatted template
    let template = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    template += `üìä ${a.pair} ANALYSIS - ${dateStr}\n`;
    template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    // Weekly
    if (a.weeklyAnalysis || a.weeklyPhoto) {
        template += `üìÖ WEEKLY TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.weeklyAnalysis) {
            template += `${a.weeklyAnalysis}\n`;
        }
        if (a.weeklyPhoto) {
            template += `\nüì∏ Chart: ${a.weeklyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // Daily
    if (a.dailyAnalysis || a.dailyPhoto) {
        template += `üìä DAILY TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.dailyAnalysis) {
            template += `${a.dailyAnalysis}\n`;
        }
        if (a.dailyPhoto) {
            template += `\nüì∏ Chart: ${a.dailyPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 4H
    if (a.fourHAnalysis || a.fourHPhoto) {
        template += `‚è±Ô∏è 4H TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.fourHAnalysis) {
            template += `${a.fourHAnalysis}\n`;
        }
        if (a.fourHPhoto) {
            template += `\nüì∏ Chart: ${a.fourHPhoto}\n`;
        }
        template += `\n`;
    }
    
    // 1H
    if (a.oneHAnalysis || a.oneHPhoto) {
        template += `‚ö° 1H TIMEFRAME\n`;
        template += `${'‚îÄ'.repeat(50)}\n`;
        if (a.oneHAnalysis) {
            template += `${a.oneHAnalysis}\n`;
        }
        if (a.oneHPhoto) {
            template += `\nüì∏ Chart: ${a.oneHPhoto}\n`;
        }
        template += `\n`;
    }
    
    template += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(template).then(() => {
        // Show success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        btn.style.background = 'linear-gradient(135deg, #00cc88, #00aa72)';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'linear-gradient(135deg, #2962FF, #1E53E5)';
        }, 2000);
    }).catch(err => {
        customAlert('Copy failed! Please try again.', 'Notice', '‚ÑπÔ∏è');
        console.error(err);
    });
}

// OLD SAVE HANDLER - Now handled by wizardSave()
/*
saveBtn.onclick = () => {
    const analysis = getFormData();
    if (!analysis) return;
    
    if (editingIndex >= 0 && analyses[editingIndex]?.id) {
        analysis.id = analyses[editingIndex].id;
        updateAnalysis(analysis);
    } else {
        addAnalysis(analysis);
    }
};
*/

function getFormData() {
    const required = ['month', 'day', 'date', 'year', 'pair'];
    for (const id of required) {
        if (!document.getElementById(id).value) {
            customAlert('Please fill Month, Day, Date, Year, and Pair', 'Notice', '‚ÑπÔ∏è');
            return null;
        }
    }
    
    // Get pair value (handle "Other" option)
    let pairValue = document.getElementById('pair').value;
    if (pairValue === 'Other') {
        pairValue = document.getElementById('customPair').value;
        if (!pairValue || pairValue.trim() === '') {
            customAlert('Please enter a custom pair', 'Notice', '‚ÑπÔ∏è');
            return null;
        }
    }
    
    // Get date value WITHOUT timezone conversion
    const dateInput = document.getElementById('date').value; // Already in YYYY-MM-DD format
    
    return {
        month: document.getElementById('month').value,
        day: document.getElementById('day').value,
        date: dateInput, // Save as YYYY-MM-DD without time
        year: document.getElementById('year').value,
        pair: pairValue,
        tradeStatus: document.getElementById('tradeStatus').value,
        marketBias: document.getElementById('marketBias').value,
        analysisStatus: document.getElementById('analysisStatus').value,
        weeklyAnalysis: document.getElementById('weeklyAnalysis').value,
        weeklyPhoto: document.getElementById('weeklyPhoto').value,
        dailyAnalysis: document.getElementById('dailyAnalysis').value,
        dailyPhoto: document.getElementById('dailyPhoto').value,
        fourHAnalysis: document.getElementById('fourHAnalysis').value,
        fourHPhoto: document.getElementById('fourHPhoto').value,
        oneHAnalysis: document.getElementById('oneHAnalysis').value,
        oneHPhoto: document.getElementById('oneHPhoto').value
    };
}

function addAnalysis(analysis) {
    showLoading();
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: 'add',
            ...analysis
        })
    })
        .then(r => r.json())
        .then(() => {
            hideLoading();
            customAlert('Analysis added successfully!', 'Success', '‚úÖ');
            clearForm();
            showPage('list');
            loadAnalyses();
        })
        .catch(err => {
            console.error('Add error:', err);
            hideLoading();
            customAlert('Save error', 'Notice', '‚ÑπÔ∏è');
        });
}

function updateAnalysis(analysis) {
    showLoading();
    const qs = new URLSearchParams({ action: 'update', ...analysis });
    fetch(GOOGLE_SCRIPT_URL + '?' + qs)
        .then(() => {
            hideLoading();
            editingIndex = -1;
            clearForm();
            showPage('list');
            loadAnalyses();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            customAlert('Update error', 'Notice', '‚ÑπÔ∏è');
        });
}

function editAnalysis(i) {
    // Open dedicated edit page in EDIT mode (keeps original date)
    openEditPageForEdit(i);
}

function editAnalysisFromModal() {
    if (currentViewIndex >= 0 && currentViewIndex < analyses.length) {
        closeViewModal();
        editAnalysis(currentViewIndex);
    } else {
        console.error('Invalid currentViewIndex:', currentViewIndex, 'analyses length:', analyses.length);
        customAlert('Error: Cannot edit this analysis. Please try again from the table.', 'Notice', '‚ÑπÔ∏è');
        closeViewModal();
    }
}

function editAnalysisFromDayModal(index) {
    closeDayModal();
    editAnalysis(index);
}

async function deleteAnalysis(i) {
    const confirmed = await customConfirm('Delete this analysis?', 'Confirm Delete');
    if (!confirmed) return;
    
    const a = analyses[i];
    if (!a) {
        customAlert('Analysis not found', 'Error', '‚ùå');
        return;
    }
    
    console.log('Deleting analysis:', {
        deleteId: a.deleteId,
        pair: a.pair,
        date: a.date
    });
    
    if (!a.deleteId) {
        customAlert('Cannot delete: missing deleteId. Please refresh and try again.', 'Error', '‚ùå');
        return;
    }
    
    showLoading();
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: 'delete',
            deleteId: a.deleteId // ONLY identifier needed!
        })
    })
        .then(r => r.json())
        .then(response => {
            hideLoading();
            console.log('Delete response:', response);
            
            if (response.success) {
                customAlert('Analysis deleted successfully!', 'Deleted', '‚úÖ');
                loadAnalyses();
            } else {
                customAlert(`Delete failed: ${response.message || 'Row not found in sheet'}\n\nPlease refresh and try again.`, 'Error', '‚ùå');
            }
        })
        .catch(err => {
            console.error('Delete error:', err);
            hideLoading();
            customAlert(' Delete error. Please try again.', 'Notice', '‚ÑπÔ∏è');
        });
}

function clearForm() {
    // Clear old form fields if they exist
    ['month', 'day', 'date', 'year', 'pair', 'weeklyAnalysis', 'weeklyPhoto',
     'dailyAnalysis', 'dailyPhoto', 'fourHAnalysis', 'fourHPhoto',
     'oneHAnalysis', 'oneHPhoto'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    
    // Reset selects to defaults (if they exist)
    const tradeStatus = document.getElementById('tradeStatus');
    const marketBias = document.getElementById('marketBias');
    const analysisStatus = document.getElementById('analysisStatus');
    
    if (tradeStatus) tradeStatus.value = 'Analysis Only';
    if (marketBias) marketBias.value = 'Bullish';
    if (analysisStatus) analysisStatus.value = 'Active';
    
    // Hide custom pair input (if exists)
    const customPairGroup = document.getElementById('customPairGroup');
    const customPair = document.getElementById('customPair');
    
    if (customPairGroup) customPairGroup.style.display = 'none';
    if (customPair) customPair.value = '';
    
    editingIndex = -1;
}

// View Mode Switch
function switchView(mode) {
    const journalView = document.getElementById('journalView');
    const calendarView = document.getElementById('calendarView');
    const activeDashboard = document.getElementById('activeDashboard');
    const btnJournal = document.getElementById('btnJournalView');
    const btnCalendar = document.getElementById('btnCalendarView');
    
    // Get filter sections
    const filterSections = document.querySelectorAll('.filter-section, #pairButtonsContainer').length > 0 
        ? Array.from(document.querySelectorAll('.filter-section')).concat([document.getElementById('pairButtonsContainer').parentElement])
        : [];
    
    if (mode === 'journal') {
        journalView.style.display = 'block';
        calendarView.style.display = 'none';
        activeDashboard.style.display = 'none';
        
        // Show only Calendar button when on Journal
        btnJournal.style.display = 'none';
        btnCalendar.style.display = 'inline-block';
        btnCalendar.innerHTML = 'üìÖ Switch to Calendar';
        
        // Show filters
        filterSections.forEach(section => {
            if (section) section.style.display = 'block';
        });
    } else {
        journalView.style.display = 'none';
        calendarView.style.display = 'block';
        activeDashboard.style.display = 'block';
        
        // Show only Journal button when on Calendar
        btnCalendar.style.display = 'none';
        btnJournal.style.display = 'inline-block';
        btnJournal.innerHTML = 'üìä Switch to Table';
        
        // Hide filters
        filterSections.forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        renderActiveDashboard();
        renderCalendar();
    }
}

// Calendar Functions
let currentSelectedDate = null;
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

// Initialize month and year pickers
function initializeMonthYearPickers() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Build month picker
    const monthPicker = document.getElementById('monthPicker').querySelector('div');
    monthPicker.innerHTML = '';
    monthNames.forEach((month, index) => {
        const btn = document.createElement('button');
        btn.textContent = month.substring(0, 3);
        btn.onclick = () => selectMonth(index);
        btn.style.cssText = `
            background: ${index === currentCalendarMonth ? 'linear-gradient(135deg, #2196F3, #1976D2)' : 'rgba(33, 150, 243, 0.1)'};
            color: ${index === currentCalendarMonth ? '#fff' : '#64B5F6'};
            border: 1px solid ${index === currentCalendarMonth ? '#2196F3' : 'rgba(33, 150, 243, 0.3)'};
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        `;
        btn.onmouseover = () => {
            if (index !== currentCalendarMonth) {
                btn.style.background = 'rgba(33, 150, 243, 0.3)';
                btn.style.transform = 'scale(1.05)';
            }
        };
        btn.onmouseout = () => {
            if (index !== currentCalendarMonth) {
                btn.style.background = 'rgba(33, 150, 243, 0.1)';
                btn.style.transform = 'scale(1)';
            }
        };
        monthPicker.appendChild(btn);
    });
    
    // Build year picker (current year ¬± 5 years)
    const yearPicker = document.getElementById('yearPicker').querySelector('div');
    yearPicker.innerHTML = '';
    const startYear = currentCalendarYear - 5;
    for (let i = 0; i < 12; i++) {
        const year = startYear + i;
        const btn = document.createElement('button');
        btn.textContent = year;
        btn.onclick = () => selectYear(year);
        btn.style.cssText = `
            background: ${year === currentCalendarYear ? 'linear-gradient(135deg, #2196F3, #1976D2)' : 'rgba(33, 150, 243, 0.1)'};
            color: ${year === currentCalendarYear ? '#fff' : '#64B5F6'};
            border: 1px solid ${year === currentCalendarYear ? '#2196F3' : 'rgba(33, 150, 243, 0.3)'};
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        `;
        btn.onmouseover = () => {
            if (year !== currentCalendarYear) {
                btn.style.background = 'rgba(33, 150, 243, 0.3)';
                btn.style.transform = 'scale(1.05)';
            }
        };
        btn.onmouseout = () => {
            if (year !== currentCalendarYear) {
                btn.style.background = 'rgba(33, 150, 243, 0.1)';
                btn.style.transform = 'scale(1)';
            }
        };
        yearPicker.appendChild(btn);
    }
}

function toggleMonthPicker() {
    const picker = document.getElementById('monthPicker');
    const yearPicker = document.getElementById('yearPicker');
    yearPicker.style.display = 'none';
    
    if (picker.style.display === 'none') {
        initializeMonthYearPickers();
        picker.style.display = 'block';
    } else {
        picker.style.display = 'none';
    }
}

function toggleYearPicker() {
    const picker = document.getElementById('yearPicker');
    const monthPicker = document.getElementById('monthPicker');
    monthPicker.style.display = 'none';
    
    if (picker.style.display === 'none') {
        initializeMonthYearPickers();
        picker.style.display = 'block';
    } else {
        picker.style.display = 'none';
    }
}

function selectMonth(month) {
    currentCalendarMonth = month;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('selectedMonth').textContent = monthNames[month];
    document.getElementById('monthPicker').style.display = 'none';
    renderCalendar();
}

function selectYear(year) {
    currentCalendarYear = year;
    document.getElementById('selectedYear').textContent = year;
    document.getElementById('yearPicker').style.display = 'none';
    renderCalendar();
}

// Close pickers when clicking outside
document.addEventListener('click', function(event) {
    const monthBtn = document.getElementById('monthSelectorBtn');
    const yearBtn = document.getElementById('yearSelectorBtn');
    const monthPicker = document.getElementById('monthPicker');
    const yearPicker = document.getElementById('yearPicker');
    
    if (monthPicker && !monthBtn?.contains(event.target) && !monthPicker.contains(event.target)) {
        monthPicker.style.display = 'none';
    }
    if (yearPicker && !yearBtn?.contains(event.target) && !yearPicker.contains(event.target)) {
        yearPicker.style.display = 'none';
    }
});

function changeMonth(delta) {
    currentCalendarMonth += delta;
    
    if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    } else if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    }
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('selectedMonth').textContent = monthNames[currentCalendarMonth];
    document.getElementById('selectedYear').textContent = currentCalendarYear;
    
    renderCalendar();
}

function renderCalendar() {
    const month = currentCalendarMonth;
    const year = currentCalendarYear;
    const grid = document.getElementById('calendarGrid');
    
    console.log('Rendering calendar for:', month, year);
    console.log('Total analyses:', analyses.length);
    console.log('Sample analysis:', analyses[0]);
    
    grid.innerHTML = '';
    
    // Add day headers
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    days.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Get first day of month
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    // Adjust first day (make Monday = 0)
    const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
    
    // Add previous month's days
    for (let i = adjustedFirstDay - 1; i >= 0; i--) {
        const dayDiv = createDayCell(daysInPrevMonth - i, month - 1, year, true);
        grid.appendChild(dayDiv);
    }
    
    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = createDayCell(day, month, year, false);
        grid.appendChild(dayDiv);
    }
    
    // Add next month's days to fill grid
    const totalCells = grid.children.length - 7;
    const remainingCells = 42 - totalCells - 7;
    for (let day = 1; day <= remainingCells; day++) {
        const dayDiv = createDayCell(day, month + 1, year, true);
        grid.appendChild(dayDiv);
    }
}

function createDayCell(day, month, year, isOtherMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    dayDiv.style.position = 'relative'; // Enable absolute positioning for badges
    
    if (isOtherMonth) {
        dayDiv.classList.add('other-month');
    }
    
    // Adjust month for proper date creation
    let actualMonth = month;
    let actualYear = year;
    if (month < 0) {
        actualMonth = 11;
        actualYear = year - 1;
    } else if (month > 11) {
        actualMonth = 0;
        actualYear = year + 1;
    }
    
    const dateStr = `${actualYear}-${String(actualMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    // Use allAnalyses to count ALL versions for this day (not just latest)
    const allData = window.allAnalyses || analyses;
    let analysesForDay = allData.filter(a => {
        if (!a.date) return false;
        
        // Parse the ISO date string and format it in local timezone (not UTC)
        const date = new Date(a.date);
        const localDateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        return localDateStr === dateStr;
    });
    
    // Apply pair filter if not ALL
    if (calendarFilterPair !== 'ALL') {
        analysesForDay = analysesForDay.filter(a => a.pair === calendarFilterPair);
    }
    
    if (day === 11 && !isOtherMonth) {
        console.log('Day 11 - dateStr:', dateStr, 'analyses:', analysesForDay.length);
        if (analyses.length > 0 && analyses[0].date) {
            const testDate = new Date(analyses[0].date);
            console.log('Test analysis date:', analyses[0].date, '-> local:', testDate.getDate(), testDate.getMonth() + 1, testDate.getFullYear());
        }
    }
    
    if (analysesForDay.length > 0 && !isOtherMonth) {
        dayDiv.classList.add('has-analysis');
    }
    
    // Check if selected
    if (currentSelectedDate === dateStr && !isOtherMonth) {
        dayDiv.classList.add('selected');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'calendar-day-number';
    dayNumber.textContent = day;
    dayDiv.appendChild(dayNumber);
    
    // Add visual status badges (top-right corner overlay)
    if (analysesForDay.length > 0 && !isOtherMonth) {
        // Group by pair and count versions
        const pairGroups = {};
        analysesForDay.forEach(a => {
            if (!pairGroups[a.pair]) {
                pairGroups[a.pair] = [];
            }
            pairGroups[a.pair].push(a);
        });
        
        // Create badge container (top-right corner)
        const badgeContainer = document.createElement('div');
        badgeContainer.style.cssText = 'position: absolute; top: 3px; right: 3px; display: flex; flex-direction: column; gap: 2px; align-items: flex-end; pointer-events: none;';
        
        // Display badge for each pair
        Object.keys(pairGroups).forEach(pair => {
            const versionsThisDay = pairGroups[pair];
            const latest = versionsThisDay[versionsThisDay.length - 1];
            
            // Check in ALL analyses if this is the FIRST version for this pair
            const allData = window.allAnalyses || analyses;
            const allVersionsForPair = allData.filter(a => a.pair === pair).sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });
            
            const firstVersionDate = allVersionsForPair[0]?.date;
            const currentDate = latest.date;
            const isFirstVersion = firstVersionDate === currentDate;
            
            let badgeColor, badgeText;
            
            if (latest.analysisStatus === 'Closed') {
                badgeColor = '#FF5252'; // Red
                badgeText = 'CLOSED';
            } else if (isFirstVersion) {
                badgeColor = '#00E676'; // Green (New/First)
                badgeText = 'NEW';
            } else {
                // It's an update - count which update number
                const versionIndex = allVersionsForPair.findIndex(a => a.date === currentDate);
                badgeColor = '#FFB300'; // Orange (Updated)
                badgeText = versionIndex > 0 ? `UPD ${versionIndex}` : 'UPD';
            }
            
            const badge = document.createElement('div');
            badge.style.cssText = `
                background: ${badgeColor};
                color: #000;
                font-size: 0.55em;
                font-weight: 700;
                padding: 2px 5px;
                border-radius: 4px;
                line-height: 1;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                white-space: nowrap;
            `;
            badge.textContent = badgeText;
            badgeContainer.appendChild(badge);
        });
        
        dayDiv.appendChild(badgeContainer);
        
        // Also add pairs list at bottom
        const pairsContainer = document.createElement('div');
        pairsContainer.className = 'calendar-day-pairs';
        
        Object.keys(pairGroups).forEach(pair => {
            const pairBullet = document.createElement('div');
            pairBullet.className = 'calendar-pair-bullet';
            pairBullet.textContent = pair;
            pairsContainer.appendChild(pairBullet);
        });
        
        dayDiv.appendChild(pairsContainer);
    }
    
    if (!isOtherMonth) {
        dayDiv.onclick = (e) => {
            console.log('Clicked day:', day, 'dateStr:', dateStr, 'analyses:', analysesForDay.length);
            showAnalysesForDay(dateStr, day, actualMonth, actualYear);
        };
    }
    
    return dayDiv;
}

function showAnalysesForDay(dateStr, day, month, year) {
    currentSelectedDate = dateStr;
    renderCalendar();
    
    // Use allAnalyses to show ALL versions (not just latest)
    const allData = window.allAnalyses || analyses;
    
    // Filter analyses by date - parse in local timezone
    const analysesForDay = allData.filter(a => {
        if (!a.date) return false;
        const date = new Date(a.date);
        const localDateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        return localDateStr === dateStr;
    });
    
    // Sort by pair first, then by date (chronological order for same pair)
    analysesForDay.sort((a, b) => {
        if (a.pair !== b.pair) {
            return a.pair.localeCompare(b.pair);
        }
        return new Date(a.date) - new Date(b.date);
    });
    
    console.log('showAnalysesForDay - dateStr:', dateStr, 'found:', analysesForDay.length, 'versions');
    
    if (analysesForDay.length === 0) {
        return;
    }
    
    // Store modal data for back button
    lastDayModalData = { dateStr, day, month, year };
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Set modal title
    document.getElementById('dayModalTitle').textContent = `üìÖ ${day} ${monthNames[month]} ${year} - ${analysesForDay.length} ${analysesForDay.length === 1 ? 'Analysis' : 'Analyses'}`;
    
    // Build content
    const content = document.getElementById('dayModalContent');
    content.innerHTML = '';
    
    // Track versions per pair
    const pairVersions = {};
    
    analysesForDay.forEach((a, index) => {
        // Calculate version label for this pair
        if (!pairVersions[a.pair]) {
            pairVersions[a.pair] = 0;
        }
        pairVersions[a.pair]++;
        
        const versionNumber = pairVersions[a.pair];
        const totalVersionsForPair = analysesForDay.filter(x => x.pair === a.pair).length;
        
        let versionLabel = '';
        if (a.analysisStatus === 'Closed') {
            versionLabel = 'üî¥ CLOSED';
        } else if (versionNumber === 1 && totalVersionsForPair === 1) {
            versionLabel = 'üü¢ ACTIVE';
        } else if (versionNumber === totalVersionsForPair) {
            versionLabel = `üü¢ UPDATE ${versionNumber - 1}`;
        } else {
            versionLabel = versionNumber === 1 ? 'üìù Initial' : `üìù Update ${versionNumber - 1}`;
        }
        
        const card = document.createElement('div');
        card.style.cssText = 'background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(25, 118, 210, 0.05)); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 15px; padding: 25px; margin-bottom: 15px; transition: all 0.3s ease; cursor: pointer;';
        
        card.onmouseover = () => {
            card.style.borderColor = '#2196F3';
            card.style.boxShadow = '0 4px 20px rgba(33, 150, 243, 0.3)';
        };
        card.onmouseout = () => {
            card.style.borderColor = 'rgba(33, 150, 243, 0.3)';
            card.style.boxShadow = 'none';
        };
        
        // Find this analysis in the main analyses array for index
        const mainIndex = analyses.findIndex(an => 
            an.pair === a.pair && 
            an.date === a.date && 
            an.weeklyAnalysis === a.weeklyAnalysis
        );
        const useIndex = mainIndex >= 0 ? mainIndex : index;
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <h3 style="color: #2196F3; margin: 0; font-size: 1.8em;">${a.pair}</h3>
                        <span style="background: ${a.analysisStatus === 'Closed' ? 'linear-gradient(135deg, #FF5252, #E53935)' : 'linear-gradient(135deg, #00E676, #00C853)'}; color: ${a.analysisStatus === 'Closed' ? '#fff' : '#000'}; padding: 6px 14px; border-radius: 12px; font-size: 0.75em; font-weight: 700; white-space: nowrap;">${versionLabel}</span>
                        <span style="background: ${a.marketBias === 'Bullish' ? 'rgba(0, 230, 118, 0.2)' : a.marketBias === 'Bearish' ? 'rgba(255, 82, 82, 0.2)' : 'rgba(144, 202, 249, 0.2)'}; color: ${a.marketBias === 'Bullish' ? '#00E676' : a.marketBias === 'Bearish' ? '#FF5252' : '#90CAF9'}; padding: 6px 14px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">${a.marketBias === 'Bullish' ? 'üü¢' : a.marketBias === 'Bearish' ? 'üî¥' : '‚ö™'} ${a.marketBias}</span>
                    </div>
                    <p style="color: #aaa; margin: 0; font-size: 0.9em;">${a.day}, ${a.month} ${a.year}</p>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="event.stopPropagation(); viewAnalysisFromDay(${useIndex})" style="background: linear-gradient(135deg, #4d9fff, #3d7fff); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üëÅÔ∏è View Full
                    </button>
                    <button onclick="event.stopPropagation(); editAnalysisFromDayModal(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #FF9500, #FF7B00); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        ‚úèÔ∏è Edit
                    </button>
                    <button onclick="event.stopPropagation(); updateAnalysisFromDayModal(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #00E676, #00C853); color: #000; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 700; transition: all 0.3s ease;">
                        üîÑ Update
                    </button>
                    <button onclick="event.stopPropagation(); printAnalysis(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #00BCD4, #0097A7); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üñ®Ô∏è Print
                    </button>
                    <button onclick="event.stopPropagation(); shareToTradingView(${analyses.indexOf(a)}, event)" style="background: linear-gradient(135deg, #2962FF, #1E53E5); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üìà TV
                    </button>
                    <button onclick="event.stopPropagation(); shareToDiscord(${analyses.indexOf(a)}, event)" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üìã Copy
                    </button>
                    <button onclick="event.stopPropagation(); sendToDiscordChannel(${analyses.indexOf(a)})" style="background: linear-gradient(135deg, #5865F2, #4752C4); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease;">
                        üöÄ Send to Discord
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                ${a.weeklyAnalysis ? `
                    <div style="background: rgba(33, 150, 243, 0.05); border-left: 3px solid #2196F3; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #2196F3; margin: 0 0 10px 0; font-size: 1em;">üìÖ WEEKLY</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.weeklyAnalysis.substring(0, 150)}${a.weeklyAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.weeklyPhoto ? `<a href="${a.weeklyPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
                ${a.dailyAnalysis ? `
                    <div style="background: rgba(77, 159, 255, 0.05); border-left: 3px solid #4d9fff; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #4d9fff; margin: 0 0 10px 0; font-size: 1em;">üìä DAILY</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.dailyAnalysis.substring(0, 150)}${a.dailyAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.dailyPhoto ? `<a href="${a.dailyPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
                ${a.fourHAnalysis ? `
                    <div style="background: rgba(156, 39, 176, 0.05); border-left: 3px solid #9c27b0; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #9c27b0; margin: 0 0 10px 0; font-size: 1em;">‚è±Ô∏è 4H</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.fourHAnalysis.substring(0, 150)}${a.fourHAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.fourHPhoto ? `<a href="${a.fourHPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
                ${a.oneHAnalysis ? `
                    <div style="background: rgba(0, 204, 136, 0.05); border-left: 3px solid #00cc88; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #00cc88; margin: 0 0 10px 0; font-size: 1em;">‚ö° 1H</h4>
                        <p style="color: #ddd; margin: 0; font-size: 0.9em; line-height: 1.6;">${a.oneHAnalysis.substring(0, 150)}${a.oneHAnalysis.length > 150 ? '...' : ''}</p>
                        ${a.oneHPhoto ? `<a href="${a.oneHPhoto}" target="_blank" style="color: #4d9fff; text-decoration: none; font-size: 0.85em; margin-top: 8px; display: inline-block;">üì∏ View Chart</a>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
        
        // Make card clickable to view full analysis
        card.onclick = () => {
            viewAnalysisFromDay(analyses.indexOf(a));
        };
        
        content.appendChild(card);
    });
    
    // Show modal
    document.getElementById('dayModal').style.display = 'flex';
}

function buildAnalysisTimeline(currentIndex) {
    const currentAnalysis = analyses[currentIndex];
    const timeline = document.getElementById('analysisTimeline');
    
    // Find all analyses for the same pair, sorted by date
    const samePairAnalyses = analyses
        .map((a, idx) => ({ ...a, originalIndex: idx }))
        .filter(a => a.pair === currentAnalysis.pair && a.date)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    if (samePairAnalyses.length <= 1) {
        timeline.style.display = 'none';
        return;
    }
    
    // Find current position in sorted list
    const currentPos = samePairAnalyses.findIndex(a => a.originalIndex === currentIndex);
    
    // Build timeline HTML
    let timelineHTML = '<div style="color: #90CAF9; font-size: 0.9em; margin-bottom: 10px; text-align: center; font-weight: 600;">üìä ' + currentAnalysis.pair + ' Analysis Timeline</div>';
    timelineHTML += '<div style="display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">';
    
    samePairAnalyses.forEach((a, idx) => {
        const date = new Date(a.date);
        const dateLabel = date.toLocaleDateString('ro-RO', { day: 'numeric', month: 'short' });
        const isCurrent = idx === currentPos;
        const isPast = idx < currentPos;
        const isFuture = idx > currentPos;
        
        let buttonStyle = '';
        let icon = '';
        
        if (isCurrent) {
            buttonStyle = 'background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: 2px solid #64B5F6; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);';
            icon = 'üìç';
        } else if (isPast) {
            buttonStyle = 'background: rgba(100, 181, 246, 0.15); color: #64B5F6; border: 1px solid rgba(100, 181, 246, 0.3);';
            icon = '‚óÑ';
        } else {
            buttonStyle = 'background: rgba(0, 188, 212, 0.15); color: #00BCD4; border: 1px solid rgba(0, 188, 212, 0.3);';
            icon = '‚ñ∫';
        }
        
        timelineHTML += `
            <button 
                onclick="viewAnalysis(${a.originalIndex})" 
                style="${buttonStyle} padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease; white-space: nowrap;"
                onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.4)';"
                onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='${isCurrent ? '0 4px 15px rgba(33, 150, 243, 0.5)' : 'none'}';"
            >
                ${icon} ${dateLabel}
            </button>
        `;
        
        // Add arrow between buttons (except after last)
        if (idx < samePairAnalyses.length - 1) {
            timelineHTML += '<span style="color: rgba(33, 150, 243, 0.3); font-size: 1.2em;">‚Üí</span>';
        }
    });
    
    timelineHTML += '</div>';
    
    timeline.innerHTML = timelineHTML;
    timeline.style.display = 'block';
}

function viewAnalysisFromDay(index) {
    returnToDayModal = true;
    closeDayModal();
    viewAnalysis(index);
    // Show back button
    document.getElementById('backToDayBtn').style.display = 'inline-block';
}

function backToDayModal() {
    closeViewModal();
    if (lastDayModalData) {
        showAnalysesForDay(lastDayModalData.dateStr, lastDayModalData.day, lastDayModalData.month, lastDayModalData.year);
    }
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
    document.getElementById('backToDayBtn').style.display = 'none';
    returnToDayModal = false;
    currentViewIndex = -1;
}

function closeDayModal() {
    document.getElementById('dayModal').style.display = 'none';
    if (!returnToDayModal) {
        lastDayModalData = null;
    }
}

// Init
window.onload = () => {
    checkAuth();
    loadAnalyses();
    
    // Set calendar to current month/year
    const now = new Date();
    currentCalendarMonth = now.getMonth();
    currentCalendarYear = now.getFullYear();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('selectedMonth').textContent = monthNames[currentCalendarMonth];
    document.getElementById('selectedYear').textContent = currentCalendarYear;
    
    // Set Calendar View as default
    switchView('calendar');
};

// ============================================
// WIZARD JAVASCRIPT
// ============================================

// ============================================
// WIZARD JAVASCRIPT - Add to <script> section
// ============================================

// Wizard state
let wizardData = {
    pair: '',
    month: '',
    day: '',
    date: '',
    year: '',
    tradeStatus: '',
    marketBias: '',
    analysisStatus: 'Active',
    weeklyAnalysis: '',
    weeklyPhoto: '',
    dailyAnalysis: '',
    dailyPhoto: '',
    fourHAnalysis: '',
    fourHPhoto: '',
    oneHAnalysis: '',
    oneHPhoto: ''
};

let currentWizardStep = 1;

// Step 1: Select Pair
async function selectPair(pair) {
    // Check if pair has active analysis
    const existingAnalysis = analyses.find(a => a.pair === pair && a.analysisStatus === 'Active');
    
    if (existingAnalysis) {
        const confirmed = await customConfirm(
            `${pair} already has an active analysis!\n\nDo you want to EDIT the existing analysis instead of creating a new one?`,
            'Duplicate Analysis'
        );
        
        if (confirmed) {
            // Edit existing
            const index = analyses.indexOf(existingAnalysis);
            editAnalysis(index);
            return;
        } else {
            // Cancel selection
            return;
        }
    }
    
    // No active analysis - continue
    wizardData.pair = pair;
    document.getElementById('selectedPairDisplay').textContent = pair;
    wizardNextStep();
}

function selectCustomPair() {
    const customPair = document.getElementById('customPairInput').value.trim();
    if (!customPair) {
        customAlert('Please enter a pair name', 'Notice', '‚ÑπÔ∏è');
        return;
    }
    
    selectPair(customPair);
}

// Navigate wizard steps
function wizardNextStep() {
    // Validate current step
    if (currentWizardStep === 1) {
        if (!wizardData.pair) {
            customAlert('Please select a pair first', 'Notice', '‚ÑπÔ∏è');
            return;
        }
    } else if (currentWizardStep === 2) {
        // Collect date data
        wizardData.month = document.getElementById('wizardMonth').value;
        wizardData.day = document.getElementById('wizardDay').value;
        wizardData.date = document.getElementById('wizardDate').value;
        wizardData.year = document.getElementById('wizardYear').value;
        
        if (!wizardData.date) {
            customAlert('Please select an exact date', 'Notice', '‚ÑπÔ∏è');
            return;
        }
        
        // Update summary for step 3
        document.getElementById('pairDateSummary').textContent = 
            `${wizardData.pair} ‚Ä¢ ${wizardData.day}, ${wizardData.month} ${wizardData.year}`;
    } else if (currentWizardStep === 3) {
        // Collect analysis data
        wizardData.weeklyAnalysis = document.getElementById('wizardWeeklyAnalysis').value;
        wizardData.weeklyPhoto = document.getElementById('wizardWeeklyPhoto').value;
        wizardData.dailyAnalysis = document.getElementById('wizardDailyAnalysis').value;
        wizardData.dailyPhoto = document.getElementById('wizardDailyPhoto').value;
        wizardData.fourHAnalysis = document.getElementById('wizardFourHAnalysis').value;
        wizardData.fourHPhoto = document.getElementById('wizardFourHPhoto').value;
        wizardData.oneHAnalysis = document.getElementById('wizardOneHAnalysis').value;
        wizardData.oneHPhoto = document.getElementById('wizardOneHPhoto').value;
        
        // Update confirmation
        document.getElementById('confirmPair').textContent = wizardData.pair;
        document.getElementById('confirmDate').textContent = `${wizardData.day}, ${wizardData.month} ${wizardData.year} (${wizardData.date})`;
        
        // Count timeframes
        let timeframes = [];
        if (wizardData.weeklyAnalysis) timeframes.push('Weekly');
        if (wizardData.dailyAnalysis) timeframes.push('Daily');
        if (wizardData.fourHAnalysis) timeframes.push('4H');
        if (wizardData.oneHAnalysis) timeframes.push('1H');
        
        document.getElementById('confirmTimeframes').textContent = 
            timeframes.length > 0 ? timeframes.join(', ') : 'None';
    }
    
    // Move to next step
    currentWizardStep++;
    if (currentWizardStep > 4) currentWizardStep = 4;
    
    updateWizardStep();
}

function wizardPrevStep() {
    currentWizardStep--;
    if (currentWizardStep < 1) currentWizardStep = 1;
    
    updateWizardStep();
}

function updateWizardStep() {
    // Hide all steps
    document.querySelectorAll('.wizard-step-content').forEach(step => {
        step.style.display = 'none';
    });
    
    // Show current step
    document.getElementById(`wizardStep${currentWizardStep}`).style.display = 'block';
    
    // Update indicators
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`stepIndicator${i}`);
        if (i <= currentWizardStep) {
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
    }
    
    // Update progress bar
    const progress = ((currentWizardStep - 1) / 3) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

// Step 4: Validation selections
function selectTradeStatus(status) {
    wizardData.tradeStatus = status;
    
    // Update button styles
    document.getElementById('btnAnalysisOnly').classList.remove('selected');
    document.getElementById('btnTradeTaken').classList.remove('selected');
    
    if (status === 'Analysis Only') {
        document.getElementById('btnAnalysisOnly').classList.add('selected');
        document.getElementById('btnAnalysisOnly').style.borderColor = '#2196F3';
        document.getElementById('btnAnalysisOnly').style.background = 'linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(33, 150, 243, 0.2))';
    } else {
        document.getElementById('btnTradeTaken').classList.add('selected');
        document.getElementById('btnTradeTaken').style.borderColor = '#FFD700';
        document.getElementById('btnTradeTaken').style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.2))';
    }
    
    checkValidationComplete();
}

function selectBias(bias) {
    wizardData.marketBias = bias;
    
    // Update button styles
    document.getElementById('btnBullish').classList.remove('selected');
    document.getElementById('btnNeutral').classList.remove('selected');
    document.getElementById('btnBearish').classList.remove('selected');
    
    const btn = document.getElementById('btn' + bias);
    btn.classList.add('selected');
    
    if (bias === 'Bullish') {
        btn.style.borderColor = '#00E676';
        btn.style.background = 'linear-gradient(135deg, rgba(0, 230, 118, 0.3), rgba(0, 230, 118, 0.2))';
    } else if (bias === 'Bearish') {
        btn.style.borderColor = '#FF5252';
        btn.style.background = 'linear-gradient(135deg, rgba(255, 82, 82, 0.3), rgba(255, 82, 82, 0.2))';
    } else {
        btn.style.borderColor = '#90CAF9';
        btn.style.background = 'linear-gradient(135deg, rgba(144, 202, 249, 0.3), rgba(144, 202, 249, 0.2))';
    }
    
    checkValidationComplete();
}

function checkValidationComplete() {
    const saveBtn = document.getElementById('wizardSaveBtn');
    
    if (wizardData.tradeStatus && wizardData.marketBias) {
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
        saveBtn.style.cursor = 'pointer';
    } else {
        saveBtn.disabled = true;
        saveBtn.style.opacity = '0.5';
        saveBtn.style.cursor = 'not-allowed';
    }
}

// Save wizard data
function wizardSave() {
    if (!wizardData.tradeStatus || !wizardData.marketBias) {
        customAlert('Please select Trade Status and Market Bias', 'Notice', '‚ÑπÔ∏è');
        return;
    }
    
    showLoading();
    
    // Determine if this is add or update
    const action = editingIndex >= 0 ? 'update' : 'add';
    const actionText = editingIndex >= 0 ? 'updated' : 'saved';
    
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: action,
            ...wizardData
        })
    })
    .then(r => r.json())
    .then(() => {
        hideLoading();
        customAlert(
            `${wizardData.pair} analysis ${actionText} successfully!\n\nTrade Status: ${wizardData.tradeStatus}\nMarket Bias: ${wizardData.marketBias}`,
            'Success',
            '‚úÖ'
        );
        editingIndex = -1; // Reset edit mode
        resetWizard();
        showPage('list');
        loadAnalyses();
    })
    .catch(err => {
        console.error('Save error:', err);
        hideLoading();
        customAlert(' Error saving analysis. Please try again.', 'Notice', '‚ÑπÔ∏è');
    });
}

// Reset wizard
function resetWizard() {
    currentWizardStep = 1;
    
    wizardData = {
        pair: '',
        month: '',
        day: '',
        date: '',
        year: '',
        tradeStatus: '',
        marketBias: '',
        analysisStatus: 'Active',
        weeklyAnalysis: '',
        weeklyPhoto: '',
        dailyAnalysis: '',
        dailyPhoto: '',
        fourHAnalysis: '',
        fourHPhoto: '',
        oneHAnalysis: '',
        oneHPhoto: ''
    };
    
    // Clear inputs
    document.getElementById('customPairInput').value = '';
    document.getElementById('wizardMonth').value = 'February';
    document.getElementById('wizardDay').value = 'Wednesday';
    document.getElementById('wizardDate').value = '';
    document.getElementById('wizardYear').value = '2026';
    
    document.getElementById('wizardWeeklyAnalysis').value = '';
    document.getElementById('wizardWeeklyPhoto').value = '';
    document.getElementById('wizardDailyAnalysis').value = '';
    document.getElementById('wizardDailyPhoto').value = '';
    document.getElementById('wizardFourHAnalysis').value = '';
    document.getElementById('wizardFourHPhoto').value = '';
    document.getElementById('wizardOneHAnalysis').value = '';
    document.getElementById('wizardOneHPhoto').value = '';
    
    // Reset validation buttons
    document.querySelectorAll('.validation-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    updateWizardStep();
}

// Override showPage to reset wizard when opening form
const originalShowPageWizard = showPage;
showPage = function(page) {
    if (page === 'form') {
        resetWizard();
    }
    
    if (typeof originalShowPageWizard === 'function') {
        originalShowPageWizard(page);
    } else {
        // Fallback
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        if (page === 'form') {
            document.getElementById('formPage').classList.add('active');
            document.getElementById('btnForm').classList.add('active');
        } else if (page === 'list') {
            document.getElementById('listPage').classList.add('active');
            document.getElementById('btnList').classList.add('active');
        } else if (page === 'dashboard') {
            document.getElementById('dashboardPage').classList.add('active');
            document.getElementById('btnDashboard').classList.add('active');
            if (typeof showDashboard === 'function') showDashboard();
        }
    }
};


// Track if current edit is UPDATE (new version) or EDIT (fix typos)
let isUpdateMode = false;

// Edit Page Functions - EDIT MODE (keeps original date)
function openEditPageForEdit(i) {
    isUpdateMode = false;
    editingIndex = i;
    const a = analyses[i];
    
    if (!a) {
        customAlert('Analysis not found', 'Notice', '‚ÑπÔ∏è');
        return;
    }
    
    // Keep ORIGINAL date for editing typos
    const originalDate = a.date ? new Date(a.date) : new Date();
    const dateStr = originalDate.toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    // Display pair and ORIGINAL date
    document.getElementById('editPairDisplay').textContent = a.pair;
    document.getElementById('editDateDisplay').textContent = `${a.day}, ${a.month} ${a.year} (${dateStr})`;
    document.getElementById('editPageTitle').textContent = '‚úèÔ∏è Edit Analysis (Fix Typos)';
    document.getElementById('editSaveBtn').textContent = 'üíæ Save Changes';
    
    // Store ORIGINAL date in hidden fields
    document.getElementById('editMonth').value = a.month || monthNames[originalDate.getMonth()];
    document.getElementById('editDay').value = a.day || dayNames[originalDate.getDay()];
    document.getElementById('editYear').value = a.year || originalDate.getFullYear();
    document.getElementById('editPair').value = a.pair;
    
    // Format date in LOCAL timezone (not UTC) to avoid timezone shift
    let dateValue = a.date;
    if (dateValue) {
        if (typeof dateValue === 'object' || typeof dateValue === 'number') {
            const d = new Date(dateValue);
            dateValue = formatDateLocal(d);
        } else if (typeof dateValue === 'string' && dateValue.includes('T')) {
            const d = new Date(dateValue);
            dateValue = formatDateLocal(d);
        }
    } else {
        dateValue = formatDateLocal(originalDate);
    }
    document.getElementById('editDate').value = dateValue;
    
    // Populate status fields
    document.getElementById('editTradeStatus').value = a.tradeStatus || 'Analysis Only';
    document.getElementById('editMarketBias').value = a.marketBias || 'Bullish';
    document.getElementById('editAnalysisStatus').value = a.analysisStatus || 'Active';
    
    // Populate analysis fields
    document.getElementById('editWeeklyAnalysis').value = a.weeklyAnalysis || '';
    document.getElementById('editWeeklyPhoto').value = a.weeklyPhoto || '';
    document.getElementById('editDailyAnalysis').value = a.dailyAnalysis || '';
    document.getElementById('editDailyPhoto').value = a.dailyPhoto || '';
    document.getElementById('editFourHAnalysis').value = a.fourHAnalysis || '';
    document.getElementById('editFourHPhoto').value = a.fourHPhoto || '';
    document.getElementById('editOneHAnalysis').value = a.oneHAnalysis || '';
    document.getElementById('editOneHPhoto').value = a.oneHPhoto || '';
    
    // Show edit page
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('editPage').style.display = 'block';
    document.getElementById('editPage').classList.add('active');
}

function cancelEdit() {
    editingIndex = -1;
    document.getElementById('editPage').style.display = 'none';
    document.getElementById('editPage').classList.remove('active');
    showPage('list');
}

function saveEdit() {
    if (editingIndex < 0) {
        customAlert('No analysis selected for editing', 'Notice', '‚ÑπÔ∏è');
        return;
    }
    
    const editData = {
        month: document.getElementById('editMonth').value,
        day: document.getElementById('editDay').value,
        date: document.getElementById('editDate').value,
        year: document.getElementById('editYear').value,
        pair: document.getElementById('editPair').value,
        tradeStatus: document.getElementById('editTradeStatus').value,
        marketBias: document.getElementById('editMarketBias').value,
        analysisStatus: document.getElementById('editAnalysisStatus').value,
        weeklyAnalysis: document.getElementById('editWeeklyAnalysis').value,
        weeklyPhoto: document.getElementById('editWeeklyPhoto').value,
        dailyAnalysis: document.getElementById('editDailyAnalysis').value,
        dailyPhoto: document.getElementById('editDailyPhoto').value,
        fourHAnalysis: document.getElementById('editFourHAnalysis').value,
        fourHPhoto: document.getElementById('editFourHPhoto').value,
        oneHAnalysis: document.getElementById('editOneHAnalysis').value,
        oneHPhoto: document.getElementById('editOneHPhoto').value
    };
    
    showLoading();
    
    // IMPORTANT: Use 'add' action to create NEW VERSION (append new row)
    // This creates a history of all updates in the spreadsheet
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: 'add',  // Changed from 'update' to 'add' for versioning
            ...editData
        })
    })
    .then(r => r.json())
    .then(response => {
        hideLoading();
        if (response.success !== false) {
            const statusMsg = editData.analysisStatus === 'Closed' ? 'üî¥ Closed' : 'üü¢ Updated';
            customAlert(`${editData.pair} ${statusMsg}!\n\nNew version saved to spreadsheet.`, 'Success', '‚úÖ');
            editingIndex = -1;
            document.getElementById('editPage').style.display = 'none';
            showPage('list');
            loadAnalyses();
        } else {
            customAlert(`Update failed: ${response.message || 'Unknown error'}`, 'Error', '‚ùå');
        }
    })
    .catch(err => {
        console.error('Update error:', err);
        hideLoading();
        customAlert(' Error saving update. Please try again.', 'Notice', '‚ÑπÔ∏è');
    });
}


// Render Active Analyses Dashboard
function renderActiveDashboard() {
    const grid = document.getElementById('activeDashboardGrid');
    const empty = document.getElementById('activeDashboardEmpty');
    
    // ALL predefined pairs (29 total)
    const allPairs = [
        'EUR/USD', 'GBP/USD', 'USD/JPY', 'USD/CHF', 'AUD/USD', 'USD/CAD', 'NZD/USD',
        'GBP/JPY', 'EUR/JPY', 'AUD/JPY', 'CHF/JPY', 'CAD/JPY', 'NZD/JPY',
        'EUR/AUD', 'EUR/CHF', 'EUR/CAD', 'EUR/NZD', 'EUR/GBP',
        'GBP/AUD', 'GBP/CHF', 'GBP/CAD', 'GBP/NZD',
        'AUD/CHF', 'AUD/CAD', 'AUD/NZD', 'CAD/CHF', 'NZD/CHF',
        'XAU/USD', 'XAG/USD'
    ];
    
    // Map each pair to its latest analysis (or null if no analysis)
    const pairData = allPairs.map(pair => {
        const pairAnalyses = analyses.filter(a => a.pair === pair);
        return {
            pair: pair,
            analysis: pairAnalyses.length > 0 ? pairAnalyses[0] : null
        };
    });
    
    console.log('Dashboard: Showing', pairData.length, 'pairs');
    
    grid.style.display = 'grid';
    empty.style.display = 'none';
    
    grid.innerHTML = pairData.map(({pair, analysis}) => {
        // If no analysis, show placeholder
        if (!analysis) {
            return `
                <div style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.05), rgba(33, 150, 243, 0.02)); border: 2px dashed rgba(33, 150, 243, 0.2); border-radius: 12px; padding: 15px; transition: all 0.3s ease; opacity: 0.6;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="color: #64B5F6; margin: 0; font-size: 1.2em; font-weight: 700;">${pair}</h4>
                        <span style="background: rgba(144, 202, 249, 0.2); color: #90CAF9; padding: 3px 10px; border-radius: 10px; font-size: 0.7em; font-weight: 700;">NO DATA</span>
                    </div>
                    <div style="color: #64B5F6; font-size: 0.85em; opacity: 0.7;">
                        No analysis yet
                    </div>
                </div>
            `;
        }
        
        // Has analysis - show data
        const biasColor = analysis.marketBias === 'Bullish' ? '#00E676' : 
                         analysis.marketBias === 'Bearish' ? '#FF5252' : '#90CAF9';
        const biasIcon = analysis.marketBias === 'Bullish' ? 'üü¢' : 
                        analysis.marketBias === 'Bearish' ? 'üî¥' : '‚ö™';
        
        let dateStr = '';
        if (analysis.date) {
            try {
                dateStr = new Date(analysis.date).toLocaleDateString('ro-RO', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
            } catch(e) {
                dateStr = analysis.day + ', ' + analysis.month + ' ' + analysis.year;
            }
        } else {
            dateStr = analysis.day + ', ' + analysis.month + ' ' + analysis.year;
        }
        
        // Check if analysis needs update (2+ days old)
        const now = new Date();
        const analysisDate = new Date(analysis.date);
        const daysSinceUpdate = Math.floor((now - analysisDate) / (1000 * 60 * 60 * 24));
        
        // Status badge with stale detection
        let status = analysis.analysisStatus || 'Active';
        let statusColor, statusTextColor, statusText;
        
        if (status === 'Closed') {
            statusColor = 'linear-gradient(135deg, #FF5252, #E53935)';
            statusTextColor = '#fff';
            statusText = 'CLOSED';
        } else if (daysSinceUpdate >= 2) {
            // Stale analysis - needs update!
            statusColor = 'linear-gradient(135deg, #FFB300, #FF8F00)';
            statusTextColor = '#000';
            statusText = '‚ö†Ô∏è NOT UPDATED';
        } else {
            // Active and fresh
            statusColor = 'linear-gradient(135deg, #00E676, #00C853)';
            statusTextColor = '#000';
            statusText = 'ACTIVE';
        }
        
        return `
            <div style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05)); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 12px; padding: 15px; transition: all 0.3s ease; cursor: pointer;"
                 onclick="showPairHistory('${pair}')"
                 onmouseover="this.style.borderColor='#2196F3'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.borderColor='rgba(33, 150, 243, 0.3)'; this.style.transform='translateY(0)'">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <h4 style="color: #2196F3; margin: 0; font-size: 1.2em; font-weight: 700;">${pair}</h4>
                    <span style="background: ${statusColor}; color: ${statusTextColor}; padding: 3px 10px; border-radius: 10px; font-size: 0.7em; font-weight: 700;">${statusText}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 1.2em;">${biasIcon}</span>
                    <span style="color: ${biasColor}; font-weight: 600; font-size: 0.95em;">${analysis.marketBias}</span>
                </div>
                <div style="color: #90CAF9; font-size: 0.85em;">
                    <span style="opacity: 0.7;">Last update:</span> ${dateStr}
                </div>
            </div>
        `;
    }).join('');
}


// ============================================
// UPDATE MODE FUNCTION (Today's date, new version)
// ============================================

function openEditPageForUpdate(i) {
    isUpdateMode = true;
    editingIndex = i;
    const a = analyses[i];
    
    if (!a) {
        customAlert('Analysis not found', 'Notice', '‚ÑπÔ∏è');
        return;
    }
    
    // Get TODAY's date for the update (in LOCAL timezone)
    const today = new Date();
    const todayStr = formatDateLocal(today); // Use local date formatter
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    const todayMonth = monthNames[today.getMonth()];
    const todayDayName = dayNames[today.getDay()];
    const todayYear = today.getFullYear();
    
    // Display pair and TODAY's date
    document.getElementById('editPairDisplay').textContent = a.pair;
    document.getElementById('editDateDisplay').textContent = `${todayDayName}, ${todayMonth} ${todayYear} (${today.toLocaleDateString('ro-RO')})`;
    document.getElementById('editPageTitle').textContent = 'üîÑ Update Analysis (New Version)';
    document.getElementById('editSaveBtn').textContent = 'üîÑ Save Update';
    
    // Store TODAY's date in hidden fields
    document.getElementById('editMonth').value = todayMonth;
    document.getElementById('editDay').value = todayDayName;
    document.getElementById('editYear').value = todayYear;
    document.getElementById('editPair').value = a.pair;
    document.getElementById('editDate').value = todayStr;
    
    // Populate status fields (keep same status and bias)
    document.getElementById('editTradeStatus').value = a.tradeStatus || 'Analysis Only';
    document.getElementById('editMarketBias').value = a.marketBias || 'Bullish';
    document.getElementById('editAnalysisStatus').value = a.analysisStatus || 'Active';
    
    // CLEAR analysis fields for UPDATE (new notes, not copy old ones)
    document.getElementById('editWeeklyAnalysis').value = '';
    document.getElementById('editWeeklyPhoto').value = '';
    document.getElementById('editDailyAnalysis').value = '';
    document.getElementById('editDailyPhoto').value = '';
    document.getElementById('editFourHAnalysis').value = '';
    document.getElementById('editFourHPhoto').value = '';
    document.getElementById('editOneHAnalysis').value = '';
    document.getElementById('editOneHPhoto').value = '';
    
    // Show edit page
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('editPage').style.display = 'block';
    document.getElementById('editPage').classList.add('active');
}

function saveEditOrUpdate() {
    if (editingIndex < 0) {
        customAlert('No analysis selected', 'Notice', '‚ÑπÔ∏è');
        return;
    }
    
    const editData = {
        month: document.getElementById('editMonth').value,
        day: document.getElementById('editDay').value,
        date: document.getElementById('editDate').value,
        year: document.getElementById('editYear').value,
        pair: document.getElementById('editPair').value,
        tradeStatus: document.getElementById('editTradeStatus').value,
        marketBias: document.getElementById('editMarketBias').value,
        analysisStatus: document.getElementById('editAnalysisStatus').value,
        weeklyAnalysis: document.getElementById('editWeeklyAnalysis').value,
        weeklyPhoto: document.getElementById('editWeeklyPhoto').value,
        dailyAnalysis: document.getElementById('editDailyAnalysis').value,
        dailyPhoto: document.getElementById('editDailyPhoto').value,
        fourHAnalysis: document.getElementById('editFourHAnalysis').value,
        fourHPhoto: document.getElementById('editFourHPhoto').value,
        oneHAnalysis: document.getElementById('editOneHAnalysis').value,
        oneHPhoto: document.getElementById('editOneHPhoto').value
    };
    
    showLoading();
    
    // EDIT mode = update existing row
    // UPDATE mode = add new row (versioning)
    const action = isUpdateMode ? 'add' : 'update';
    const actionText = isUpdateMode ? 'updated with new version' : 'edited';
    
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: action,
            ...editData
        })
    })
    .then(r => r.json())
    .then(response => {
        hideLoading();
        if (response.success !== false) {
            customAlert(`${editData.pair} ${actionText} successfully!`, 'Success', '‚úÖ');
            editingIndex = -1;
            isUpdateMode = false;
            document.getElementById('editPage').style.display = 'none';
            showPage('list');
            loadAnalyses();
        } else {
            customAlert(`Save failed: ${response.message || 'Unknown error'}`, 'Error', '‚ùå');
        }
    })
    .catch(err => {
        console.error('Save error:', err);
        hideLoading();
        customAlert(' Error saving. Please try again.', 'Notice', '‚ÑπÔ∏è');
    });
}

function updateAnalysis(i) {
    openEditPageForUpdate(i);
}

function updateAnalysisFromModal() {
    if (currentViewIndex >= 0 && currentViewIndex < analyses.length) {
        closeViewModal();
        updateAnalysis(currentViewIndex); // Use new function that shows choice modal
    }
}

function updateAnalysisFromDayModal(index) {
    closeDayModal();
    updateAnalysis(index); // Use new function that shows choice modal
}


// Table-specific wrappers (work with allAnalyses)
function editTableAnalysis(i) {
    const tableData = window.allAnalyses || analyses;
    const a = tableData[i];
    // Find in analyses array
    const mainIndex = analyses.findIndex(an => an.pair === a.pair && an.date === a.date);
    if (mainIndex >= 0) {
        editAnalysis(mainIndex);
    } else {
        customAlert('Analysis not found in main array', 'Notice', '‚ÑπÔ∏è');
    }
}

function updateTableAnalysis(i) {
    const tableData = window.allAnalyses || analyses;
    const a = tableData[i];
    const mainIndex = analyses.findIndex(an => an.pair === a.pair && an.date === a.date);
    if (mainIndex >= 0) {
        updateAnalysis(mainIndex);
    } else {
        customAlert('Analysis not found in main array', 'Notice', '‚ÑπÔ∏è');
    }
}

function deleteTableAnalysis(i) {
    const tableData = window.allAnalyses || analyses;
    const a = tableData[i];
    const mainIndex = analyses.findIndex(an => an.pair === a.pair && an.date === a.date);
    if (mainIndex >= 0) {
        deleteAnalysis(mainIndex);
    } else {
        customAlert('Analysis not found in main array', 'Notice', '‚ÑπÔ∏è');
    }
}

function viewTableAnalysis(i) {
    const tableData = window.allAnalyses || analyses;
    const a = tableData[i];
    const mainIndex = analyses.findIndex(an => an.pair === a.pair && an.date === a.date);
    if (mainIndex >= 0) {
        shareToTradingView(mainIndex, event);
    }
}

function shareToDiscordTable(i, event) {
    const tableData = window.allAnalyses || analyses;
    const a = tableData[i];
    const mainIndex = analyses.findIndex(an => an.pair === a.pair && an.date === a.date);
    if (mainIndex >= 0) {
        shareToDiscord(mainIndex, event);
    }
}

function sendToDiscordTable(i) {
    const tableData = window.allAnalyses || analyses;
    const a = tableData[i];
    const mainIndex = analyses.findIndex(an => an.pair === a.pair && an.date === a.date);
    if (mainIndex >= 0) {
        sendToDiscordChannel(mainIndex);
    }
}


// Show history modal for a specific pair
function showPairHistory(pair) {
    const titleEl = document.getElementById('historyModalTitle');
    const contentEl = document.getElementById('historyModalContent');
    const modalEl = document.getElementById('historyModal');
    
    if (!titleEl || !contentEl || !modalEl) {
        console.error('History modal elements not found in DOM');
        customAlert('Error: History modal not loaded. Please refresh the page.', 'Notice', '‚ÑπÔ∏è');
        return;
    }
    
    const allData = window.allAnalyses || analyses;
    
    // Sort by createdAt (when you wrote it) for TRUE chronological order
    const pairHistory = allData.filter(a => a.pair === pair).sort((a, b) => {
        // Primary sort: createdAt timestamp
        if (a.createdAt && b.createdAt) {
            return new Date(a.createdAt) - new Date(b.createdAt);
        }
        // Fallback: rowNumber
        if (a.rowNumber !== undefined && b.rowNumber !== undefined) {
            return a.rowNumber - b.rowNumber;
        }
        // Final fallback: date
        return new Date(a.date) - new Date(b.date);
    });
    
    titleEl.textContent = `üìä ${pair} - Analysis History (${pairHistory.length} versions)`;
    contentEl.innerHTML = '';
    
    console.log('=== CHAIN SPLITTING (by createdAt) ===');
    console.log('Sorted:', pairHistory.map(a => ({
        createdAt: a.createdAt,
        date: a.date,
        status: a.analysisStatus
    })));
    
    // Split into separate chains (each chain ends with Closed)
    // pairHistory is already sorted oldest‚Üínewest by createdAt
    const chains = [];
    let currentChain = [];
    
    pairHistory.forEach(a => {
        currentChain.push(a);
        if (a.analysisStatus === 'Closed') {
            chains.push([...currentChain]);
            currentChain = [];
        }
    });
    
    // If there's an open chain, add it
    if (currentChain.length > 0) {
        chains.push(currentChain);
    }
    
    // Reverse chains so NEWEST chain is FIRST (top)
    chains.reverse();
    
    console.log(`Total chains: ${chains.length}`);
    
    // Render each chain separately
    chains.forEach((chain, chainIndex) => {
        const firstAnalysis = chain[0];
        const lastAnalysis = chain[chain.length - 1];
        const setupBias = firstAnalysis.marketBias;
        const setupType = setupBias === 'Bullish' ? 'LONG' : setupBias === 'Bearish' ? 'SHORT' : 'NEUTRAL';
        const setupColor = setupBias === 'Bullish' ? '#00E676' : setupBias === 'Bearish' ? '#FF5252' : '#90CAF9';
        
        // Check if chain is closed
        const isClosed = lastAnalysis.analysisStatus === 'Closed';
        const isCorrect = lastAnalysis.closeReason === 'Correct';
        
        let flowColor, flowStatus;
        if (isClosed) {
            flowColor = isCorrect ? '#00E676' : '#FF5252';
            flowStatus = isCorrect ? 'CLOSED - CORRECT' : 'CLOSED - WRONG';
        } else {
            flowColor = '#00E676';
            flowStatus = 'OPEN';
        }
        
        const chainContainer = document.createElement('div');
        chainContainer.style.cssText = `
            display: flex; 
            gap: 30px; 
            align-items: stretch; 
            position: relative;
            margin-bottom: ${chainIndex < chains.length - 1 ? '60px' : '0'};
            padding-bottom: ${chainIndex < chains.length - 1 ? '40px' : '0'};
            border-bottom: ${chainIndex < chains.length - 1 ? '3px dashed rgba(255,255,255,0.2)' : 'none'};
        `;
        
        // LEFT SIDE: Vertical SETUP text (centered)
        const setupSide = document.createElement('div');
        setupSide.style.cssText = 'display: flex; align-items: center; justify-content: center; min-width: 60px;';
        setupSide.innerHTML = `
            <div style="writing-mode: vertical-rl; transform: rotate(180deg); background: ${setupColor}; color: #000; padding: 20px 10px; border-radius: 25px; font-size: 1.1em; font-weight: 700; letter-spacing: 3px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                ${setupType} SETUP
            </div>
        `;
        
        // MIDDLE: Timeline with cards
        const timelineContainer = document.createElement('div');
        timelineContainer.style.cssText = 'flex: 1; position: relative; padding-left: 80px;';
        
        chain.forEach((a, index) => {
            const dateStr = a.date ? new Date(a.date).toLocaleDateString('ro-RO', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }) : `${a.day}, ${a.month} ${a.year}`;
            const isFirst = (index === 0);
            const isLast = (index === chain.length - 1);
            
            let versionLabel, versionIcon, statusLabel;
            if (isFirst) {
                versionLabel = 'üìù Initial Analysis';
                versionIcon = 'üéØ';
                statusLabel = 'START';
            } else if (a.analysisStatus === 'Closed') {
                versionLabel = 'üîí Closed';
                versionIcon = 'üîí';
                statusLabel = 'FINISH';
            } else {
                versionLabel = `üìù Update ${index}`;
                versionIcon = 'üîÑ';
                statusLabel = 'UPDATE';
            }
            
            const statusColor = statusLabel === 'START' ? '#2196F3' : statusLabel === 'FINISH' ? '#FF5252' : '#FFB300';
            const mainIndex = analyses.findIndex(an => an.pair === a.pair && an.date === a.date && an.weeklyAnalysis === a.weeklyAnalysis);
            
            const itemWrapper = document.createElement('div');
            itemWrapper.style.cssText = 'position: relative; margin-bottom: 20px;';
            
            const node = document.createElement('div');
            node.style.cssText = `position: absolute; left: -80px; top: 20px; width: 50px; height: 50px; background: ${flowColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 3;`;
            node.textContent = versionIcon;
            
            if (!isLast) {
                const line = document.createElement('div');
                line.style.cssText = `position: absolute; left: -57px; top: 70px; width: 4px; height: 60px; background: ${flowColor}; z-index: 1;`;
                itemWrapper.appendChild(line);
                
                const arrow = document.createElement('div');
                arrow.style.cssText = `position: absolute; left: -65px; top: 125px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid ${flowColor}; z-index: 2;`;
                itemWrapper.appendChild(arrow);
            }
            
            const card = document.createElement('div');
            card.style.cssText = `background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05)); border: 2px solid ${flowColor}; border-radius: 15px; padding: 20px; transition: all 0.3s ease; cursor: pointer;`;
            card.onmouseover = () => {
                card.style.borderColor = '#2196F3';
                card.style.background = 'linear-gradient(135deg, rgba(33, 150, 243, 0.15), rgba(33, 150, 243, 0.1))';
                card.style.transform = 'translateX(5px)';
            };
            card.onmouseout = () => {
                card.style.borderColor = flowColor;
                card.style.background = 'linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05))';
                card.style.transform = 'translateX(0)';
            };
            
            card.innerHTML = `
                <div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
                        <span style="color: ${flowColor}; font-size: 1.3em; font-weight: 700;">${versionLabel}</span>
                        <span style="background: ${statusColor}; color: #000; padding: 3px 10px; border-radius: 8px; font-size: 0.75em; font-weight: 700;">${statusLabel}</span>
                        ${a.analysisStatus === 'Closed' && a.closeReason ? `<span style="background: ${a.closeReason === 'Correct' ? '#00E676' : '#FF5252'}; color: #000; padding: 3px 10px; border-radius: 8px; font-size: 0.75em; font-weight: 700;">${a.closeReason === 'Correct' ? '‚úÖ Correct' : '‚ùå Incorrect'}</span>` : ''}
                    </div>
                    <p style="color: #90CAF9; margin: 0 0 15px 0; font-size: 0.9em;">${dateStr}</p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="event.stopPropagation(); closeHistoryModal(); viewAnalysisByData(a)" style="background: linear-gradient(135deg, #4d9fff, #3d7fff); color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; white-space: nowrap;">üëÅÔ∏è View</button>
                        <button onclick="event.stopPropagation(); closeHistoryModal(); editAnalysis(${mainIndex >= 0 ? mainIndex : 0})" style="background: linear-gradient(135deg, #FF9500, #FF7B00); color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; white-space: nowrap;">‚úèÔ∏è Edit</button>
                        <button onclick="event.stopPropagation(); closeHistoryModal(); updateAnalysis(${mainIndex >= 0 ? mainIndex : 0})" style="background: linear-gradient(135deg, #00E676, #00C853); color: #000; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 700; white-space: nowrap;">üîÑ Update</button>
                        <button onclick="event.stopPropagation(); closeHistoryModal(); deleteAnalysisByDeleteId('${a.deleteId}', '${a.pair}')" style="background: linear-gradient(135deg, #FF5252, #E53935); color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; white-space: nowrap;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            
            card.onclick = () => {
                if (mainIndex >= 0) {
                    closeHistoryModal();
                    viewAnalysis(mainIndex);
                }
            };
            
            itemWrapper.appendChild(node);
            itemWrapper.appendChild(card);
            timelineContainer.appendChild(itemWrapper);
        });
        
        // RIGHT SIDE: Vertical ANALYSIS STATUS (centered)
        const statusSide = document.createElement('div');
        statusSide.style.cssText = 'display: flex; align-items: center; justify-content: center; min-width: 80px;';
        statusSide.innerHTML = `
            <div style="writing-mode: vertical-rl; transform: rotate(180deg); background: ${flowColor}; color: #000; padding: 20px 10px; border-radius: 25px; font-size: 0.95em; font-weight: 700; letter-spacing: 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center;">
                ANALYSIS ${flowStatus}
            </div>
        `;
        
        chainContainer.appendChild(setupSide);
        chainContainer.appendChild(timelineContainer);
        chainContainer.appendChild(statusSide);
        contentEl.appendChild(chainContainer);
    });
    
    modalEl.style.display = 'flex';
}



function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
}


// Custom Alert (replaces alert())
function customAlert(message, title = 'Notice', icon = '‚úÖ') {
    const modal = document.getElementById('customAlertModal');
    const iconEl = document.getElementById('customAlertIcon');
    const titleEl = document.getElementById('customAlertTitle');
    const messageEl = document.getElementById('customAlertMessage');
    
    if (!modal) return alert(message); // Fallback
    
    iconEl.textContent = icon;
    titleEl.textContent = title;
    messageEl.textContent = message;
    modal.style.display = 'flex';
}

function closeCustomAlert() {
    document.getElementById('customAlertModal').style.display = 'none';
}

// Custom Confirm (replaces confirm())
let confirmCallback = null;

function customConfirm(message, title = 'Confirm Action') {
    return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const titleEl = document.getElementById('customConfirmTitle');
        const messageEl = document.getElementById('customConfirmMessage');
        
        if (!modal) {
            resolve(confirm(message)); // Fallback
            return;
        }
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        modal.style.display = 'flex';
        confirmCallback = resolve;
    });
}

function closeCustomConfirm(result) {
    document.getElementById('customConfirmModal').style.display = 'none';
    if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
    }
}


// Global variable to track which analysis is being closed
let pendingCloseAnalysisIndex = -1;

// Show/hide observations field based on reason
document.addEventListener('DOMContentLoaded', function() {
    const reasonSelect = document.getElementById('closeReasonSelect');
    const observationsContainer = document.getElementById('observationsContainer');
    
    if (reasonSelect && observationsContainer) {
        reasonSelect.addEventListener('change', function() {
            if (this.value === 'Incorrect') {
                observationsContainer.style.display = 'block';
            } else {
                observationsContainer.style.display = 'none';
                document.getElementById('closeObservations').value = '';
            }
        });
    }
});

// Modified updateAnalysis to show choice modal
let originalUpdateAnalysisIndex = -1;

function updateAnalysis(i) {
    originalUpdateAnalysisIndex = i;
    pendingCloseAnalysisIndex = i;
    
    const a = analyses[i];
    document.getElementById('closeAnalysisPairName').textContent = a.pair;
    
    document.getElementById('updateChoiceModal').style.display = 'flex';
    
    // Setup button handlers
    document.getElementById('continueUpdateBtn').onclick = () => {
        closeUpdateChoiceModal();
        openEditPageForUpdate(originalUpdateAnalysisIndex);
    };
    
    document.getElementById('closeAnalysisBtn').onclick = () => {
        closeUpdateChoiceModal();
        showCloseAnalysisModal();
    };
}

function closeUpdateChoiceModal() {
    document.getElementById('updateChoiceModal').style.display = 'none';
}

function showCloseAnalysisModal() {
    const modal = document.getElementById('closeAnalysisModal');
    const reasonSelect = document.getElementById('closeReasonSelect');
    const observationsContainer = document.getElementById('observationsContainer');
    const observationsField = document.getElementById('closeObservations');
    
    // Reset form
    reasonSelect.value = 'Correct';
    observationsContainer.style.display = 'none';
    observationsField.value = '';
    
    modal.style.display = 'flex';
    
    // Setup save button
    document.getElementById('saveCloseAnalysisBtn').onclick = saveCloseAnalysis;
}

function closeCloseAnalysisModal() {
    document.getElementById('closeAnalysisModal').style.display = 'none';
}

async function saveCloseAnalysis() {
    if (pendingCloseAnalysisIndex < 0) return;
    
    const a = analyses[pendingCloseAnalysisIndex];
    const reason = document.getElementById('closeReasonSelect').value;
    const observations = document.getElementById('closeObservations').value;
    
    // Validate: if Incorrect, observations required
    if (reason === 'Incorrect' && !observations.trim()) {
        customAlert('Please provide observations for incorrect analysis', 'Missing Information', '‚ö†Ô∏è');
        return;
    }
    
    // Create NEW row with Closed status (keep all previous data)
    const closeData = {
        action: 'close',
        month: a.month,
        day: a.day,
        date: a.date,
        year: a.year,
        pair: a.pair,
        tradeStatus: a.tradeStatus,
        marketBias: a.marketBias,
        weeklyAnalysis: a.weeklyAnalysis || '',
        weeklyPhoto: a.weeklyPhoto || '',
        dailyAnalysis: a.dailyAnalysis || '',
        dailyPhoto: a.dailyPhoto || '',
        fourHAnalysis: a.fourHAnalysis || '',
        fourHPhoto: a.fourHPhoto || '',
        oneHAnalysis: a.oneHAnalysis || '',
        oneHPhoto: a.oneHPhoto || '',
        closeReason: reason,
        closeObservations: observations || ''
    };
    
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(closeData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeCloseAnalysisModal();
            customAlert(`${a.pair} analysis closed as ${reason}`, 'Analysis Closed', 'üîí');
            loadAnalyses();
        } else {
            customAlert('Failed to close analysis. Please try again.', 'Error', '‚ùå');
        }
    } catch (err) {
        console.error('Close error:', err);
        customAlert('Error closing analysis. Please try again.', 'Error', '‚ùå');
    }
}


// Global calendar filter
let calendarFilterPair = 'ALL';

function filterCalendarByPair() {
    const select = document.getElementById('calendarPairFilter');
    calendarFilterPair = select.value;
    renderCalendar(); // Re-render calendar with filter
}

async function deleteAnalysisByDeleteId(deleteId, pair) {
    const confirmed = await customConfirm(`Delete this ${pair} analysis?`, 'Confirm Delete');
    if (!confirmed) return;
    
    if (!deleteId) {
        customAlert('Cannot delete: missing deleteId', 'Error', '‚ùå');
        return;
    }
    
    console.log('Deleting by deleteId:', deleteId);
    
    showLoading();
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: 'delete',
            deleteId: deleteId
        })
    })
        .then(r => r.json())
        .then(response => {
            hideLoading();
            console.log('Delete response:', response);
            
            if (response.success) {
                customAlert('Analysis deleted successfully!', 'Deleted', '‚úÖ');
                loadAnalyses();
            } else {
                customAlert(`Delete failed: ${response.message}\n\nPlease refresh and try again.`, 'Error', '‚ùå');
            }
        })
        .catch(err => {
            console.error('Delete error:', err);
            hideLoading();
            customAlert('Delete error. Please try again.', 'Notice', '‚ÑπÔ∏è');
        });
}

function viewAnalysisByData(analysisData) {
    closeHistoryModal();
    // Show in a modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: #1a1a2e; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;">
            <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: #FF5252; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">‚úï Close</button>
            <h2 style="color: #2196F3; margin-bottom: 20px;">${analysisData.pair} Analysis</h2>
            <p style="color: #90CAF9;"><strong>Date:</strong> ${new Date(analysisData.date).toLocaleDateString('ro-RO')}</p>
            <p style="color: #90CAF9;"><strong>Status:</strong> ${analysisData.analysisStatus}</p>
            <p style="color: #90CAF9;"><strong>Trade:</strong> ${analysisData.tradeStatus}</p>
            <p style="color: #90CAF9;"><strong>Bias:</strong> ${analysisData.marketBias}</p>
            ${analysisData.weeklyAnalysis ? `<div style="margin-top: 20px;"><h3 style="color: #FF9500;">Weekly Analysis:</h3><p style="color: #fff; white-space: pre-wrap;">${analysisData.weeklyAnalysis}</p></div>` : ''}
            ${analysisData.dailyAnalysis ? `<div style="margin-top: 20px;"><h3 style="color: #FF9500;">Daily Analysis:</h3><p style="color: #fff; white-space: pre-wrap;">${analysisData.dailyAnalysis}</p></div>` : ''}
            ${analysisData.fourHAnalysis ? `<div style="margin-top: 20px;"><h3 style="color: #FF9500;">4H Analysis:</h3><p style="color: #fff; white-space: pre-wrap;">${analysisData.fourHAnalysis}</p></div>` : ''}
        </div>
    `;
    
    document.body.appendChild(modal);
}

    </script>
<!-- Update Choice Modal -->
<div id="updateChoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 20000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); animation: modalSlideIn 0.3s ease;">
        <h2 style="color: #fff; margin: 0 0 20px 0; font-size: 1.5em;">üîÑ Update Analysis</h2>
        <p style="color: #90CAF9; margin: 0 0 25px 0;">What would you like to do?</p>
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button id="continueUpdateBtn" style="width: 100%; background: linear-gradient(135deg, #00E676, #00C853); color: #000; border: none; padding: 15px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 700; transition: all 0.3s ease;">
                ‚ûï Continue with Update
            </button>
            <button id="closeAnalysisBtn" style="width: 100%; background: linear-gradient(135deg, #FF5252, #E53935); color: #fff; border: none; padding: 15px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease;">
                üîí Close Analysis
            </button>
            <button onclick="closeUpdateChoiceModal()" style="width: 100%; background: rgba(255, 255, 255, 0.1); color: #fff; border: 2px solid rgba(255, 255, 255, 0.3); padding: 12px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 600;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Close Analysis Modal -->
<div id="closeAnalysisModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 20001; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); animation: modalSlideIn 0.3s ease;">
        <h2 style="color: #fff; margin: 0 0 20px 0; font-size: 1.5em;">üîí Close Analysis</h2>
        <p id="closeAnalysisPairName" style="color: #2196F3; margin: 0 0 20px 0; font-size: 1.2em; font-weight: 700;"></p>
        
        <label style="color: #90CAF9; display: block; margin-bottom: 8px; font-weight: 600;">Was the analysis correct?</label>
        <select id="closeReasonSelect" style="width: 100%; background: rgba(255, 255, 255, 0.1); color: #fff; border: 2px solid rgba(33, 150, 243, 0.4); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 1em;">
            <option value="Correct">‚úÖ Correct - Analysis was accurate</option>
            <option value="Incorrect">‚ùå Incorrect - Analysis was wrong</option>
        </select>
        
        <div id="observationsContainer" style="display: none;">
            <label style="color: #90CAF9; display: block; margin-bottom: 8px; font-weight: 600;">Observations (What went wrong?):</label>
            <textarea id="closeObservations" placeholder="Describe what went wrong with this analysis..." style="width: 100%; background: rgba(255, 255, 255, 0.1); color: #fff; border: 2px solid rgba(33, 150, 243, 0.4); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 1em; min-height: 100px; resize: vertical;"></textarea>
        </div>
        
        <div style="display: flex; gap: 12px;">
            <button onclick="closeCloseAnalysisModal()" style="flex: 1; background: rgba(255, 255, 255, 0.1); color: #fff; border: 2px solid rgba(255, 255, 255, 0.3); padding: 12px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 600;">
                Cancel
            </button>
            <button id="saveCloseAnalysisBtn" style="flex: 1; background: linear-gradient(135deg, #FF5252, #E53935); color: #fff; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 700;">
                üîí Close Analysis
            </button>
        </div>
    </div>
</div>

<!-- Custom Alert Modal -->
<div id="customAlertModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 20000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; max-width: 400px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); animation: modalSlideIn 0.3s ease;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <div id="customAlertIcon" style="font-size: 2.5em;"></div>
            <h3 id="customAlertTitle" style="color: #fff; margin: 0; font-size: 1.3em;"></h3>
        </div>
        <p id="customAlertMessage" style="color: #90CAF9; margin: 0 0 25px 0; line-height: 1.6; font-size: 1em;"></p>
        <button id="customAlertBtn" onclick="closeCustomAlert()" style="width: 100%; background: linear-gradient(135deg, #2196F3, #1976D2); color: #fff; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease;">
            OK
        </button>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 20000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 30px; max-width: 400px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); animation: modalSlideIn 0.3s ease;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <div style="font-size: 2.5em;">‚ö†Ô∏è</div>
            <h3 id="customConfirmTitle" style="color: #fff; margin: 0; font-size: 1.3em;">Confirm Action</h3>
        </div>
        <p id="customConfirmMessage" style="color: #90CAF9; margin: 0 0 25px 0; line-height: 1.6; font-size: 1em;"></p>
        <div style="display: flex; gap: 12px;">
            <button onclick="closeCustomConfirm(false)" style="flex: 1; background: rgba(255, 255, 255, 0.1); color: #fff; border: 2px solid rgba(255, 255, 255, 0.3); padding: 12px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease;">
                Cancel
            </button>
            <button onclick="closeCustomConfirm(true)" style="flex: 1; background: linear-gradient(135deg, #FF5252, #E53935); color: #fff; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease;">
                Confirm
            </button>
        </div>
    </div>
</div>

<style>
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
</style>

    <!-- History Modal -->
    <div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; overflow-y: auto; padding: 40px 20px;">
        <div style="max-width: 1000px; margin: 0 auto; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <div style="background: linear-gradient(135deg, #2196F3, #1976D2); padding: 25px 30px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h2 id="historyModalTitle" style="color: #fff; margin: 0; font-size: 1.8em;">üìä Analysis History</h2>
                <button onclick="closeHistoryModal()" style="background: rgba(255, 255, 255, 0.2); border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5em; display: flex; align-items: center; justify-content: center;">√ó</button>
            </div>
            <div id="historyModalContent" style="padding: 30px; max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

</body>
</html>
